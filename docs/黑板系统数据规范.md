# 黑板系统 (Blackboard) 数据规范 v3.0 (马尔可夫架构版)

## 概述

黑板系统遵循**马尔可夫决策模型 (MDP)**，将数据划分为**传感器输入 (Sensors)** 和 **执行器输出 (Actuators)**。

---

## 一、传感器数据 (Sensors) - 客户端同步至服务端

AI 通过这些数据观察物理世界的情况。这些数据**不应**直接被行为树作为“指令”修改。

| 键名 | 类型 | 读写方 | 更新频率 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| **`isMovingLocally`** | Boolean | **写**: BTServer<br>**读**: RobotBT | 实时 (state_sync) | 核心传感器：反映客户端是否正在由 WASD 手动控制。用于 AI 让路决策。 |
| **`isJumpPressed`** | Boolean | **写**: BTServer<br>**读**: RobotBT | 实时 (state_sync) | 反映用户是否正在按跳跃键。 |
| **`isDragging`** | Boolean | **写**: BTServer<br>**读**: RobotBT | 按需 (drag_start) | 反映机器人当前是否处于被拖拽状态。 |
| **`penguinPosition`** | Array | **写**: BTServer<br>**读**: 行为树节点 | 每秒 1 次 | 机器人的实时 3D 坐标。用于边界检测。 |
| **`lastCollision`** | Object | **写**: BTServer<br>**读**: RobotBT | 碰撞时上报 | 包含碰撞位置、法线及时间戳。用于触发受惊动画。 |

---

## 二、执行器数据 (Actuators) - 服务端发送至客户端

这些数据代表行为树做出的**决策意图**。

| 键名 | 类型 | 读写方 | 更新频率 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| **`bt_output_action`** | String | **写**: 行为树动作节点<br>**读**: BTServer | 每 100ms | AI 产生的意图动作名。当 AI 决定让路时，此项保持为空。 |
| **`bt_output_chat_msgs`** | Array | **写**: FunctionExecNode<br>**读**: BTServer | LLM 调用后 | 待下发的模型回复或 UI 气泡。 |
| **`bt_output_position`** | Array | **写**: 寻路节点<br>**读**: BTServer | 寻路时 | AI 要求的移动目标位置。 |

---

## 三、内部状态 (State) - 服务端私有

| 键名 | 类型 | 读写方 | 更新频率 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| **`energy`** | Number | **写**: MoodAction | 每 2 秒 | AI 计算的生存状态值。 |
| **`pendingActions`** | Array | **写**: LLM 解析 | 按需 | 待执行的任务队列。 |

---

## 四、马尔可夫决策流

### 1. 数据流向图
```
[Godot Client] --(物理 facts)--> [Sensor Keys]
                                     ↓
                                [RobotBT.tick] <--(每帧评估)
                                     ↓
[Godot Perform] <--(新意图 pack)-- [Actuator Keys]
```

### 2. 让路逻辑说明
在 `RobotBT` 中，AI 显式检查传感器变量：
- **If** `isMovingLocally == true`: 转移到 `node_yield_control` 状态。结果是 `bt_output_action` 保持原样（不产生新指令）。
- **Else**: 继续流动到后续节点产生 AI 自主指令。

---

## 五、职责守则

1. **写 Sensor**：仅在 `BTServer.ts` 接收到客户端消息时更新。
2. **读 Actuator**：仅在 `sendBTOutputs` 发送时读取。
3. **隔离性**：永远不要直接在客户端修改 Actuator 变量，永远不要直接在服务端修改 Sensor 变量以试图“预测”物理。
