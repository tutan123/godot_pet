# 物理与环境同步方案：如何让 AI “感知” 3D 世界

## 1. 核心挑战
JS 服务端作为“大脑”，运行在无图形界面的环境中。它没有物理引擎，看不见墙壁、悬崖或障碍物。如果不进行状态同步，AI 下达的移动指令可能会导致机器人卡在墙角或掉出地图。

## 2. 同步策略：事件驱动 vs 状态轮询

我们采用混合同步策略：

### A. 状态轮询 (State Polling) - 定时同步
*   **同步内容**：位置 (Position)、当前动作 (Current Action)、是否在地面 (Is On Floor)。
*   **频率**：低频（如 1Hz）。
*   **用途**：
    *   更新 JS 黑板中的 `penguinPosition`。
    *   行为树可以判断机器人是否偏离目标太远。
    *   行为树可以根据当前位置决定是否触发“回家”或“巡逻”逻辑。

### B. 事件驱动 (Event-Driven) - 实时上报
*   **同步内容**：碰撞事件 (Collision)、拖拽开始/结束 (Drag Start/End)、掉落触发器 (Trigger)。
*   **触发时机**：发生时立即发送。
*   **用途**：
    *   **碰撞 (Collision)**：当机器人撞到障碍物时，GD 上报碰撞法线和碰撞体名称。JS 行为树收到后，可以立即中断当前的“行走”节点，进入“受挫/困惑”分支，甚至重新规划路径。
    *   **掉落 (Fall)**：如果机器人掉出边界，上报 `fall` 事件，AI 可以触发“尖叫”或“重生”逻辑。

---

## 3. 黑板系统 (Blackboard) 的作用
黑板是服务端行为树的“黑盒空间”，它存储了大脑能感知到的所有世界观：

```typescript
// JS 服务端黑板中的环境状态
{
  "penguinPosition": [2.5, 0, -1.2], // 坐标感知
  "isDragging": false,              // 交互感知
  "isOnFloor": true,               // 物理感知
  "lastCollision": {               // 事件感知
     "collider": "Wall_East",
     "timestamp": 1736500000
  }
}
```

## 4. 为什么物理引擎不放在服务端？
1.  **性能开销**：在 JS 中运行 3D 物理引擎（如 Cannon.js 或 Rapier）开销巨大，且难以与 Godot 的物理表现完美对齐。
2.  **网络同步延迟**：如果在服务端跑物理，客户端的移动会有明显的“橡皮筋”效应。
3.  **职责分离**：Godot 是专业的游戏引擎，处理重力、摩擦力和碰撞检测是它的强项；JS 擅长的是逻辑编排和 LLM 集成。

## 5. 结论
通过 **“客户端物理模拟 + 关键状态回传 = 服务端逻辑感知”** 的模式，我们既保证了操作的极速响应，又给了 AI 足够的“环境感知力”来做出合理的决策。

---
**当前实现状态**：
- [x] Godot 定时位置同步 (1Hz)
- [x] Godot 碰撞事件即时上报
- [x] JS 服务端黑板支持位置与碰撞数据存储
