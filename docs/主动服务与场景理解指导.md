# ä¸»åŠ¨æœåŠ¡ä¸åœºæ™¯ç†è§£æŒ‡å¯¼æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åˆ©ç”¨**æœåŠ¡ç«¯è¡Œä¸ºæ ‘**å’Œ**å¤§è¯­è¨€æ¨¡å‹ (LLM)** å®ç°**ä¸»åŠ¨æœåŠ¡**å’Œ**åœºæ™¯ç†è§£**åŠŸèƒ½ã€‚é€šè¿‡å®¢æˆ·ç«¯å®æ—¶åŒæ­¥çš„çŠ¶æ€æ•°æ®ï¼ŒæœåŠ¡ç«¯å¯ä»¥è¿›è¡Œæ›´å¤æ‚çš„æ¨ç†å’Œå†³ç­–ï¼Œæä¾›æ›´æ™ºèƒ½çš„äº¤äº’ä½“éªŒã€‚

---

## ä¸€ã€æ¶æ„ä¼˜åŠ¿ï¼šä¸ºä»€ä¹ˆæœåŠ¡ç«¯èƒ½åšæ›´å¤šï¼Ÿ

### 1.1 æœåŠ¡ç«¯ vs å®¢æˆ·ç«¯çš„èŒè´£åˆ’åˆ†

```mermaid
graph LR
    subgraph Client["å®¢æˆ·ç«¯ (Godot)"]
        C1[å®æ—¶å“åº”<br/>WASD/æ‹–æ‹½/è·³è·ƒ]
        C2[çŠ¶æ€åŒæ­¥<br/>ä½ç½®/é€Ÿåº¦/è¾“å…¥]
        C3[åŠ¨ä½œæ‰§è¡Œ<br/>BlendTree/ç¨‹åºåŒ–åŠ¨ç”»]
    end
    
    subgraph Server["æœåŠ¡ç«¯ (JS/Node.js)"]
        S1[çŠ¶æ€èšåˆ<br/>æ±‡æ€»å¤šç»´åº¦æ•°æ®]
        S2[åœºæ™¯ç†è§£<br/>LLM æ¨ç†]
        S3[ä¸»åŠ¨æœåŠ¡<br/>è¡Œä¸ºæ ‘å†³ç­–]
        S4[å¤æ‚é€»è¾‘<br/>å¤šæ ‘å¹¶è¡Œ/æ—¶åºæ¨ç†]
    end
    
    C2 -->|state_sync| S1
    C2 -->|interaction| S1
    S1 --> S2
    S2 --> S3
    S3 -->|bt_output| C3
    
    style Client fill:#e1f5ff
    style Server fill:#fff4e1
```

**æœåŠ¡ç«¯çš„æ ¸å¿ƒä¼˜åŠ¿**ï¼š

| ç»´åº¦ | å®¢æˆ·ç«¯ | æœåŠ¡ç«¯ |
|:-----|:------|:-------|
| **å“åº”é€Ÿåº¦** | âš¡ é›¶å»¶è¿Ÿï¼ˆæœ¬åœ°é—­ç¯ï¼‰ | ğŸŒ æœ‰ç½‘ç»œå»¶è¿Ÿ |
| **è®¡ç®—èƒ½åŠ›** | ğŸ’» å—é™äºè®¾å¤‡æ€§èƒ½ | â˜ï¸ æœåŠ¡å™¨çº§è®¡ç®—èƒ½åŠ› |
| **AI èƒ½åŠ›** | âŒ æ—  LLM æ”¯æŒ | âœ… å®Œæ•´ LLM é›†æˆ |
| **çŠ¶æ€èšåˆ** | ğŸ“Š å•ä¸€å®¢æˆ·ç«¯è§†è§’ | ğŸŒ å…¨å±€è§†è§’ï¼ˆå¤šå®¢æˆ·ç«¯ï¼‰ |
| **å¤æ‚é€»è¾‘** | âš ï¸ ç®€å•çŠ¶æ€æœº/BlendTree | âœ… å¤æ‚è¡Œä¸ºæ ‘/å¤šæ ‘å¹¶è¡Œ |
| **åœºæ™¯ç†è§£** | âŒ æ— æ³•ç†è§£è¯­ä¹‰ | âœ… LLM è¯­ä¹‰ç†è§£ |
| **ä¸»åŠ¨å†³ç­–** | âŒ è¢«åŠ¨å“åº” | âœ… ä¸»åŠ¨è§¦å‘ |

### 1.2 æœåŠ¡ç«¯è¡Œä¸ºæ ‘çš„æ ¸å¿ƒèƒ½åŠ›

```mermaid
mindmap
  root((æœåŠ¡ç«¯è¡Œä¸ºæ ‘))
    çŠ¶æ€èšåˆ
      å¤šç»´åº¦æ•°æ®
      æ—¶é—´åºåˆ—åˆ†æ
      çŠ¶æ€æ¨¡å¼è¯†åˆ«
    åœºæ™¯ç†è§£
      LLM è¯­ä¹‰ç†è§£
      ç¯å¢ƒä¸Šä¸‹æ–‡åˆ†æ
      ç”¨æˆ·æ„å›¾æ¨æ–­
    ä¸»åŠ¨æœåŠ¡
      å®šæ—¶æ£€æµ‹
      æ¡ä»¶è§¦å‘
      ä¸»åŠ¨äº¤äº’
    å¤æ‚å†³ç­–
      å¤šæ ‘å¹¶è¡Œ
      ä¼˜å…ˆçº§ä»²è£
      æ—¶åºæ¨ç†
    è®°å¿†èƒ½åŠ›
      å†å²çŠ¶æ€
      äº¤äº’è®°å½•
      ä¸Šä¸‹æ–‡è®°å¿†
```

---

## äºŒã€å®¢æˆ·ç«¯åŒæ­¥çš„çŠ¶æ€æ•°æ®

### 2.1 çŠ¶æ€æ•°æ®åˆ†ç±»

å®¢æˆ·ç«¯é€šè¿‡ `state_sync` å’Œ `interaction` æ¶ˆæ¯å‘æœåŠ¡ç«¯åŒæ­¥æ•°æ®ï¼Œè¿™äº›æ•°æ®å­˜å‚¨åœ¨ **Blackboard** ä¸­ï¼Œä¾›è¡Œä¸ºæ ‘ä½¿ç”¨ã€‚

#### 2.1.1 ç‰©ç†çŠ¶æ€æ•°æ®ï¼ˆä¼ æ„Ÿå™¨æ•°æ®ï¼‰

| é”®å | ç±»å‹ | æ›´æ–°é¢‘ç‡ | è¯´æ˜ |
|:-----|:----|:--------|:-----|
| `penguinPosition` | `Array[3]` | æ¯ç§’ 1 æ¬¡ | è§’è‰²çš„ 3D åæ ‡ `[x, y, z]` |
| `velocity` | `Array[3]` | æ¯ç§’ 1 æ¬¡ | å½“å‰é€Ÿåº¦å‘é‡ `[vx, vy, vz]` |
| `isOnFloor` | `Boolean` | æ¯ç§’ 1 æ¬¡ | æ˜¯å¦åœ¨åœ°é¢ä¸Š |
| `isMovingLocally` | `Boolean` | å®æ—¶ï¼ˆçŠ¶æ€å˜åŒ–æ—¶ï¼‰ | æ˜¯å¦æ­£åœ¨ç”± WASD æ‰‹åŠ¨æ§åˆ¶ |
| `isJumpPressed` | `Boolean` | å®æ—¶ï¼ˆçŠ¶æ€å˜åŒ–æ—¶ï¼‰ | æ˜¯å¦æŒ‰ä¸‹è·³è·ƒé”® |
| `isDragging` | `Boolean` | æŒ‰éœ€ï¼ˆdrag_start/drag_endï¼‰ | æ˜¯å¦å¤„äºè¢«æ‹–æ‹½çŠ¶æ€ |
| `lastCollision` | `Object` | ç¢°æ’æ—¶ä¸ŠæŠ¥ | ç¢°æ’ä¿¡æ¯ï¼ˆä½ç½®ã€æ³•çº¿ã€æ—¶é—´æˆ³ï¼‰ |

#### 2.1.2 äº¤äº’äº‹ä»¶æ•°æ®

| é”®å | ç±»å‹ | æ›´æ–°é¢‘ç‡ | è¯´æ˜ |
|:-----|:----|:--------|:-----|
| `isClicked` | `Boolean` | ç‚¹å‡»æ—¶ï¼ˆ500ms åè‡ªåŠ¨æ¸…é™¤ï¼‰ | æ˜¯å¦è¢«ç‚¹å‡» |
| `lastUserInput` | `String` | ç”¨æˆ·è¾“å…¥æ—¶ | ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬æŒ‡ä»¤ |
| `hasNewInput` | `Boolean` | ç”¨æˆ·è¾“å…¥æ—¶ï¼ˆtrueï¼‰ | æ˜¯å¦æœ‰æ–°çš„ç”¨æˆ·è¾“å…¥ |

#### 2.1.3 å†…éƒ¨çŠ¶æ€æ•°æ®ï¼ˆæœåŠ¡ç«¯è®¡ç®—ï¼‰

| é”®å | ç±»å‹ | æ›´æ–°é¢‘ç‡ | è¯´æ˜ |
|:-----|:----|:--------|:-----|
| `energy` | `Number` | æ¯ 2 ç§’ | èƒ½é‡å€¼ï¼ˆ0-100ï¼‰ |
| `boredom` | `Number` | æ¯ 2 ç§’ | æ— èŠåº¦ï¼ˆ0-100ï¼‰ |
| `lastStateTick` | `Number` | æ¯å¸§ | ä¸Šæ¬¡çŠ¶æ€æ›´æ–°çš„æ—¶é—´æˆ³ |

### 2.2 æ•°æ®åŒæ­¥æµç¨‹

```mermaid
sequenceDiagram
    participant Client as Godotå®¢æˆ·ç«¯
    participant WS as WebSocket
    participant Server as BTServer
    participant BB as Blackboard
    participant BT as BehaviorTree
    
    Note over Client,BT: çŠ¶æ€åŒæ­¥æµç¨‹
    
    loop æ¯ç§’ 1 æ¬¡
        Client->>WS: state_sync {position, velocity, is_moving_locally, ...}
        WS->>Server: æ¥æ”¶æ¶ˆæ¯
        Server->>BB: set('penguinPosition', position)
        Server->>BB: set('isMovingLocally', is_moving_locally)
        Server->>BB: set('velocity', velocity)
        Note over BB: çŠ¶æ€æ•°æ®æ›´æ–°å®Œæˆ
    end
    
    Client->>WS: interaction {action: "click", position: [...]}
    WS->>Server: æ¥æ”¶æ¶ˆæ¯
    Server->>BB: set('isClicked', true)
    Server->>BB: set('lastCollision', {...})
    
    Note over BT: è¡Œä¸ºæ ‘æ¯ 100ms è¯»å– Blackboard
    BT->>BB: get('penguinPosition')
    BT->>BB: get('boredom')
    BT->>BB: get('isMovingLocally')
    BT->>BT: åŸºäºçŠ¶æ€æ•°æ®å†³ç­–
```

---

## ä¸‰ã€åœºæ™¯ç†è§£çš„å®ç°æ–¹å¼

### 3.1 ä»€ä¹ˆæ˜¯åœºæ™¯ç†è§£ï¼Ÿ

**åœºæ™¯ç†è§£**æ˜¯æŒ‡æœåŠ¡ç«¯é€šè¿‡åˆ†æå®¢æˆ·ç«¯åŒæ­¥çš„çŠ¶æ€æ•°æ®ï¼Œç†è§£å½“å‰çš„ç¯å¢ƒå’Œç”¨æˆ·æ„å›¾ï¼Œä»è€Œåšå‡ºæ›´æ™ºèƒ½çš„å†³ç­–ã€‚

#### åœºæ™¯ç†è§£çš„å±‚æ¬¡

```mermaid
graph TD
    Raw[åŸå§‹çŠ¶æ€æ•°æ®<br/>position, velocity, ...]
    
    subgraph L1["ç¬¬ä¸€å±‚ï¼šçŠ¶æ€èšåˆ"]
        S1[ç‰©ç†çŠ¶æ€<br/>ä½ç½®/é€Ÿåº¦/è¾“å…¥]
        S2[æ—¶é—´åºåˆ—<br/>è¿åŠ¨è½¨è¿¹/åœç•™æ—¶é—´]
        S3[æ¨¡å¼è¯†åˆ«<br/>ç§»åŠ¨æ¨¡å¼/äº¤äº’é¢‘ç‡]
    end
    
    subgraph L2["ç¬¬äºŒå±‚ï¼šåœºæ™¯æ¨ç†"]
        R1[ç¯å¢ƒç†è§£<br/>ç”¨æˆ·æ˜¯å¦åœ¨æ“ä½œ<br/>æ˜¯å¦é™æ­¢/ç§»åŠ¨]
        R2[æ„å›¾æ¨æ–­<br/>ç”¨æˆ·æƒ³è¦ä»€ä¹ˆ<br/>å½“å‰çŠ¶æ€å¦‚ä½•]
        R3[ä¸Šä¸‹æ–‡åˆ†æ<br/>å†å²äº¤äº’è®°å½•<br/>å½“å‰åœºæ™¯çŠ¶æ€]
    end
    
    subgraph L3["ç¬¬ä¸‰å±‚ï¼šLLM è¯­ä¹‰ç†è§£"]
        LLM1[è‡ªç„¶è¯­è¨€ç†è§£<br/>"ç”¨æˆ·å¯èƒ½åœ¨åšä»€ä¹ˆ"]
        LLM2[æƒ…æ„Ÿåˆ†æ<br/>"ç”¨æˆ·å¯èƒ½çš„å¿ƒæƒ…"]
        LLM3[å»ºè®®ç”Ÿæˆ<br/>"åº”è¯¥åšä»€ä¹ˆæ¥æå‡ä½“éªŒ"]
    end
    
    Raw --> L1
    L1 --> L2
    L2 --> L3
    L3 --> Decision[å†³ç­–è¾“å‡º<br/>åŠ¨ä½œåºåˆ—/ä¸»åŠ¨æœåŠ¡]
    
    style L1 fill:#e1f5ff
    style L2 fill:#fff4e1
    style L3 fill:#f0e6ff
```

### 3.2 åœºæ™¯ç†è§£çš„å®ç°æ–¹å¼

#### æ–¹å¼ 1ï¼šåŸºäºè§„åˆ™çš„åœºæ™¯åˆ¤æ–­ï¼ˆå½“å‰å®ç°ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šç®€å•ã€ç¡®å®šæ€§çš„åœºæ™¯åˆ¤æ–­

**å®ç°ç¤ºä¾‹**ï¼š
```typescript
// åœºæ™¯åˆ¤æ–­èŠ‚ç‚¹ç¤ºä¾‹
export class SceneUnderstandingNode extends Action {
  tick(tick: Tick): number {
    const blackboard = tick.blackboard;
    
    // 1. è·å–çŠ¶æ€æ•°æ®
    const position = blackboard.get('penguinPosition');
    const isMovingLocally = blackboard.get('isMovingLocally');
    const lastInteractionTime = blackboard.get('lastInteractionTime') || 0;
    const timeSinceLastInteraction = Date.now() - lastInteractionTime;
    
    // 2. åœºæ™¯åˆ¤æ–­
    let scene = 'IDLE';
    if (isMovingLocally) {
      scene = 'USER_CONTROLLING';
    } else if (timeSinceLastInteraction > 60000) {
      scene = 'USER_ABSENT';
    } else if (position[0] > 8 || position[0] < -8) {
      scene = 'NEAR_EDGE';
    }
    
    // 3. å†™å…¥åœºæ™¯çŠ¶æ€
    blackboard.set('currentScene', scene);
    return SUCCESS;
  }
}
```

#### æ–¹å¼ 2ï¼šåŸºäº LLM çš„åœºæ™¯ç†è§£ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šå¤æ‚ã€éœ€è¦è¯­ä¹‰ç†è§£çš„åœºæ™¯

**å®ç°ç¤ºä¾‹**ï¼š
```typescript
// LLM åœºæ™¯ç†è§£èŠ‚ç‚¹
export class LLMSceneUnderstandingNode extends AsyncAction {
  async performAsync(tick: Tick): Promise<number> {
    const blackboard = tick.blackboard;
    
    // 1. æ”¶é›†çŠ¶æ€å¿«ç…§
    const stateSnapshot = {
      position: blackboard.get('penguinPosition'),
      velocity: blackboard.get('velocity'),
      isMovingLocally: blackboard.get('isMovingLocally'),
      isDragging: blackboard.get('isDragging'),
      lastInteractionTime: blackboard.get('lastInteractionTime'),
      energy: blackboard.get('energy'),
      boredom: blackboard.get('boredom'),
      timestamp: Date.now()
    };
    
    // 2. æ„å»º LLM Prompt
    const prompt = `
[ENVIRONMENT STATE]
Position: [${stateSnapshot.position.join(', ')}]
Velocity: [${stateSnapshot.velocity?.join(', ') || '0, 0, 0'}]
User Controlling: ${stateSnapshot.isMovingLocally ? 'Yes' : 'No'}
Being Dragged: ${stateSnapshot.isDragging ? 'Yes' : 'No'}
Time Since Last Interaction: ${(Date.now() - (stateSnapshot.lastInteractionTime || 0)) / 1000}s
Energy: ${stateSnapshot.energy}/100
Boredom: ${stateSnapshot.boredom}/100

[INSTRUCTION]
Analyze the current scene and user state. What is the user likely doing?
What should the character do to improve the user experience?

Return a JSON object with:
- scene: (IDLE | USER_CONTROLLING | USER_ABSENT | USER_INTERACTING | EDGE_DANGER)
- user_intent: (what the user might want)
- suggestion: (what the character should do)
- confidence: (0-1)
    `.trim();
    
    // 3. è°ƒç”¨ LLM
    const response = await sendMessageToLLM([], prompt, blackboard.get('llmSettings'));
    
    // 4. è§£æç»“æœå¹¶å†™å…¥ Blackboard
    try {
      const result = JSON.parse(response);
      blackboard.set('sceneUnderstanding', result);
      blackboard.set('currentScene', result.scene);
      return SUCCESS;
    } catch (e) {
      console.error('Failed to parse LLM response', e);
      return FAILURE;
    }
  }
}
```

### 3.3 åœºæ™¯ç†è§£çš„åº”ç”¨åœºæ™¯

#### åœºæ™¯ 1ï¼šç”¨æˆ·è¡Œä¸ºè¯†åˆ«

**ç›®æ ‡**ï¼šè¯†åˆ«ç”¨æˆ·å½“å‰çš„è¡Œä¸ºæ¨¡å¼

**å®ç°æ€è·¯**ï¼š
```typescript
// é€šè¿‡åˆ†æä½ç½®å˜åŒ–æ¨¡å¼è¯†åˆ«ç”¨æˆ·è¡Œä¸º
const analyzeUserBehavior = (positions: Array<[number, number, number]>, timeWindow: number) => {
  // è®¡ç®—è¿åŠ¨è½¨è¿¹
  const distances = [];
  for (let i = 1; i < positions.length; i++) {
    const dist = Math.sqrt(
      Math.pow(positions[i][0] - positions[i-1][0], 2) +
      Math.pow(positions[i][2] - positions[i-1][2], 2)
    );
    distances.push(dist);
  }
  
  const avgSpeed = distances.reduce((a, b) => a + b, 0) / distances.length;
  const maxSpeed = Math.max(...distances);
  
  // è¡Œä¸ºè¯†åˆ«
  if (avgSpeed < 0.1) return 'STATIONARY';
  if (maxSpeed > 5) return 'FAST_MOVING';
  if (avgSpeed > 2) return 'MOVING';
  return 'SLOW_MOVING';
};
```

#### åœºæ™¯ 2ï¼šç¯å¢ƒå±é™©æ£€æµ‹

**ç›®æ ‡**ï¼šæ£€æµ‹è§’è‰²æ˜¯å¦å¤„äºå±é™©ç¯å¢ƒï¼ˆå¦‚è¾¹ç¼˜ã€ç¢°æ’åŒºåŸŸï¼‰

**å®ç°æ€è·¯**ï¼š
```typescript
// è¾¹ç•Œæ£€æµ‹èŠ‚ç‚¹
export class EdgeDetectionNode extends Action {
  tick(tick: Tick): number {
    const blackboard = tick.blackboard;
    const position = blackboard.get('penguinPosition');
    
    if (!position) return FAILURE;
    
    const [x, y, z] = position;
    const safeRadius = 8;
    
    // æ£€æµ‹æ˜¯å¦æ¥è¿‘è¾¹ç¼˜
    const distanceFromCenter = Math.sqrt(x * x + z * z);
    if (distanceFromCenter > safeRadius) {
      blackboard.set('isNearEdge', true);
      blackboard.set('edgeDistance', distanceFromCenter - safeRadius);
      return SUCCESS;
    }
    
    blackboard.set('isNearEdge', false);
    return FAILURE;
  }
}
```

#### åœºæ™¯ 3ï¼šç”¨æˆ·æƒ…ç»ªæ¨æ–­

**ç›®æ ‡**ï¼šé€šè¿‡äº¤äº’æ¨¡å¼æ¨æ–­ç”¨æˆ·æƒ…ç»ª

**å®ç°æ€è·¯**ï¼ˆç»“åˆ LLMï¼‰ï¼š
```typescript
// ç”¨æˆ·æƒ…ç»ªåˆ†æèŠ‚ç‚¹
export class UserEmotionAnalysisNode extends AsyncAction {
  async performAsync(tick: Tick): Promise<number> {
    const blackboard = tick.blackboard;
    
    // æ”¶é›†äº¤äº’æ•°æ®
    const interactionHistory = blackboard.get('interactionHistory') || [];
    const recentInteractions = interactionHistory.slice(-10);
    
    const prompt = `
[INTERACTION HISTORY]
${recentInteractions.map((i: any) => 
  `${i.type} at ${new Date(i.timestamp).toLocaleTimeString()}: ${i.details}`
).join('\n')}

[INSTRUCTION]
Based on the interaction pattern, infer the user's current emotion:
- Are they playful? (frequent interactions, dragging, clicking)
- Are they focused? (few interactions, maybe working)
- Are they bored? (no interactions for a long time)
- Are they frustrated? (rapid clicking, aggressive movements)

Return JSON: {emotion: "PLAYFUL" | "FOCUSED" | "BORED" | "FRUSTRATED" | "NEUTRAL", confidence: 0-1}
    `.trim();
    
    const response = await sendMessageToLLM([], prompt, blackboard.get('llmSettings'));
    const result = JSON.parse(response);
    
    blackboard.set('userEmotion', result);
    return SUCCESS;
  }
}
```

---

## å››ã€ä¸»åŠ¨æœåŠ¡çš„å®ç°æ–¹å¼

### 4.1 ä»€ä¹ˆæ˜¯ä¸»åŠ¨æœåŠ¡ï¼Ÿ

**ä¸»åŠ¨æœåŠ¡**æ˜¯æŒ‡æœåŠ¡ç«¯è¡Œä¸ºæ ‘åœ¨æ²¡æœ‰ç”¨æˆ·ç›´æ¥æŒ‡ä»¤çš„æƒ…å†µä¸‹ï¼Œä¸»åŠ¨æ£€æµ‹çŠ¶æ€å˜åŒ–ï¼Œå¹¶è§¦å‘ç›¸åº”çš„æœåŠ¡è¡Œä¸ºã€‚

#### ä¸»åŠ¨æœåŠ¡çš„è§¦å‘æœºåˆ¶

```mermaid
graph TD
    Timer[å®šæ—¶æ£€æµ‹<br/>æ¯ 2 ç§’]
    Condition[æ¡ä»¶åˆ¤æ–­<br/>BlackboardGuard]
    
    subgraph Triggers["è§¦å‘æ¡ä»¶"]
        T1[æ— èŠåº¦ > 70]
        T2[èƒ½é‡ < 20]
        T3[ç”¨æˆ·é•¿æ—¶é—´æ— äº¤äº’]
        T4[åœºæ™¯å˜åŒ–]
        T5[ç¯å¢ƒå±é™©]
    end
    
    subgraph Actions["ä¸»åŠ¨æœåŠ¡åŠ¨ä½œ"]
        A1[ä¸»åŠ¨æ‰“æ‹›å‘¼<br/>WAVE]
        A2[ä¸»åŠ¨ä¼‘æ¯<br/>SLEEP]
        A3[ä¸»åŠ¨äº’åŠ¨<br/>DANCE]
        A4[ä¸»åŠ¨æé†’<br/>LLM ç”Ÿæˆè¯è¯­]
        A5[ä¸»åŠ¨é¿é™©<br/>MOVE_TO_SAFE]
    end
    
    Timer --> Condition
    Condition --> T1
    Condition --> T2
    Condition --> T3
    Condition --> T4
    Condition --> T5
    
    T1 --> A1
    T1 --> A3
    T2 --> A2
    T3 --> A4
    T4 --> A1
    T5 --> A5
    
    style Timer fill:#e1f5ff
    style Condition fill:#fff4e1
    style Actions fill:#f0e6ff
```

### 4.2 ä¸»åŠ¨æœåŠ¡çš„å®ç°æ¶æ„

#### æ¶æ„ 1ï¼šç‹¬ç«‹çš„ä¸»åŠ¨æœåŠ¡æ ‘ï¼ˆå½“å‰å®ç°ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šç®€å•ã€ä½é¢‘çš„ä¸»åŠ¨æœåŠ¡

**å®ç°ç¤ºä¾‹**ï¼š
```typescript
// ActiveServiceBT.ts
export function createActiveServiceBT(): BehaviorTree {
  const tree = new BehaviorTree();
  tree.title = 'Active Service Tree';
  
  tree.root = new BlackboardGuard({
    title: 'Feel Lonely?',
    key: 'boredom',
    value: 70,
    scope: 'global',
    child: new BlackboardGuard({
      title: 'Not Sleeping?',
      key: 'energy',
      value: (val: any) => val > 30,
      scope: 'global',
      child: new MemSequence({
        title: 'Physical Idle Variety',
        children: [
          new PushPendingAction({ action: 'WAVE', title: 'Queue Greet' }),
          new Wait({ milliseconds: 10000 }),
          new PushPendingAction({ action: 'DANCE', title: 'Queue Dance' }),
          new Wait({ milliseconds: 15000 })
        ]
      })
    })
  });
  
  return tree;
}
```

**æ‰§è¡Œé¢‘ç‡**ï¼šæ¯ 2 ç§’æ‰§è¡Œä¸€æ¬¡ï¼ˆä½é¢‘ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•ç›´æ¥
- âœ… èµ„æºå ç”¨ä½
- âœ… æ˜“äºç†è§£å’Œç»´æŠ¤

**ç¼ºç‚¹**ï¼š
- âš ï¸ åŠŸèƒ½ç›¸å¯¹ç®€å•
- âš ï¸ æ— æ³•è¿›è¡Œå¤æ‚çš„åœºæ™¯ç†è§£

#### æ¶æ„ 2ï¼šç»“åˆ LLM çš„ä¸»åŠ¨æœåŠ¡ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦è¯­ä¹‰ç†è§£å’Œæ™ºèƒ½å†³ç­–çš„ä¸»åŠ¨æœåŠ¡

**å®ç°ç¤ºä¾‹**ï¼š
```typescript
// EnhancedActiveServiceBT.ts
export function createEnhancedActiveServiceBT(): BehaviorTree {
  const tree = new BehaviorTree();
  tree.title = 'Enhanced Active Service Tree';
  
  tree.root = new Priority({
    title: 'Active Service Priority',
    children: [
      // 1. æåº¦æ— èŠæ—¶ï¼Œä½¿ç”¨ LLM ç”Ÿæˆä¸»åŠ¨è¯è¯­
      new BlackboardGuard({
        title: 'Very Bored?',
        key: 'boredom',
        value: 80,
        scope: 'global',
        child: new MemSequence({
          children: [
            new ProactiveLLMNode({ title: 'Generate Proactive Message' }),
            new FunctionExecNode({ title: 'Execute LLM Actions' }),
            new Wait({ milliseconds: 20000 })
          ]
        })
      }),
      
      // 2. ä¸­åº¦æ— èŠæ—¶ï¼Œæ‰§è¡Œé¢„è®¾åŠ¨ä½œåºåˆ—
      new BlackboardGuard({
        title: 'Moderately Bored?',
        key: 'boredom',
        value: 70,
        scope: 'global',
        child: new MemSequence({
          children: [
            new PushPendingAction({ action: 'WAVE', title: 'Queue Greet' }),
            new Wait({ milliseconds: 10000 }),
            new PushPendingAction({ action: 'DANCE', title: 'Queue Dance' }),
            new Wait({ milliseconds: 15000 })
          ]
        })
      }),
      
      // 3. åœºæ™¯ç†è§£é©±åŠ¨çš„ä¸»åŠ¨æœåŠ¡
      new BlackboardGuard({
        title: 'Scene Understanding Active Service',
        key: 'currentScene',
        value: 'USER_ABSENT',
        scope: 'global',
        child: new MemSequence({
          children: [
            new LLMSceneUnderstandingNode({ title: 'Understand Scene' }),
            new ProactiveLLMNode({ title: 'Generate Contextual Response' }),
            new FunctionExecNode({ title: 'Execute Actions' })
          ]
        })
      })
    ]
  });
  
  return tree;
}
```

**æ‰§è¡Œé¢‘ç‡**ï¼šæ¯ 2-5 ç§’æ‰§è¡Œä¸€æ¬¡ï¼ˆå¯é…ç½®ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… æ™ºèƒ½å†³ç­–
- âœ… è¯­ä¹‰ç†è§£
- âœ… ä¸Šä¸‹æ–‡æ„ŸçŸ¥

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦ LLM è°ƒç”¨ï¼Œæœ‰å»¶è¿Ÿ
- âš ï¸ æˆæœ¬è¾ƒé«˜

### 4.3 ä¸»åŠ¨æœåŠ¡çš„å…¸å‹åœºæ™¯

#### åœºæ™¯ 1ï¼šæ— èŠåº¦é©±åŠ¨çš„ä¸»åŠ¨äº’åŠ¨

**è§¦å‘æ¡ä»¶**ï¼š`boredom > 70` ä¸” `energy > 30`

**å®ç°ä»£ç **ï¼š
```typescript
// å·²ç»åœ¨ ActiveServiceBT ä¸­å®ç°
new BlackboardGuard({
  key: 'boredom',
  value: 70,
  child: new MemSequence({
    children: [
      new PushPendingAction({ action: 'WAVE' }),
      new Wait({ milliseconds: 10000 }),
      new PushPendingAction({ action: 'DANCE' })
    ]
  })
})
```

#### åœºæ™¯ 2ï¼šèƒ½é‡é©±åŠ¨çš„ä¸»åŠ¨ä¼‘æ¯

**è§¦å‘æ¡ä»¶**ï¼š`energy < 20`

**å®ç°ä»£ç **ï¼š
```typescript
// å·²ç»åœ¨ RobotBT ä¸­å®ç°
new BlackboardGuard({
  key: 'energy',
  value: 20,
  child: new MemSequence({
    children: [
      new MoveToTargetAction({ targetPos: [4, 0.1, -3], speed: 0.1 }),
      new PlayAnimationAction({ action: 'SLEEP', duration: 10 }),
      new PlayAnimationAction({ action: 'SURPRISE', duration: 1 }),
      new MoveToTargetAction({ targetPos: [0, -1, 0], speed: 0.1 })
    ]
  })
})
```

#### åœºæ™¯ 3ï¼šç”¨æˆ·é•¿æ—¶é—´æ— äº¤äº’æ—¶çš„ä¸»åŠ¨æé†’

**è§¦å‘æ¡ä»¶**ï¼š`lastInteractionTime > 60ç§’` ä¸” `boredom > 50`

**å®ç°ä»£ç **ï¼š
```typescript
// æ–°å¢èŠ‚ç‚¹
export class LongIdleDetectionNode extends Action {
  tick(tick: Tick): number {
    const blackboard = tick.blackboard;
    const lastInteractionTime = blackboard.get('lastInteractionTime') || 0;
    const timeSinceLastInteraction = Date.now() - lastInteractionTime;
    const boredom = blackboard.get('boredom') || 0;
    
    if (timeSinceLastInteraction > 60000 && boredom > 50) {
      blackboard.set('isLongIdle', true);
      return SUCCESS;
    }
    
    blackboard.set('isLongIdle', false);
    return FAILURE;
  }
}

// åœ¨è¡Œä¸ºæ ‘ä¸­ä½¿ç”¨
new BlackboardGuard({
  key: 'isLongIdle',
  value: true,
  child: new MemSequence({
    children: [
      new ProactiveLLMNode({ title: 'Generate Reminder' }),
      new FunctionExecNode({ title: 'Execute Actions' })
    ]
  })
})
```

#### åœºæ™¯ 4ï¼šç¯å¢ƒå±é™©æ—¶çš„ä¸»åŠ¨é¿é™©

**è§¦å‘æ¡ä»¶**ï¼š`isNearEdge === true`

**å®ç°ä»£ç **ï¼š
```typescript
// åœ¨ RobotBT ä¸­å·²æœ‰å®ç°
new BlackboardGuard({
  key: (bb: any) => {
    const pos = bb.get('penguinPosition');
    return pos && (Math.abs(pos[0]) > 8 || Math.abs(pos[2]) > 8);
  },
  child: new MemSequence({
    children: [
      new PushPendingAction({ actions: ['SURPRISE'], emotion: 'LOVING' }),
      new MoveToTargetAction({ targetPos: [0, -1, 0], speed: 0.1 })
    ]
  })
})
```

---

## äº”ã€ç»“åˆ LLM çš„é«˜çº§åŠŸèƒ½

### 5.1 LLM åœ¨åœºæ™¯ç†è§£å’Œä¸»åŠ¨æœåŠ¡ä¸­çš„ä½œç”¨

#### LLM çš„æ ¸å¿ƒä»·å€¼

```mermaid
graph LR
    State[çŠ¶æ€æ•°æ®<br/>ä½ç½®/é€Ÿåº¦/äº¤äº’]
    LLM[LLM å¼•æ“<br/>è¯­ä¹‰ç†è§£]
    
    subgraph Capabilities["LLM èƒ½åŠ›"]
        C1[è‡ªç„¶è¯­è¨€ç†è§£<br/>ç†è§£ç”¨æˆ·æ„å›¾]
        C2[åœºæ™¯æ¨ç†<br/>åˆ†æå½“å‰çŠ¶æ€]
        C3[å»ºè®®ç”Ÿæˆ<br/>ç»™å‡ºè¡ŒåŠ¨å»ºè®®]
        C4[æƒ…æ„Ÿåˆ†æ<br/>ç†è§£ç”¨æˆ·æƒ…ç»ª]
        C5[ä¸Šä¸‹æ–‡è®°å¿†<br/>è®°ä½å†å²äº¤äº’]
    end
    
    State --> LLM
    LLM --> Capabilities
    Capabilities --> Action[åŠ¨ä½œè¾“å‡º<br/>bt_output_action]
    
    style LLM fill:#f0e6ff
    style Capabilities fill:#fff4e1
```

### 5.2 LLM èŠ‚ç‚¹ç±»å‹

#### èŠ‚ç‚¹ 1ï¼šProactiveLLMNodeï¼ˆä¸»åŠ¨ LLM èŠ‚ç‚¹ï¼‰

**ç”¨é€”**ï¼šåŸºäºå†…éƒ¨çŠ¶æ€ä¸»åŠ¨è°ƒç”¨ LLMï¼Œç”Ÿæˆè¯è¯­æˆ–åŠ¨ä½œ

**å®ç°ä»£ç **ï¼ˆå·²å®ç°ï¼‰ï¼š
```typescript
// ProactiveLLMNode.ts
export default class ProactiveLLMNode extends AsyncAction {
  async performAsync(tick: Tick): Promise<number> {
    const blackboard = tick.blackboard;
    const boredom = blackboard?.get('boredom') || 0;
    const energy = blackboard?.get('energy') || 100;
    
    const prompt = `
[INTERNAL STATE]
Boredom: ${boredom}/100
Energy: ${energy}/100

[INSTRUCTION]
You are feeling ${boredom > 70 ? 'lonely and bored' : 'active'}. 
Proactively say something cute to the user or perform an action.
    `.trim();
    
    const response = await sendMessageToLLM([], prompt, blackboard.get('llmSettings'));
    blackboard?.set('lastLLMResult', response);
    blackboard?.set('boredom', 0); // é‡ç½®æ— èŠåº¦
    
    return SUCCESS;
  }
}
```

#### èŠ‚ç‚¹ 2ï¼šLLMCallNodeï¼ˆLLM è°ƒç”¨èŠ‚ç‚¹ï¼‰

**ç”¨é€”**ï¼šå¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œè°ƒç”¨ LLM ç†è§£æ„å›¾

**å®ç°ä»£ç **ï¼ˆå·²å®ç°ï¼‰ï¼š
```typescript
// LLMCallNode.ts
export default class LLMCallNode extends AsyncAction {
  async performAsync(tick: Tick): Promise<number> {
    const blackboard = tick.blackboard;
    const userInput = blackboard?.get('lastUserInput');
    const chatHistory = blackboard?.get('chatHistory') || [];
    
    if (!userInput) return FAILURE;
    
    const response = await sendMessageToLLM(chatHistory, userInput, blackboard.get('llmSettings'));
    blackboard?.set('lastLLMResult', response);
    blackboard?.set('hasNewInput', false);
    
    return SUCCESS;
  }
}
```

#### èŠ‚ç‚¹ 3ï¼šSceneUnderstandingLLMNodeï¼ˆåœºæ™¯ç†è§£ LLM èŠ‚ç‚¹ï¼‰

**ç”¨é€”**ï¼šä½¿ç”¨ LLM è¿›è¡Œåœºæ™¯ç†è§£ï¼ˆæ–°å¢ç¤ºä¾‹ï¼‰

**å®ç°ä»£ç **ï¼š
```typescript
// SceneUnderstandingLLMNode.ts
export default class SceneUnderstandingLLMNode extends AsyncAction {
  async performAsync(tick: Tick): Promise<number> {
    const blackboard = tick.blackboard;
    
    // æ”¶é›†çŠ¶æ€å¿«ç…§
    const snapshot = {
      position: blackboard.get('penguinPosition'),
      velocity: blackboard.get('velocity'),
      isMovingLocally: blackboard.get('isMovingLocally'),
      isDragging: blackboard.get('isDragging'),
      lastInteractionTime: blackboard.get('lastInteractionTime'),
      energy: blackboard.get('energy'),
      boredom: blackboard.get('boredom'),
      interactionHistory: blackboard.get('interactionHistory')?.slice(-5) || []
    };
    
    const prompt = `
[ENVIRONMENT STATE]
Position: [${snapshot.position?.join(', ') || '0, 0, 0'}]
User Controlling: ${snapshot.isMovingLocally ? 'Yes' : 'No'}
Time Since Last Interaction: ${(Date.now() - (snapshot.lastInteractionTime || 0)) / 1000}s
Energy: ${snapshot.energy}/100
Boredom: ${snapshot.boredom}/100

[INTERACTION HISTORY]
${snapshot.interactionHistory.map((i: any) => 
  `- ${i.type} at ${new Date(i.timestamp).toLocaleTimeString()}`
).join('\n')}

[INSTRUCTION]
Analyze the current scene:
1. What is the user likely doing?
2. What is the character's emotional state?
3. What should the character do to improve the experience?

Return JSON: {
  scene: "IDLE" | "USER_CONTROLLING" | "USER_ABSENT" | "USER_INTERACTING",
  user_intent: "string",
  character_emotion: "HAPPY" | "BORED" | "ENERGETIC" | "TIRED",
  suggestion: "string",
  recommended_action: "WAVE" | "DANCE" | "IDLE" | "SLEEP" | null
}
    `.trim();
    
    try {
      const response = await sendMessageToLLM([], prompt, blackboard.get('llmSettings'));
      const result = JSON.parse(response);
      
      blackboard.set('sceneUnderstanding', result);
      blackboard.set('currentScene', result.scene);
      blackboard.set('recommendedAction', result.recommended_action);
      
      return SUCCESS;
    } catch (e) {
      console.error('Scene understanding failed', e);
      return FAILURE;
    }
  }
}
```

### 5.3 LLM é©±åŠ¨çš„ä¸»åŠ¨æœåŠ¡æµç¨‹

```mermaid
sequenceDiagram
    participant Timer as å®šæ—¶å™¨ (2ç§’)
    participant BT as ActiveServiceBT
    participant BB as Blackboard
    participant LLM as LLM API
    participant MainBT as MainBT
    participant Client as Godotå®¢æˆ·ç«¯
    
    Note over Timer,Client: LLM é©±åŠ¨çš„ä¸»åŠ¨æœåŠ¡æµç¨‹
    
    Timer->>BT: tick()
    BT->>BB: get('boredom')
    BB-->>BT: boredom = 85
    BT->>BT: BlackboardGuard æ£€æµ‹åˆ°æ— èŠåº¦ > 80
    
    rect rgb(255, 204, 188)
        Note over BT,LLM: 1. åœºæ™¯ç†è§£é˜¶æ®µ
        BT->>BB: æ”¶é›†çŠ¶æ€å¿«ç…§
        BB-->>BT: {position, velocity, ...}
        BT->>LLM: SceneUnderstandingLLMNode<br/>åˆ†æåœºæ™¯
        LLM-->>BT: {scene: "USER_ABSENT", suggestion: "..."}
        BT->>BB: set('sceneUnderstanding', result)
    end
    
    rect rgb(200, 255, 200)
        Note over BT,LLM: 2. ä¸»åŠ¨æœåŠ¡ç”Ÿæˆé˜¶æ®µ
        BT->>LLM: ProactiveLLMNode<br/>ç”Ÿæˆä¸»åŠ¨è¯è¯­/åŠ¨ä½œ
        LLM-->>BT: Function Call: animate_avatar(["DANCE"])
        BT->>BB: set('pendingActions', ["DANCE"])
    end
    
    rect rgb(255, 249, 200)
        Note over BB,Client: 3. åŠ¨ä½œæ‰§è¡Œé˜¶æ®µ
        MainBT->>BB: get('pendingActions')
        BB-->>MainBT: ["DANCE"]
        MainBT->>MainBT: ExecuteActionSequence
        MainBT->>Client: bt_output {actionState: {name: "DANCE"}}
        Client->>Client: æ‰§è¡Œèˆè¹ˆåŠ¨ä½œ
    end
```

---

## å…­ã€å®ç°æŒ‡å¯¼ï¼šä»é›¶å¼€å§‹æ„å»ºä¸»åŠ¨æœåŠ¡

### 6.1 æ­¥éª¤ 1ï¼šå®šä¹‰çŠ¶æ€æ•°æ®éœ€æ±‚

**é—®é¢˜**ï¼šä½ éœ€è¦å“ªäº›çŠ¶æ€æ•°æ®æ¥è§¦å‘ä¸»åŠ¨æœåŠ¡ï¼Ÿ

**ç¤ºä¾‹**ï¼š
```typescript
// åœ¨ BTServer.ts ä¸­å¤„ç† state_sync æ—¶ï¼Œæ”¶é›†éœ€è¦çš„çŠ¶æ€
case 'state_sync':
    // åŸºç¡€çŠ¶æ€
    client.blackboard.set('penguinPosition', data.data.position);
    client.blackboard.set('isMovingLocally', data.data.is_moving_locally || false);
    
    // è®¡ç®—æ´¾ç”ŸçŠ¶æ€ï¼ˆç”¨äºä¸»åŠ¨æœåŠ¡ï¼‰
    const lastInteractionTime = client.blackboard.get('lastInteractionTime') || Date.now();
    const timeSinceLastInteraction = Date.now() - lastInteractionTime;
    client.blackboard.set('timeSinceLastInteraction', timeSinceLastInteraction);
    
    // æ›´æ–°äº¤äº’å†å²ï¼ˆç”¨äºåœºæ™¯ç†è§£ï¼‰
    const interactionHistory = client.blackboard.get('interactionHistory') || [];
    interactionHistory.push({
      type: 'state_sync',
      timestamp: Date.now(),
      data: data.data
    });
    // åªä¿ç•™æœ€è¿‘ 50 æ¡è®°å½•
    if (interactionHistory.length > 50) {
      interactionHistory.shift();
    }
    client.blackboard.set('interactionHistory', interactionHistory);
    break;
```

### 6.2 æ­¥éª¤ 2ï¼šåˆ›å»ºåœºæ™¯ç†è§£èŠ‚ç‚¹

**é—®é¢˜**ï¼šå¦‚ä½•åˆ¤æ–­å½“å‰åœºæ™¯ï¼Ÿ

**å®ç°ç¤ºä¾‹**ï¼š
```typescript
// actions/SceneUnderstandingNode.ts
export default class SceneUnderstandingNode extends Action {
  tick(tick: Tick): number {
    const blackboard = tick.blackboard;
    
    // 1. æ”¶é›†çŠ¶æ€
    const isMovingLocally = blackboard.get('isMovingLocally');
    const isDragging = blackboard.get('isDragging');
    const timeSinceLastInteraction = blackboard.get('timeSinceLastInteraction') || 0;
    const position = blackboard.get('penguinPosition');
    
    // 2. åœºæ™¯åˆ¤æ–­
    let scene = 'IDLE';
    if (isDragging) {
      scene = 'USER_DRAGGING';
    } else if (isMovingLocally) {
      scene = 'USER_CONTROLLING';
    } else if (timeSinceLastInteraction > 60000) {
      scene = 'USER_ABSENT';
    } else if (position && (Math.abs(position[0]) > 8 || Math.abs(position[2]) > 8)) {
      scene = 'NEAR_EDGE';
    }
    
    // 3. å†™å…¥åœºæ™¯çŠ¶æ€
    blackboard.set('currentScene', scene);
    return SUCCESS;
  }
}
```

### 6.3 æ­¥éª¤ 3ï¼šåˆ›å»ºä¸»åŠ¨æœåŠ¡è¡Œä¸ºæ ‘

**é—®é¢˜**ï¼šå¦‚ä½•ç»„ç»‡ä¸»åŠ¨æœåŠ¡çš„é€»è¾‘ï¼Ÿ

**å®ç°ç¤ºä¾‹**ï¼š
```typescript
// trees/ActiveServiceBT.ts
export function createActiveServiceBT(): BehaviorTree {
  const tree = new BehaviorTree();
  tree.title = 'Active Service Tree';
  
  tree.root = new Priority({
    title: 'Active Service Priority',
    children: [
      // åœºæ™¯ 1ï¼šç”¨æˆ·é•¿æ—¶é—´æ— äº¤äº’
      new BlackboardGuard({
        title: 'User Absent?',
        key: 'currentScene',
        value: 'USER_ABSENT',
        scope: 'global',
        child: new MemSequence({
          children: [
            new ProactiveLLMNode({ title: 'Generate Reminder' }),
            new FunctionExecNode({ title: 'Execute Actions' }),
            new Wait({ milliseconds: 30000 })
          ]
        })
      }),
      
      // åœºæ™¯ 2ï¼šæ— èŠåº¦é«˜
      new BlackboardGuard({
        title: 'Very Bored?',
        key: 'boredom',
        value: 80,
        scope: 'global',
        child: new MemSequence({
          children: [
            new PushPendingAction({ action: 'WAVE', title: 'Queue Greet' }),
            new Wait({ milliseconds: 2000 }),
            new PushPendingAction({ action: 'DANCE', title: 'Queue Dance' }),
            new Wait({ milliseconds: 20000 })
          ]
        })
      }),
      
      // åœºæ™¯ 3ï¼šæ¥è¿‘è¾¹ç¼˜
      new BlackboardGuard({
        title: 'Near Edge?',
        key: 'currentScene',
        value: 'NEAR_EDGE',
        scope: 'global',
        child: new MemSequence({
          children: [
            new PushPendingAction({ actions: ['SURPRISE'], emotion: 'SURPRISED' }),
            new MoveToTargetAction({ targetPos: [0, -1, 0], speed: 0.1 }),
            new Wait({ milliseconds: 5000 })
          ]
        })
      })
    ]
  });
  
  return tree;
}
```

### 6.4 æ­¥éª¤ 4ï¼šåœ¨ä¸»å¾ªç¯ä¸­æ³¨å†Œè¡Œä¸ºæ ‘

**é—®é¢˜**ï¼šå¦‚ä½•è®©ä¸»åŠ¨æœåŠ¡æ ‘è¿è¡Œèµ·æ¥ï¼Ÿ

**å®ç°ç¤ºä¾‹**ï¼š
```typescript
// BTServer.ts
private startMainLoop() {
  // ä¸»è¡Œä¸ºæ ‘ï¼šæ¯ 100ms æ‰§è¡Œ
  setInterval(() => {
    this.clients.forEach(client => {
      if (client.mainBT) {
        client.mainBT.tick(null, client.blackboard);
        this.sendBTOutputs(client.ws, client);
      }
    });
  }, 100);
  
  // ä¸»åŠ¨æœåŠ¡æ ‘ï¼šæ¯ 2 ç§’æ‰§è¡Œï¼ˆä½é¢‘ï¼‰
  setInterval(() => {
    this.clients.forEach(client => {
      if (client.activeServiceBT) {
        client.activeServiceBT.tick(null, client.blackboard);
        // ä¸»åŠ¨æœåŠ¡æ ‘äº§ç”Ÿçš„åŠ¨ä½œä¼šé€šè¿‡ pendingActions ä¼ é€’ç»™ MainBT
        this.sendBTOutputs(client.ws, client);
      }
    });
  }, 2000);
}
```

### 6.5 æ­¥éª¤ 5ï¼šæµ‹è¯•å’Œè°ƒè¯•

**é—®é¢˜**ï¼šå¦‚ä½•æµ‹è¯•ä¸»åŠ¨æœåŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ

**æµ‹è¯•æ–¹æ³•**ï¼š
1. **è®¾ç½®æµ‹è¯•çŠ¶æ€**ï¼š
   ```typescript
   // åœ¨æµ‹è¯•ä¸­æ‰‹åŠ¨è®¾ç½®çŠ¶æ€
   blackboard.set('boredom', 85);
   blackboard.set('currentScene', 'USER_ABSENT');
   ```

2. **è§‚å¯Ÿè¡Œä¸ºæ ‘æ‰§è¡Œ**ï¼š
   - æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
   - ä½¿ç”¨å¯è§†åŒ–å·¥å…·ï¼ˆå¦‚ RobotAppï¼‰è§‚å¯Ÿè¡Œä¸ºæ ‘çŠ¶æ€

3. **éªŒè¯è¾“å‡º**ï¼š
   - æ£€æŸ¥ `bt_output_action` æ˜¯å¦æ­£ç¡®è®¾ç½®
   - æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦æ­£ç¡®æ¥æ”¶å’Œæ‰§è¡Œ

---

## ä¸ƒã€æœ€ä½³å®è·µå’Œæ³¨æ„äº‹é¡¹

### 7.1 æ€§èƒ½ä¼˜åŒ–

#### 1. LLM è°ƒç”¨é¢‘ç‡æ§åˆ¶

**é—®é¢˜**ï¼šLLM è°ƒç”¨æˆæœ¬é«˜ï¼Œå¦‚ä½•æ§åˆ¶é¢‘ç‡ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨ ProactiveLLMNode ä¸­æ·»åŠ å†·å´æ—¶é—´
export default class ProactiveLLMNode extends AsyncAction {
  private lastCallTime: number = 0;
  private cooldown: number = 30000; // 30 ç§’å†·å´
  
  async performAsync(tick: Tick): Promise<number> {
    const now = Date.now();
    if (now - this.lastCallTime < this.cooldown) {
      return FAILURE; // å†·å´ä¸­ï¼Œä¸æ‰§è¡Œ
    }
    
    // ... LLM è°ƒç”¨é€»è¾‘ ...
    
    this.lastCallTime = now;
    return SUCCESS;
  }
}
```

#### 2. çŠ¶æ€ç¼“å­˜å’Œå»é‡

**é—®é¢˜**ï¼šç›¸åŒçŠ¶æ€é‡å¤è§¦å‘ä¸»åŠ¨æœåŠ¡ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨è¡Œä¸ºæ ‘èŠ‚ç‚¹ä¸­æ·»åŠ çŠ¶æ€å»é‡
export class BoredomTriggerNode extends Action {
  private lastBoredomValue: number = 0;
  
  tick(tick: Tick): number {
    const boredom = tick.blackboard.get('boredom');
    
    // åªåœ¨æ— èŠåº¦å˜åŒ–è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘
    if (Math.abs(boredom - this.lastBoredomValue) < 10) {
      return FAILURE;
    }
    
    this.lastBoredomValue = boredom;
    return SUCCESS;
  }
}
```

### 7.2 ç”¨æˆ·ä½“éªŒä¼˜åŒ–

#### 1. é¿å…è¿‡äºé¢‘ç¹çš„ä¸»åŠ¨æœåŠ¡

**åŸåˆ™**ï¼šä¸»åŠ¨æœåŠ¡åº”è¯¥æ˜¯**è¡¥å……æ€§çš„**ï¼Œè€Œä¸æ˜¯**å¹²æ‰°æ€§çš„**

**å®ç°**ï¼š
- è®¾ç½®åˆç†çš„è§¦å‘é˜ˆå€¼ï¼ˆå¦‚æ— èŠåº¦ > 70 è€Œä¸æ˜¯ > 50ï¼‰
- ä½¿ç”¨å†·å´æ—¶é—´ï¼ˆå¦‚æ¯æ¬¡ä¸»åŠ¨æœåŠ¡åç­‰å¾… 20 ç§’ï¼‰
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ­£åœ¨äº¤äº’ï¼ˆå¦‚æœ `isMovingLocally === true`ï¼Œä¸è§¦å‘ï¼‰

#### 2. æ¸è¿›å¼å“åº”

**åŸåˆ™**ï¼šæ ¹æ®çŠ¶æ€ä¸¥é‡ç¨‹åº¦ï¼Œæä¾›ä¸åŒå¼ºåº¦çš„å“åº”

**å®ç°**ï¼š
```typescript
// æ¸è¿›å¼å“åº”ç¤ºä¾‹
new Priority({
  children: [
    // æåº¦æ— èŠï¼ˆ> 90ï¼‰ï¼šä½¿ç”¨ LLM ç”Ÿæˆä¸ªæ€§åŒ–è¯è¯­
    new BlackboardGuard({
      key: 'boredom',
      value: 90,
      child: new ProactiveLLMNode()
    }),
    
    // ä¸­åº¦æ— èŠï¼ˆ> 70ï¼‰ï¼šæ‰§è¡Œé¢„è®¾åŠ¨ä½œ
    new BlackboardGuard({
      key: 'boredom',
      value: 70,
      child: new PushPendingAction({ action: 'WAVE' })
    }),
    
    // è½»å¾®æ— èŠï¼ˆ> 50ï¼‰ï¼šä»…è½»å¾®åŠ¨ä½œ
    new BlackboardGuard({
      key: 'boredom',
      value: 50,
      child: new PushPendingAction({ action: 'IDLE' })
    })
  ]
})
```

### 7.3 é”™è¯¯å¤„ç†å’Œé™çº§

#### 1. LLM è°ƒç”¨å¤±è´¥å¤„ç†

**é—®é¢˜**ï¼šLLM è°ƒç”¨å¤±è´¥æ—¶å¦‚ä½•é™çº§ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨ ProactiveLLMNode ä¸­æ·»åŠ é™çº§é€»è¾‘
async performAsync(tick: Tick): Promise<number> {
  try {
    const response = await sendMessageToLLM([], prompt, settings);
    // ... å¤„ç†å“åº” ...
    return SUCCESS;
  } catch (error) {
    console.error('LLM call failed, using fallback', error);
    
    // é™çº§ï¼šä½¿ç”¨é¢„è®¾åŠ¨ä½œ
    const fallbackAction = this.getFallbackAction(tick);
    tick.blackboard.set('pendingActions', [fallbackAction]);
    return SUCCESS; // ä»ç„¶è¿”å›æˆåŠŸï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ
  }
}

private getFallbackAction(tick: Tick): string {
  const boredom = tick.blackboard.get('boredom');
  if (boredom > 80) return 'WAVE';
  if (boredom > 60) return 'DANCE';
  return 'IDLE';
}
```

#### 2. çŠ¶æ€æ•°æ®ç¼ºå¤±å¤„ç†

**é—®é¢˜**ï¼šå®¢æˆ·ç«¯çŠ¶æ€æ•°æ®ç¼ºå¤±æ—¶å¦‚ä½•å¤„ç†ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨åœºæ™¯ç†è§£èŠ‚ç‚¹ä¸­æ·»åŠ é»˜è®¤å€¼
tick(tick: Tick): number {
  const position = blackboard.get('penguinPosition') || [0, -1, 0];
  const isMovingLocally = blackboard.get('isMovingLocally') || false;
  const boredom = blackboard.get('boredom') || 0;
  
  // ä½¿ç”¨é»˜è®¤å€¼ç»§ç»­æ‰§è¡Œï¼Œä¸å› ä¸ºæ•°æ®ç¼ºå¤±è€Œå¤±è´¥
  // ...
}
```

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒè¦ç‚¹

1. **æœåŠ¡ç«¯ä¼˜åŠ¿**ï¼š
   - âœ… å¯ä»¥è®¿é—® LLMï¼Œè¿›è¡Œè¯­ä¹‰ç†è§£
   - âœ… å¯ä»¥è¿›è¡Œå¤æ‚çš„çŠ¶æ€èšåˆå’Œåœºæ™¯æ¨ç†
   - âœ… æ”¯æŒå¤šæ ‘å¹¶è¡Œï¼Œå®ç°å¤æ‚çš„å†³ç­–é€»è¾‘

2. **çŠ¶æ€æ•°æ®æ˜¯åŸºç¡€**ï¼š
   - å®¢æˆ·ç«¯é€šè¿‡ `state_sync` å’Œ `interaction` åŒæ­¥çŠ¶æ€
   - æœåŠ¡ç«¯è¡Œä¸ºæ ‘é€šè¿‡ Blackboard è¯»å–çŠ¶æ€
   - çŠ¶æ€æ•°æ®æ˜¯åœºæ™¯ç†è§£å’Œä¸»åŠ¨æœåŠ¡çš„åŸºç¡€

3. **åœºæ™¯ç†è§£å±‚æ¬¡**ï¼š
   - ç¬¬ä¸€å±‚ï¼šçŠ¶æ€èšåˆï¼ˆç‰©ç†çŠ¶æ€ã€æ—¶é—´åºåˆ—ï¼‰
   - ç¬¬äºŒå±‚ï¼šåœºæ™¯æ¨ç†ï¼ˆç¯å¢ƒç†è§£ã€æ„å›¾æ¨æ–­ï¼‰
   - ç¬¬ä¸‰å±‚ï¼šLLM è¯­ä¹‰ç†è§£ï¼ˆè‡ªç„¶è¯­è¨€ç†è§£ã€æƒ…æ„Ÿåˆ†æï¼‰

4. **ä¸»åŠ¨æœåŠ¡å®ç°**ï¼š
   - ä½¿ç”¨ç‹¬ç«‹çš„ `ActiveServiceBT`ï¼ˆä½é¢‘æ‰§è¡Œï¼‰
   - ç»“åˆ `ProactiveLLMNode` å®ç°æ™ºèƒ½å†³ç­–
   - é€šè¿‡ `PushPendingAction` å°†åŠ¨ä½œä¼ é€’ç»™ `MainBT`

### 8.2 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **å®Œå–„çŠ¶æ€æ•°æ®æ”¶é›†**ï¼š
   - åœ¨ `BTServer.ts` ä¸­å¢å¼º `state_sync` å¤„ç†
   - æ·»åŠ äº¤äº’å†å²è®°å½•
   - è®¡ç®—æ´¾ç”ŸçŠ¶æ€ï¼ˆå¦‚ `timeSinceLastInteraction`ï¼‰

2. **å®ç°åœºæ™¯ç†è§£èŠ‚ç‚¹**ï¼š
   - åˆ›å»º `SceneUnderstandingNode`ï¼ˆåŸºäºè§„åˆ™ï¼‰
   - åˆ›å»º `SceneUnderstandingLLMNode`ï¼ˆåŸºäº LLMï¼‰
   - åœ¨è¡Œä¸ºæ ‘ä¸­ä½¿ç”¨åœºæ™¯ç†è§£ç»“æœ

3. **æ‰©å±•ä¸»åŠ¨æœåŠ¡æ ‘**ï¼š
   - æ·»åŠ æ›´å¤šè§¦å‘æ¡ä»¶
   - ç»“åˆ LLM å®ç°æ™ºèƒ½å†³ç­–
   - å®ç°æ¸è¿›å¼å“åº”

4. **æµ‹è¯•å’Œä¼˜åŒ–**ï¼š
   - æµ‹è¯•ä¸»åŠ¨æœåŠ¡çš„è§¦å‘é¢‘ç‡
   - ä¼˜åŒ– LLM è°ƒç”¨é¢‘ç‡å’Œæˆæœ¬
   - æ”¶é›†ç”¨æˆ·åé¦ˆï¼Œè°ƒæ•´é˜ˆå€¼

---

## é™„å½•ï¼šå®Œæ•´ç¤ºä¾‹ä»£ç 

### ç¤ºä¾‹ 1ï¼šå¢å¼ºçš„ ActiveServiceBT

```typescript
// trees/EnhancedActiveServiceBT.ts
import BehaviorTree from '../core/BehaviorTree';
import Priority from '../composites/Priority';
import MemSequence from '../composites/MemSequence';
import BlackboardGuard from '../decorators/BlackboardGuard';
import PushPendingAction from '../actions/PushPendingAction';
import ProactiveLLMNode from '../actions/ProactiveLLMNode';
import FunctionExecNode from '../actions/FunctionExecNode';
import SceneUnderstandingLLMNode from '../actions/SceneUnderstandingLLMNode';
import Wait from '../actions/Wait';

export function createEnhancedActiveServiceBT(): BehaviorTree {
  const tree = new BehaviorTree();
  tree.title = 'Enhanced Active Service Tree';
  
  tree.root = new Priority({
    title: 'Active Service Priority',
    children: [
      // 1. æåº¦æ— èŠ + LLM åœºæ™¯ç†è§£
      new BlackboardGuard({
        title: 'Very Bored + Scene Understanding',
        key: 'boredom',
        value: 85,
        scope: 'global',
        child: new MemSequence({
          children: [
            new SceneUnderstandingLLMNode({ title: 'Understand Scene' }),
            new ProactiveLLMNode({ title: 'Generate Proactive Response' }),
            new FunctionExecNode({ title: 'Execute Actions' }),
            new Wait({ milliseconds: 30000 }) // å†·å´æ—¶é—´
          ]
        })
      }),
      
      // 2. ä¸­åº¦æ— èŠ + é¢„è®¾åŠ¨ä½œ
      new BlackboardGuard({
        title: 'Moderately Bored',
        key: 'boredom',
        value: 70,
        scope: 'global',
        child: new MemSequence({
          children: [
            new PushPendingAction({ action: 'WAVE', title: 'Queue Greet' }),
            new Wait({ milliseconds: 3000 }),
            new PushPendingAction({ action: 'DANCE', title: 'Queue Dance' }),
            new Wait({ milliseconds: 20000 })
          ]
        })
      }),
      
      // 3. ç”¨æˆ·é•¿æ—¶é—´æ— äº¤äº’
      new BlackboardGuard({
        title: 'User Absent',
        key: 'timeSinceLastInteraction',
        value: (val: number) => val > 60000, // 60 ç§’
        scope: 'global',
        child: new MemSequence({
          children: [
            new ProactiveLLMNode({ title: 'Generate Reminder' }),
            new FunctionExecNode({ title: 'Execute Actions' }),
            new Wait({ milliseconds: 60000 }) // 1 åˆ†é’Ÿå†·å´
          ]
        })
      })
    ]
  });
  
  return tree;
}
```

### ç¤ºä¾‹ 2ï¼šçŠ¶æ€æ•°æ®å¢å¼ºå¤„ç†

```typescript
// BTServer.ts ä¸­çš„ state_sync å¤„ç†
case 'state_sync':
    // åŸºç¡€çŠ¶æ€
    client.blackboard.set('penguinPosition', data.data.position);
    client.blackboard.set('isMovingLocally', data.data.is_moving_locally || false);
    client.blackboard.set('isOnFloor', data.data.is_on_floor || false);
    client.blackboard.set('isJumpPressed', data.data.is_jump_pressed || false);
    
    // è®¡ç®—æ´¾ç”ŸçŠ¶æ€
    const lastInteractionTime = client.blackboard.get('lastInteractionTime') || Date.now();
    const timeSinceLastInteraction = Date.now() - lastInteractionTime;
    client.blackboard.set('timeSinceLastInteraction', timeSinceLastInteraction);
    
    // æ›´æ–°äº¤äº’å†å²
    const interactionHistory = client.blackboard.get('interactionHistory') || [];
    interactionHistory.push({
      type: 'state_sync',
      timestamp: Date.now(),
      data: {
        position: data.data.position,
        isMovingLocally: data.data.is_moving_locally
      }
    });
    // åªä¿ç•™æœ€è¿‘ 50 æ¡
    if (interactionHistory.length > 50) {
      interactionHistory.shift();
    }
    client.blackboard.set('interactionHistory', interactionHistory);
    
    // æ›´æ–°æœ€åäº¤äº’æ—¶é—´ï¼ˆå¦‚æœç”¨æˆ·åœ¨æ“ä½œï¼‰
    if (data.data.is_moving_locally || data.data.is_jump_pressed) {
      client.blackboard.set('lastInteractionTime', Date.now());
    }
    break;
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2024å¹´  
**ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
