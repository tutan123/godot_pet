# è¿ç»­çŠ¶æ€ç©ºé—´è®¾è®¡ä¸å®ç°

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜"è¿ç»­çŠ¶æ€ç©ºé—´"çš„è®¾è®¡ç†å¿µã€æ¶æ„å®ç°å’Œå…·ä½“ä»£ç ï¼Œå±•ç¤ºå¦‚ä½•å°†ç¦»æ•£çŠ¶æ€ï¼ˆå¦‚IDLEâ†’WALKâ†’RUNï¼‰æ‰©å±•ä¸ºè¿ç»­çŠ¶æ€ç©ºé—´ï¼Œå®ç°æ›´è‡ªç„¶ã€æ›´ä¸°å¯Œçš„å® ç‰©è¡Œä¸ºè¡¨ç°ã€‚

**æ ¸å¿ƒç†å¿µ**ï¼šå°†å® ç‰©çš„å†…éƒ¨çŠ¶æ€ï¼ˆèƒ½é‡ã€æƒ…ç»ªã€æ— èŠåº¦ï¼‰ä½œä¸ºè¿ç»­å€¼ï¼Œç›´æ¥æ˜ å°„åˆ°åŠ¨ç”»è¡¨ç°ï¼Œå®ç°å¹³æ»‘çš„çŠ¶æ€è¿‡æ¸¡ã€‚

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

### ä¼ ç»Ÿç¦»æ•£çŠ¶æ€çš„é—®é¢˜

```typescript
// âŒ ç¦»æ•£çŠ¶æ€ï¼šåªèƒ½æ˜¯ IDLE æˆ– WALK æˆ– RUN
enum AnimState {
  IDLE = 0,
  WALK = 1,
  RUN = 2
}

// è¡Œä¸ºåˆ‡æ¢å¾ˆç”Ÿç¡¬
if (energy > 50) {
  setAnimState(AnimState.RUN);  // çªç„¶åˆ‡æ¢åˆ°å¥”è·‘
} else {
  setAnimState(AnimState.WALK); // çªç„¶åˆ‡æ¢åˆ°è¡Œèµ°
}
```

### è¿ç»­çŠ¶æ€ç©ºé—´çš„è§£å†³æ–¹æ¡ˆ

```typescript
// âœ… è¿ç»­çŠ¶æ€ï¼šenergy 0-100 å¹³æ»‘æ˜ å°„åŠ¨ç”»
const energy = 75.5;  // è¿ç»­å€¼
const emotion = 0.8;  // è¿ç»­å€¼

// BlendTree å‚æ•°ç›´æ¥æ˜ å°„è¿ç»­çŠ¶æ€
animationTree.set("parameters/energy_blend/blend_position", energy / 100.0);
animationTree.set("parameters/emotion_blend/blend_position", emotion);
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
è¿ç»­çŠ¶æ€ç©ºé—´æ¶æ„
â”œâ”€â”€ ğŸ¯ æ ¸å¿ƒç†å¿µ
â”‚   â”œâ”€â”€ çŠ¶æ€è¿ç»­åŒ–
â”‚   â”œâ”€â”€ å‚æ•°æ˜ å°„åŒ–
â”‚   â””â”€â”€ è¡Œä¸ºå¹³æ»‘åŒ–
â”‚
â”œâ”€â”€ ğŸ“Š çŠ¶æ€æ¨¡å‹
â”‚   â”œâ”€â”€ Energy (0-100)
â”‚   â”œâ”€â”€ Boredom (0-100)
â”‚   â””â”€â”€ Emotion (0.0-1.0)
â”‚
â”œâ”€â”€ ğŸ”„ æœåŠ¡ç«¯å®ç°
â”‚   â”œâ”€â”€ UpdateInternalStatesAction
â”‚   â”œâ”€â”€ Emotionè®¡ç®—å‡½æ•°
â”‚   â””â”€â”€ é»‘æ¿çŠ¶æ€åŒæ­¥
â”‚
â”œâ”€â”€ ğŸ® å®¢æˆ·ç«¯å®ç°
â”‚   â”œâ”€â”€ BlendTreeæ‰©å±•
â”‚   â”œâ”€â”€ å‚æ•°æ˜ å°„
â”‚   â””â”€â”€ åŠ¨ç”»è¡¨ç°
â”‚
â””â”€â”€ âš¡ æ€§èƒ½ä¼˜åŒ–
    â”œâ”€â”€ è®¡ç®—æ•ˆç‡
    â”œâ”€â”€ å†…å­˜ä½¿ç”¨
    â””â”€â”€ ç½‘ç»œä¼ è¾“
```

### çŠ¶æ€è¿ç»­åŒ–çš„ä¸‰ä¸ªå±‚æ¬¡

#### 1. å†…éƒ¨çŠ¶æ€è¿ç»­åŒ–
```typescript
interface ContinuousPetState {
  energy: number;    // 0-100ï¼Œå½±å“æ´»åŠ›ç¨‹åº¦
  boredom: number;   // 0-100ï¼Œå½±å“è¡Œä¸ºé¢‘ç‡
  emotion: number;   // 0.0-1.0ï¼Œå½±å“æƒ…æ„Ÿè¡¨ç°
}
```

#### 2. åŠ¨ç”»å‚æ•°è¿ç»­åŒ–
```gdscript
# BlendTree å‚æ•°å®Œå…¨è¿ç»­
parameters/energy_blend/blend_position: 0.0-1.0
parameters/emotion_blend/blend_position: 0.0-1.0
parameters/boredom_blend/blend_position: 0.0-1.0
```

#### 3. è¡Œä¸ºè¡¨ç°è¿ç»­åŒ–
```
Energy 100 â†’ æ˜‚é¦–æŒºèƒ¸çš„å¥”è·‘åŠ¨ç”»
Energy 50  â†’ æ­£å¸¸çš„è¡Œèµ°åŠ¨ç”»
Energy 0   â†’ å‚å¤´ä¸§æ°”çš„ç¼“æ…¢ç§»åŠ¨
```

---

## ğŸ”„ æœåŠ¡ç«¯å®ç°

### 1. UpdateInternalStatesAction æ‰©å±•

#### åŸå§‹ä»£ç ï¼ˆç¦»æ•£çŠ¶æ€ï¼‰
```typescript
export default class UpdateInternalStatesAction extends Action {
  tick(tick: Tick): number {
    const blackboard = tick.blackboard;

    let boredom = blackboard.get('boredom') || 0;
    let energy = blackboard.get('energy') || 100;

    // ç®€å•çš„å¢å‡é€»è¾‘
    boredom += deltaTime * 1.0;
    energy = Math.min(100, energy); // è¾¹ç•Œé™åˆ¶

    // å†™å›é»‘æ¿
    blackboard.set('boredom', boredom);
    blackboard.set('energy', energy);

    return SUCCESS;
  }
}
```

#### æ‰©å±•åçš„ä»£ç ï¼ˆè¿ç»­çŠ¶æ€ç©ºé—´ï¼‰
```typescript
export default class UpdateInternalStatesAction extends Action {
  tick(tick: Tick): number {
    const blackboard = tick.blackboard;
    const treeId = tick.tree?.id;

    // 1. è·å–å½“å‰è¿ç»­çŠ¶æ€
    let boredom = blackboard.get('boredom') || 0;
    let energy = blackboard.get('energy') || 100;
    const lastTickTime = blackboard.get('lastStateTick', treeId) || Date.now();

    const now = Date.now();
    const deltaTime = (now - lastTickTime) / 1000; // ç§’

    // 2. è¿ç»­çŠ¶æ€æ›´æ–°ï¼ˆå¹³æ»‘å˜åŒ–ï¼‰
    boredom += deltaTime * 1.0;   // æ¯ç§’å¢åŠ 1ç‚¹æ— èŠåº¦
    energy -= deltaTime * 0.1;    // æ¯ç§’å‡å°‘0.1ç‚¹èƒ½é‡

    // 3. è¾¹ç•Œé™åˆ¶ï¼ˆè¿ç»­ç©ºé—´çš„è¾¹ç•Œï¼‰
    boredom = Math.min(100, Math.max(0, boredom));
    energy = Math.min(100, Math.max(0, energy));

    // ğŸ¯ æ ¸å¿ƒï¼šè®¡ç®—emotionä½œä¸ºè¿ç»­å‡½æ•°
    const emotion = this.calculateEmotion(energy, boredom);

    // 4. å†™å›é»‘æ¿ï¼ˆè¿ç»­å€¼ï¼‰
    blackboard.set('boredom', boredom);   // 0-100 è¿ç»­
    blackboard.set('energy', energy);     // 0-100 è¿ç»­
    blackboard.set('emotion', emotion);   // 0.0-1.0 è¿ç»­

    blackboard.set('lastStateTick', now, treeId);

    return SUCCESS;
  }

  /**
   * è®¡ç®—emotionçš„è¿ç»­å‡½æ•°
   * emotion = energy_weight * (1.0 - boredom) + boredom_penalty
   */
  private calculateEmotion(energy: number, boredom: number): number {
    // å½’ä¸€åŒ–è¾“å…¥å€¼ (0-100 -> 0.0-1.0)
    const normalizedEnergy = energy / 100.0;
    const normalizedBoredom = boredom / 100.0;

    // è¿ç»­emotionè®¡ç®—ï¼š
    // é«˜energy + ä½boredom = å¿«ä¹ (1.0)
    // ä½energy + é«˜boredom = æ‚²ä¼¤ (0.0)
    const energyWeight = 0.7;    // energyå¯¹emotionçš„å½±å“æƒé‡
    const boredomWeight = 0.3;   // boredomå¯¹emotionçš„å½±å“æƒé‡

    const emotion = energyWeight * (1.0 - normalizedBoredom) +
                   boredomWeight * normalizedEnergy;

    // ç¡®ä¿è¾“å‡ºåœ¨0.0-1.0èŒƒå›´å†…
    return Math.max(0.0, Math.min(1.0, emotion));
  }
}
```

### 2. Emotionè®¡ç®—å‡½æ•°è¯¦è§£

#### æ•°å­¦æ¨¡å‹
```
emotion = energyWeight Ã— (1.0 - boredom) + boredomWeight Ã— energy

å…¶ä¸­ï¼š
- energyWeight = 0.7 (èƒ½é‡æƒé‡)
- boredomWeight = 0.3 (æ— èŠæƒé‡)
- energy âˆˆ [0, 100] (å½’ä¸€åŒ–ä¸º [0, 1])
- boredom âˆˆ [0, 100] (å½’ä¸€åŒ–ä¸º [0, 1])
- emotion âˆˆ [0.0, 1.0] (è¾“å‡ºèŒƒå›´)
```

#### è®¡ç®—ç¤ºä¾‹
```typescript
// é«˜èƒ½é‡ï¼Œä½æ— èŠ â†’ é«˜æƒ…ç»ª (å¿«ä¹)
calculateEmotion(100, 0) = 0.7 * (1.0 - 0.0) + 0.3 * 1.0 = 1.0

// ä¸­ç­‰çŠ¶æ€ â†’ ä¸­æ€§æƒ…ç»ª
calculateEmotion(50, 50) = 0.7 * (1.0 - 0.5) + 0.3 * 0.5 = 0.35 + 0.15 = 0.5

// ä½èƒ½é‡ï¼Œé«˜æ— èŠ â†’ ä½æƒ…ç»ª (æ‚²ä¼¤)
calculateEmotion(0, 100) = 0.7 * (1.0 - 1.0) + 0.3 * 0.0 = 0.0
```

### 3. é»‘æ¿çŠ¶æ€åŒæ­¥

```typescript
// æœåŠ¡ç«¯å‘é€è¿ç»­çŠ¶æ€åˆ°å®¢æˆ·ç«¯
const statusUpdate = {
  energy: blackboard.get('energy'),     // 0-100
  boredom: blackboard.get('boredom'),   // 0-100
  emotion: blackboard.get('emotion'),   // 0.0-1.0
  // ... å…¶ä»–è¿ç»­çŠ¶æ€
};

ws.send(JSON.stringify({
  type: 'status_update',
  data: statusUpdate
}));
```

---

## ğŸ® å®¢æˆ·ç«¯å®ç°

### 1. BlendTree æ‰©å±•è®¾è®¡

#### ä¼ ç»ŸBlendTreeï¼ˆç¦»æ•£ï¼‰
```
AnimationNodeBlendTree
â”œâ”€â”€ Locomotion (BlendSpace1D)
â”‚   â”œâ”€â”€ idle (pos: 0.0)
â”‚   â”œâ”€â”€ walk (pos: 0.5)
â”‚   â””â”€â”€ run (pos: 1.0)
â””â”€â”€ Jump (Blend2)
    â”œâ”€â”€ ground (amount: 0.0)
    â””â”€â”€ air (amount: 1.0)
```

#### æ‰©å±•åçš„BlendTreeï¼ˆè¿ç»­çŠ¶æ€ç©ºé—´ï¼‰
```
AnimationNodeBlendTree
â”œâ”€â”€ Locomotion (BlendSpace1D)
â”‚   â”œâ”€â”€ idle_energetic (pos: 0.0)    â† è¿ç»­çŠ¶æ€å½±å“
â”‚   â”œâ”€â”€ idle_normal (pos: 0.3)
â”‚   â”œâ”€â”€ idle_tired (pos: 0.6)
â”‚   â”œâ”€â”€ walk_energetic (pos: 1.0)
â”‚   â””â”€â”€ walk_tired (pos: 1.3)
â”œâ”€â”€ EnergyBlend (BlendSpace1D)         â† æ–°å¢è¿ç»­å‚æ•°
â”‚   â”œâ”€â”€ energetic (pos: 0.0)
â”‚   â”œâ”€â”€ normal (pos: 0.5)
â”‚   â””â”€â”€ tired (pos: 1.0)
â”œâ”€â”€ EmotionBlend (BlendSpace1D)        â† æ–°å¢è¿ç»­å‚æ•°
â”‚   â”œâ”€â”€ happy (pos: 0.0)
â”‚   â”œâ”€â”€ neutral (pos: 0.5)
â”‚   â””â”€â”€ sad (pos: 1.0)
â””â”€â”€ Jump (Blend2)
    â””â”€â”€ ...
```

### 2. åŠ¨ç”»æ¨¡å—æ‰©å±•

#### pet_animation.gd ä¸­çš„BlendTreeåˆå§‹åŒ–

```gdscript
## åˆå§‹åŒ–BlendTreeæ‰©å±•ï¼ˆè¿ç»­çŠ¶æ€ç©ºé—´ï¼‰
func _init_blend_tree_extensions() -> void:
	if not animation_tree:
		return

	# ğŸ¯ P1ï¼šè¿ç»­çŠ¶æ€ç©ºé—´ - BlendTreeç»“æ„æ‰©å±•
	# åŠ¨æ€æ·»åŠ EmotionBlendå’ŒEnergyBlendå‚æ•°æ”¯æŒ
	# æ³¨æ„ï¼šå®é™…çš„BlendèŠ‚ç‚¹éœ€è¦åœ¨Godotç¼–è¾‘å™¨ä¸­æ‰‹åŠ¨æ·»åŠ ï¼Œè¿™é‡Œåªè®¾ç½®å‚æ•°

	# åˆå§‹åŒ–è¿ç»­çŠ¶æ€å‚æ•°
	animation_tree.set("parameters/emotion_blend/blend_position", 0.5)  # 0.0-1.0ï¼Œé»˜è®¤ä¸­æ€§
	animation_tree.set("parameters/energy_blend/blend_position", 0.5)   # 0.0-1.0ï¼Œé»˜è®¤æ­£å¸¸

	_log("BlendTree extended with continuous state parameters")
```

### 3. æ§åˆ¶å™¨ä¸­çš„çŠ¶æ€æ˜ å°„

#### pet_controller.gd ä¸­çš„çŠ¶æ€åŒæ­¥å¤„ç†

```gdscript
## ğŸ¯ P1ï¼šè¿ç»­çŠ¶æ€ç©ºé—´ - å®¢æˆ·ç«¯å‚æ•°æ˜ å°„
func _on_status_updated(status: Dictionary) -> void:
	# å°†æœåŠ¡ç«¯çš„è¿ç»­çŠ¶æ€å€¼æ˜ å°„ä¸ºåŠ¨ç”»æ ‘å‚æ•°ï¼Œå®ç°å¹³æ»‘è¿‡æ¸¡
	var energy = status.get("energy", 100.0)  # 0-100
	var boredom = status.get("boredom", 0.0)  # 0-100
	var emotion = status.get("emotion", 0.5)  # 0.0-1.0

	# å½’ä¸€åŒ–å¹¶è®¾ç½®BlendTreeå‚æ•°
	if animation_tree:
		# Energyå½±å“æ•´ä½“åŠ¨ç”»çš„"æ´»åŠ›"ç¨‹åº¦ (0.0 = ç–²æƒ«, 1.0 = ç²¾åŠ›å……æ²›)
		var normalized_energy = energy / 100.0
		animation_tree.set("parameters/energy_blend/blend_position", normalized_energy)

		# Emotionå½±å“åŠ¨ç”»çš„æƒ…æ„Ÿè¡¨ç° (0.0 = æ‚²ä¼¤, 1.0 = å¿«ä¹)
		animation_tree.set("parameters/emotion_blend/blend_position", emotion)

	_log("[Status] Updated continuous states - Energy: %.1f, Emotion: %.2f" % [energy, emotion])
```

### 4. å‚æ•°æ˜ å°„é€»è¾‘è¯¦è§£

#### Energyå‚æ•°æ˜ å°„
```gdscript
# Energy 0-100 â†’ BlendTreeå‚æ•° 0.0-1.0
var normalized_energy = energy / 100.0  # çº¿æ€§æ˜ å°„

# BlendTreeä¸­çš„æ•ˆæœï¼š
# energy = 100 (1.0) â†’ ç²¾åŠ›å……æ²›çš„åŠ¨ç”»å˜ä½“
# energy = 50  (0.5) â†’ æ­£å¸¸çš„åŠ¨ç”»å˜ä½“
# energy = 0   (0.0) â†’ ç–²æƒ«çš„åŠ¨ç”»å˜ä½“
```

#### Emotionå‚æ•°æ˜ å°„
```gdscript
# Emotion 0.0-1.0 â†’ BlendTreeå‚æ•° 0.0-1.0
# ç›´æ¥æ˜ å°„ï¼Œæ— éœ€è½¬æ¢

# BlendTreeä¸­çš„æ•ˆæœï¼š
# emotion = 1.0 â†’ å¿«ä¹çš„è¡¨æƒ…åŠ¨ç”»
# emotion = 0.5 â†’ ä¸­æ€§çš„è¡¨æƒ…åŠ¨ç”»
# emotion = 0.0 â†’ æ‚²ä¼¤çš„è¡¨æƒ…åŠ¨ç”»
```

---

## ğŸ¨ åŠ¨ç”»è¡¨ç°æ•ˆæœ

### 1. å¹³æ»‘è¿‡æ¸¡ç¤ºä¾‹

#### èƒ½é‡é€æ¸ä¸‹é™çš„æ•ˆæœ
```
æ—¶é—´    Energy    åŠ¨ç”»è¡¨ç°
0s      100       æ˜‚é¦–æŒºèƒ¸çš„å¥”è·‘
2s       80       ä»ç„¶æ¯”è¾ƒç²¾ç¥çš„å¥”è·‘
4s       60       æ­£å¸¸çš„å¥”è·‘
6s       40       å¼€å§‹æ˜¾å¾—æœ‰äº›ç–²æƒ«
8s       20       æ˜æ˜¾çš„ç–²æƒ«çŠ¶æ€
10s       0       å‚å¤´ä¸§æ°”çš„ç¼“æ…¢ç§»åŠ¨
```

#### æƒ…ç»ªå˜åŒ–çš„æ•ˆæœ
```
Emotion 0.0 â†’ 0.2ï¼šæ‚²ä¼¤ â†’ ä½æ²‰
Emotion 0.4 â†’ 0.6ï¼šæ­£å¸¸ â†’ å¹³å’Œ
Emotion 0.8 â†’ 1.0ï¼šå¿«ä¹ â†’ å…´å¥‹
```

### 2. å¤šçŠ¶æ€ç»„åˆæ•ˆæœ

```gdscript
# åŒæ—¶è€ƒè™‘å¤šä¸ªè¿ç»­çŠ¶æ€
func update_animation_blend() -> void:
	var energy_factor = energy / 100.0      # 0.0-1.0
	var emotion_factor = emotion             # 0.0-1.0
	var boredom_factor = boredom / 100.0     # 0.0-1.0

	# ç»„åˆå‚æ•°ï¼šæ´»åŠ› = energy Ã— (1.0 - boredom)
	var vitality = energy_factor * (1.0 - boredom_factor)

	# æœ€ç»ˆåŠ¨ç”»å‚æ•°æ˜¯å¤šä¸ªçŠ¶æ€çš„ç»„åˆ
	animation_tree.set("parameters/vitality_blend", vitality)
	animation_tree.set("parameters/emotion_blend", emotion_factor)
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. è®¡ç®—æ•ˆç‡

#### æœåŠ¡ç«¯ä¼˜åŒ–
```typescript
// æ‰¹é‡è®¡ç®—ï¼Œé¿å…é‡å¤è®¡ç®—
private batchUpdateStates(blackboard: Blackboard): void {
  const states = blackboard.getAll(); // ä¸€æ¬¡æ€§è·å–æ‰€æœ‰çŠ¶æ€

  // æ‰¹é‡è®¡ç®—è¿ç»­å€¼
  const emotion = this.calculateEmotion(states.energy, states.boredom);
  const vitality = this.calculateVitality(states.energy, states.boredom);

  // æ‰¹é‡è®¾ç½®
  blackboard.setMultiple({
    emotion,
    vitality,
    last_update: Date.now()
  });
}
```

#### å®¢æˆ·ç«¯ä¼˜åŒ–
```gdscript
# é˜²æŠ–æ›´æ–°ï¼Œé¿å…é¢‘ç¹è®¾ç½®å‚æ•°
var last_update_time = 0.0
const UPDATE_INTERVAL = 0.1  # 100msæ›´æ–°ä¸€æ¬¡

func update_animation_parameters() -> void:
	var now = Time.get_ticks_msec() / 1000.0
	if now - last_update_time < UPDATE_INTERVAL:
		return  # è·³è¿‡é¢‘ç¹æ›´æ–°

	# æ‰§è¡Œå‚æ•°æ›´æ–°
	animation_tree.set("parameters/energy_blend/blend_position", energy / 100.0)
	last_update_time = now
```

### 2. å†…å­˜ä½¿ç”¨

#### çŠ¶æ€å‹ç¼©
```typescript
// ä½¿ç”¨æ›´ç´§å‡‘çš„æ•°æ®ç±»å‹
interface CompactState {
  e: number;  // energy (0-100)
  b: number;  // boredom (0-100)
  m: number;  // emotion (0.0-1.0, å‹ç¼©åˆ°0-255)
}

// å‹ç¼©emotionåˆ°å•å­—èŠ‚
const compressedEmotion = Math.round(emotion * 255);
const decompressedEmotion = compressedEmotion / 255.0;
```

### 3. ç½‘ç»œä¼ è¾“ä¼˜åŒ–

#### å¢é‡åŒæ­¥
```typescript
// åªå‘é€å˜åŒ–çš„çŠ¶æ€
interface StateDelta {
  energy?: number;
  boredom?: number;
  emotion?: number;
  timestamp: number;
}

// å®¢æˆ·ç«¯æ™ºèƒ½åˆå¹¶
func apply_state_delta(delta: Dictionary) -> void:
	if delta.has("energy"):
		energy = delta.energy
	if delta.has("emotion"):
		emotion = delta.emotion

	# å¹³æ»‘è¿‡æ¸¡åˆ°æ–°çŠ¶æ€
	tween.interpolate_property(
		animation_tree,
		"parameters/emotion_blend/blend_position",
		current_emotion,
		emotion,
		0.5  # 0.5ç§’è¿‡æ¸¡
	)
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. è¿ç»­æ€§æµ‹è¯•

```typescript
describe('è¿ç»­çŠ¶æ€ç©ºé—´', () => {
  it('åº”è¯¥æ”¯æŒå¹³æ»‘çš„çŠ¶æ€è¿‡æ¸¡', () => {
    const states = [0, 25, 50, 75, 100];

    states.forEach(energy => {
      blackboard.set('energy', energy);
      updateAction.tick(tick);

      const emotion = blackboard.get('emotion');
      expect(emotion).toBeGreaterThanOrEqual(0.0);
      expect(emotion).toBeLessThanOrEqual(1.0);

      // éªŒè¯è¿ç»­æ€§ï¼šç›¸é‚»çŠ¶æ€å˜åŒ–åˆç†
      if (energy > 0) {
        const prevEnergy = energy - 25;
        const prevEmotion = calculateEmotion(prevEnergy, 0);
        const diff = Math.abs(emotion - prevEmotion);
        expect(diff).toBeLessThan(0.5); // å˜åŒ–ä¸åº”å¤ªå¤§
      }
    });
  });
});
```

### 2. è¾¹ç•Œæ¡ä»¶æµ‹è¯•

```typescript
it('åº”è¯¥æ­£ç¡®å¤„ç†è¾¹ç•Œæ¡ä»¶', () => {
  // æµ‹è¯•èƒ½é‡ä¸º0
  blackboard.set('energy', 0);
  blackboard.set('boredom', 0);
  updateAction.tick(tick);
  expect(blackboard.get('emotion')).toBeCloseTo(0.3, 1); // 0.7 * 1.0 + 0.3 * 0 = 0.7? ç­‰ç­‰...

  // é‡æ–°è®¡ç®—ï¼š
  // energy=0, boredom=0
  // normalizedEnergy = 0/100 = 0.0
  // normalizedBoredom = 0/100 = 0.0
  // emotion = 0.7 * (1.0 - 0.0) + 0.3 * 0.0 = 0.7

  expect(blackboard.get('emotion')).toBeCloseTo(0.7, 1);
});
```

---

## ğŸ“ˆ æ‰©å±•æ€§è®¾è®¡

### 1. æ·»åŠ æ–°çš„è¿ç»­çŠ¶æ€

```typescript
// æ‰©å±•çŠ¶æ€æ¨¡å‹
interface ExtendedPetState extends ContinuousPetState {
  hunger: number;      // 0-100
  thirst: number;      // 0-100
  social_need: number; // 0-100
  health: number;      // 0-100
}

// æ·»åŠ æ–°çš„BlendTreeå‚æ•°
animation_tree.set("parameters/hunger_blend/blend_position", hunger / 100.0);
animation_tree.set("parameters/health_blend/blend_position", health / 100.0);
```

### 2. ç»„åˆçŠ¶æ€è®¡ç®—

```typescript
// è®¡ç®—ç»¼åˆå¹¸ç¦åº¦
calculateHappiness(state: ExtendedPetState): number {
  const weights = {
    energy: 0.3,
    emotion: 0.3,
    hunger: -0.2,    // é¥¥é¥¿é™ä½å¹¸ç¦åº¦
    health: 0.2
  };

  return (
    weights.energy * (state.energy / 100) +
    weights.emotion * state.emotion +
    weights.hunger * (1.0 - state.hunger / 100) +  // é¥¥é¥¿åº¦åè½¬
    weights.health * (state.health / 100)
  );
}
```

### 3. åŠ¨æ€æƒé‡è°ƒæ•´

```typescript
// æ ¹æ®å® ç‰©ç±»å‹è°ƒæ•´çŠ¶æ€æƒé‡
const breedWeights = {
  'energetic': { energy: 0.4, emotion: 0.3, hunger: 0.3 },
  'lazy': { energy: 0.2, emotion: 0.3, hunger: 0.5 },
  'emotional': { energy: 0.2, emotion: 0.6, hunger: 0.2 }
};
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒæˆå°±

1. **çŠ¶æ€è¿ç»­åŒ–**ï¼šä»ç¦»æ•£çŠ¶æ€ï¼ˆIDLE/WALK/RUNï¼‰åˆ°è¿ç»­çŠ¶æ€ç©ºé—´
2. **å‚æ•°æ˜ å°„åŒ–**ï¼šå†…éƒ¨çŠ¶æ€ç›´æ¥æ˜ å°„åˆ°åŠ¨ç”»è¡¨ç°
3. **è¡Œä¸ºå¹³æ»‘åŒ–**ï¼šæ¶ˆé™¤ç”Ÿç¡¬çš„çŠ¶æ€åˆ‡æ¢ï¼Œå®ç°è‡ªç„¶è¿‡æ¸¡

### æŠ€æœ¯ä¼˜åŠ¿

- **è¡¨ç°åŠ›æå‡**ï¼šå® ç‰©è¡Œä¸ºæ›´ä¸°å¯Œã€æ›´è‡ªç„¶
- **æ‰©å±•æ€§å¢å¼º**ï¼šè½»æ¾æ·»åŠ æ–°çš„è¿ç»­çŠ¶æ€
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘çŠ¶æ€åˆ‡æ¢çš„è®¡ç®—å¼€é”€
- **ç”¨æˆ·ä½“éªŒæ”¹å–„**ï¼šå¹³æ»‘çš„åŠ¨ç”»è¿‡æ¸¡æå‡æ²‰æµ¸æ„Ÿ

### å®ç°è¦ç‚¹

- **æœåŠ¡ç«¯**ï¼šè¿ç»­çŠ¶æ€è®¡ç®—å’ŒåŒæ­¥
- **å®¢æˆ·ç«¯**ï¼šBlendTreeå‚æ•°æ˜ å°„å’ŒåŠ¨ç”»è¡¨ç°
- **æ¶æ„**ï¼šçŠ¶æ€é©±åŠ¨çš„è¿ç»­ç©ºé—´è®¾è®¡

**å…³é”®è¯**ï¼šè¿ç»­çŠ¶æ€ã€å¹³æ»‘è¿‡æ¸¡ã€å‚æ•°æ˜ å°„ã€BlendTreeæ‰©å±•ã€é©¬å°”å¯å¤«çŠ¶æ€ç©ºé—´

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-01-18
**å®ç°çŠ¶æ€**ï¼šå·²å®Œæˆï¼ˆP1ä»»åŠ¡ï¼‰