# 动作逻辑职责划分：本地物理混合 vs 服务端马尔可夫决策

在本项目中，我们采用了 **“本地传感器上报 + 服务端 AI 决策（马尔可夫性）+ 本地参数化混合表现”** 的现代游戏架构。

## 1. 职责划分核心原则 (Markov Decision Process)

| 层次 | 归属 | 核心技术 | 职责描述 (马尔可夫语义) |
| :--- | :--- | :--- | :--- |
| **表现层 (Actuators)** | Godot 客户端 | **BlendTree** (AnimationTree) | **状态响应器**：根据当前的混合参数（速度、动作权重）实时呈现姿态。 |
| **决策层 (Brain)** | JS 服务端 | **行为树** (Markov BT) | **状态转移器**：每帧观察传感器数据，决定下一刻的“意图（Actuator）”。 |
| **传感器层 (Sensors)** | Godot 客户端 | 物理引擎 + 输入检测 | **环境上报器**：将物理事实（我在动、我在跳）同步到黑板。 |

---

## 2. 为什么本地使用“BlendTree”？

我们不再使用简单的“播放”逻辑，而是使用 **BlendTree (混合树)**：

1.  **参数化驱动**：通过设置 `blend_position` 等参数，动作不再是“硬切换”，而是“无缝滑入”。
2.  **多维混合**：支持在走路的同时进行跳跃（Overlay），或者叠加表情。
3.  **零延迟响应**：本地物理输入（WASD）直接修改混合参数，不经过服务器往返，手感最顺滑。

---

## 3. 为什么服务端是“马尔可夫决策”行为树？

服务端的行为树遵循马尔可夫性质，决策仅依赖于当前黑板状态：

1.  **输入输出隔离**：参考 `pointerPosition` 模式，我们将客户端同步来的物理状态（Sensor）与 AI 发出的指令（Actuator）完全解耦。
2.  **AI 让路决策 (User Observer)**：行为树中包含一个显式的优先级分支。当观察到用户在操作时，AI 决策为“保持静默”，主动让出控制权。
3.  **决策一致性**：无论是用户操作还是 LLM 指令，行为树都在每一帧根据全局优先级（碰撞 > 指令 > 用户 > 闲置）进行裁决。

---

## 4. 关键交互流程：以“移动”为例 (输入输出分离模式)

1.  **感知 (Sense)**：用户按下 W 键，Godot 设置本地 `WALK` 动画（零延迟），并上报 `is_moving_locally: true` 给服务端。
2.  **决策 (Decide)**：服务端行为树读取黑板传感器。
    *   AI 观察到用户在动。
    *   AI 分支 `User Control Observer` 触发并返回成功。
    *   AI 决策：**不向 `bt_output_action` 写入指令**。
3.  **表现 (Perform)**：Godot 没收到任何冲突指令，继续平滑执行本地物理动画。

---

## 5. 总结：马尔可夫决策链

*   **Godot 客户端**：物理实体的传感器阵列。
*   **JS 服务端**：纯粹的意图生成器（不做人工过滤，只做逻辑转移）。
*   **通信管道**：声明式同步意图。

这种架构确保了：**AI 拥有灵魂（能够根据感知做出复杂转移），用户拥有身体（操作无延迟）**。
