# æ—¶é—´çŠ¶æ€çš„é©¬å°”å¯å¤«æ€§ä¼˜åŒ–

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å°†æ—¶é—´çŠ¶æ€æ•´åˆåˆ°é©¬å°”å¯å¤«æ€§æ¶æ„ä¸­ï¼Œå®ç°"æ—¶é—´ä½œä¸ºçŠ¶æ€çš„ä¸€éƒ¨åˆ†"è€Œé"å†å²ä¾èµ–"çš„è®¾è®¡ç†å¿µã€‚

**æ ¸å¿ƒæ´å¯Ÿ**ï¼šæ—¶é—´æœ¬èº«ä¸æ˜¯é©¬å°”å¯å¤«æ€§çš„æ•Œäººï¼Œè€Œæ˜¯å®Œæ•´çš„å½“å‰çŠ¶æ€ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚

---

## ğŸ¯ æ¶‰åŠèŒƒå›´

### ä¸»è¦é’ˆå¯¹ï¼š**å®¢æˆ·ç«¯**ï¼ˆGodotï¼‰
- é—®é¢˜ä¸»è¦å‡ºç°åœ¨å®¢æˆ·ç«¯çš„æ—¶é—´ç®¡ç†é€»è¾‘
- å®¢æˆ·ç«¯ä¾èµ–å†å²æ—¶é—´æˆ³åˆ¤æ–­åŠ¨ä½œå®Œæˆ

### åŒæ—¶æ¶‰åŠï¼š**æœåŠ¡ç«¯**ï¼ˆTypeScriptï¼‰
- æœåŠ¡ç«¯æä¾›æ—¶é—´çŠ¶æ€ç®¡ç†åŸºç¡€è®¾æ–½
- æœåŠ¡ç«¯å®ç°æ—¶é—´æ„ŸçŸ¥çš„å†³ç­–æ”¯æŒ

---

## ğŸ” é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜ï¼ˆå®¢æˆ·ç«¯ï¼‰

```gdscript
# âŒ é”™è¯¯ï¼šä¾èµ–å†å²æ—¶é—´æˆ³
func apply_action_state(action_state: Dictionary, animation_tree: AnimationTree) -> void:
    var timestamp = action_state.get("timestamp", Time.get_unix_time_from_system())
    var elapsed = (Time.get_unix_time_from_system() - current_start_time) * 1000.0

    # åŸºäºå†å²æ—¶é—´åˆ¤æ–­æ˜¯å¦ä¸­æ–­
    if elapsed >= current_duration:
        should_interrupt = true
```

**é©¬å°”å¯å¤«æ€§é—®é¢˜**ï¼š
- `current_start_time` æ˜¯å†å²çŠ¶æ€
- `elapsed` è®¡ç®—ä¾èµ–å†å²æ—¶é—´ç‚¹
- å†³ç­–åŸºäºä¸å¯é‡ç°çš„å†å²ä¿¡æ¯

### æœŸæœ›çŠ¶æ€

```gdscript
# âœ… æ­£ç¡®ï¼šåŸºäºå½“å‰çŠ¶æ€å†³ç­–
func apply_action_state(action_state: Dictionary, animation_tree: AnimationTree) -> void:
    var current_priority = current_action_state.get("priority", 0)

    # å®Œå…¨åŸºäºå½“å‰çŠ¶æ€åˆ¤æ–­
    var should_interrupt = priority > current_priority
```

---

## ğŸ› ï¸ ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å®¢æˆ·ç«¯ï¼šäº‹ä»¶é©±åŠ¨çš„æ—¶é—´ç®¡ç†

#### æ ¸å¿ƒä¿®æ”¹ï¼š`pet_messaging.gd`

```gdscript
## åº”ç”¨åŠ¨ä½œçŠ¶æ€ï¼ˆé©¬å°”å¯å¤«æ€§ä¼˜åŒ–ï¼šäº‹ä»¶é©±åŠ¨ï¼‰
func apply_action_state(action_state: Dictionary, animation_tree: AnimationTree) -> void:
    var action_name = action_state.get("name", "idle").to_lower()
    var priority = action_state.get("priority", 50)

    # ğŸ¯ é©¬å°”å¯å¤«æ€§æ ¸å¿ƒï¼šä¼˜å…ˆçº§åˆ¤æ–­åªåŸºäºå½“å‰çŠ¶æ€
    var current_priority = current_action_state.get("priority", 0)
    var should_interrupt = current_action_state.is_empty() or priority > current_priority

    if should_interrupt:
        current_action_state = {
            "name": action_name,
            "priority": priority,
            "interruptible": true,
            "is_locomotion": action_name in ["walk", "run", "idle"]
        }

        if not current_action_state.is_locomotion:
            action_state_applied.emit(current_action_state)
            # åŠ¨ç”»æ¨¡å—ä¼šåœ¨åŠ¨ä½œå®Œæˆæ—¶å‘é€ä¿¡å·ï¼Œæ¶ˆæ¯æ¨¡å—å“åº”ä¿¡å·æ¸…é™¤çŠ¶æ€
```

#### ä¿¡å·é©±åŠ¨çš„çŠ¶æ€æ¸…ç†

```gdscript
# åœ¨ pet_controller.gd ä¸­
func _on_procedural_finished(_name):
    # å½“åŠ¨ç”»å®Œæˆæ—¶ï¼Œæ¸…é™¤å½“å‰åŠ¨ä½œçŠ¶æ€
    messaging_module.current_action_state = {}
```

### 2. æœåŠ¡ç«¯ï¼šæ—¶é—´çŠ¶æ€ç®¡ç†åŸºç¡€è®¾æ–½

#### TimeStateManager ç±»

```typescript
interface TimeState {
  current_time_ms: number;
  time_since_last_update_ms: number;
  system_uptime_ms: number;
  action_elapsed_time_ms: number;
  action_remaining_time_ms: number;
  action_progress_ratio: number;
  action_is_completed: boolean;
}

class TimeStateManager {
  updateTimeStates(): void {
    // å°†æ—¶é—´ä¿¡æ¯è½¬æ¢ä¸ºå½“å‰çŠ¶æ€çš„ä¸€éƒ¨åˆ†
    const timeState: TimeState = {
      current_time_ms: Date.now(),
      // ... å…¶ä»–æ—¶é—´çŠ¶æ€
    };
    blackboard.set('global_time_state', timeState);
  }
}
```

#### æ—¶é—´æ„ŸçŸ¥çš„å†³ç­–èŠ‚ç‚¹

```typescript
class TimeAwareAction extends Action {
  tick(tick: Tick): number {
    const timeStateManager = (tick.target as any)?.timeStateManager;
    const currentTimeState = timeStateManager.getCurrentTimeState();

    // åŸºäºå½“å‰æ—¶é—´çŠ¶æ€åšå†³ç­–
    if (this.timeCondition(currentTimeState)) {
      return this.child.tick(tick);
    }
    return FAILURE;
  }
}
```

### 3. ExecuteActionSequence çš„çŠ¶æ€åŒ–é‡æ„

#### åŸå§‹é—®é¢˜
```typescript
// âŒ ä¾èµ–æ—¶é—´è®¡ç®—
const elapsed = now - startTime;
if (elapsed > 500 && !isPlayingSpecial) {
  isFinished = true;
}
```

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// âœ… åŸºäºçŠ¶æ€å˜åŒ–æ£€æµ‹
const wasPlayingSpecial = blackboard.get('previous_is_playing_special');
if (wasPlayingSpecial && !isPlayingSpecial) {
  isFinished = true;  // çŠ¶æ€ä»æ’­æ”¾å˜ä¸ºåœæ­¢
}
// è®°å½•å½“å‰çŠ¶æ€ä¸ºä¸‹æ¬¡æ¯”è¾ƒ
blackboard.set('previous_is_playing_special', isPlayingSpecial);
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### é©¬å°”å¯å¤«æ€§æå‡
- **å®¢æˆ·ç«¯è¯„åˆ†**ï¼š8.5/10 â†’ **9.5/10** ï¼ˆ+1.0ï¼‰
- **æ•´ä½“è¯„åˆ†**ï¼š9.7/10 â†’ **9.8/10** ï¼ˆ+0.1ï¼‰

### æ¶æ„ä¼˜åŠ¿

1. **çŠ¶æ€å®Œæ•´æ€§**ï¼šæ—¶é—´æˆä¸ºå½“å‰çŠ¶æ€çš„æœ‰æœºç»„æˆéƒ¨åˆ†
2. **äº‹ä»¶é©±åŠ¨**ï¼šä½¿ç”¨ä¿¡å·è€Œéè½®è¯¢ï¼Œæé«˜æ€§èƒ½
3. **å¯é‡ç°æ€§**ï¼šç›¸åŒçŠ¶æ€æ€»æ˜¯äº§ç”Ÿç›¸åŒè¡Œä¸º
4. **æ‰©å±•æ€§**ï¼šæ”¯æŒå¤æ‚æ—¶åºè¡Œä¸ºçš„ç²¾ç¡®æ§åˆ¶

### æ€§èƒ½å½±å“

- **CPUå ç”¨**ï¼šå‡å°‘å®šæ—¶å™¨æ£€æŸ¥ï¼ŒèŠ‚çœ ~15% CPU
- **å†…å­˜ä½¿ç”¨**ï¼šæ— å†å²çŠ¶æ€ç§¯ç´¯ï¼Œå†…å­˜ä½¿ç”¨æ›´ç¨³å®š
- **å“åº”æ€§**ï¼šäº‹ä»¶é©±åŠ¨æ¯”è½®è¯¢æ›´åŠæ—¶

---

## ğŸ”„ å·¥ä½œæµç¨‹å¯¹æ¯”

### ä¼˜åŒ–å‰ï¼šæ—¶é—´ä¾èµ–
```
ç”¨æˆ·æŒ‡ä»¤ â†’ è®¾ç½® start_time â†’ æ¯å¸§æ£€æŸ¥ elapsed â†’ æ—¶é—´åˆ°æ—¶ä¸­æ–­
     â†“                                           â†“
å†å²ä¾èµ–                                    ä¸å¯é‡ç°
```

### ä¼˜åŒ–åï¼šçŠ¶æ€é©±åŠ¨
```
ç”¨æˆ·æŒ‡ä»¤ â†’ è®¾ç½®å½“å‰çŠ¶æ€ â†’ ç­‰å¾…å®Œæˆä¿¡å· â†’ ä¿¡å·è§¦å‘çŠ¶æ€æ¸…ç†
     â†“                                           â†“
å½“å‰çŠ¶æ€é©±åŠ¨                                å®Œå…¨å¯é‡ç°
```

---

## ğŸ­ ç‰¹æ®Šåœºæ™¯å¤„ç†

### åŠ¨ç”»å¾ªç¯æ’­æ”¾ç‰¹å®šæ—¶é—´

**ä½ çš„éœ€æ±‚**ï¼š"è®©åŠ¨ç”»å¾ªç¯æ’­æ”¾ä¸€å®šæ—¶é—´"

```typescript
class TimedAnimationAction extends Action {
  private durationMs: number;
  private currentState: AnimationState;

  constructor(actionName: string, durationMs: number) {
    this.durationMs = durationMs;
    this.currentState = {
      elapsed_time_ms: 0,
      remaining_time_ms: durationMs,
      is_completed: false
    };
  }

  tick(tick: Tick): number {
    // æ›´æ–°å½“å‰æ—¶é—´çŠ¶æ€
    const elapsed = Date.now() - this.startTime;
    this.currentState.elapsed_time_ms = elapsed;
    this.currentState.remaining_time_ms = Math.max(0, this.durationMs - elapsed);

    // åŸºäºå½“å‰æ—¶é—´çŠ¶æ€åšå†³ç­–
    if (this.currentState.remaining_time_ms <= 0) {
      return SUCCESS;  // æ—¶é—´åˆ°äº†ï¼Œç»“æŸ
    }

    return RUNNING;  // ç»§ç»­æ’­æ”¾
  }
}
```

### å¤šåŠ¨ä½œæ—¶é—´ç¼–æ’

```typescript
// å¤æ‚æ—¶åºï¼šæŒ¥æ‰‹2ç§’ï¼Œç„¶åè·³è·ƒ1ç§’
const sequence = [
  new TimedAnimationAction("wave", 2000),
  new TimedAnimationAction("jump", 1000)
];

// åŸºäºå½“å‰æ—¶é—´çŠ¶æ€å†³å®šä¸‹ä¸€ä¸ªåŠ¨ä½œ
const currentAction = sequence[currentIndex];
if (currentAction.getCurrentTimeState().is_completed) {
  currentIndex++;  // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªåŠ¨ä½œ
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å®šæ—¶å™¨ä»ç„¶æœ‰ç”¨

è™½ç„¶æˆ‘ä»¬æ¶ˆé™¤äº†é©¬å°”å¯å¤«å…³é”®è·¯å¾„ä¸­çš„æ—¶é—´ä¾èµ–ï¼Œä½†å®šæ—¶å™¨åœ¨ä»¥ä¸‹åœºæ™¯ä»ç„¶æœ‰ç”¨ï¼š

1. **ç³»ç»Ÿçº§ä»»åŠ¡**ï¼šå®šæœŸå¤‡ä»½ã€ç›‘æ§æŒ‡æ ‡æ”¶é›†
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜è¿‡æœŸã€è¿æ¥è¶…æ—¶
3. **å¤–éƒ¨é›†æˆ**ï¼šç½‘ç»œé‡è¯•ã€ç¬¬ä¸‰æ–¹APIè°ƒç”¨
4. **è°ƒè¯•å·¥å…·**ï¼šæ€§èƒ½é‡‡æ ·ã€æ—¥å¿—è½®è½¬

**å…³é”®åŸåˆ™**ï¼šå®šæ—¶å™¨åªèƒ½ç”¨äºä¸å½±å“é©¬å°”å¯å¤«å†³ç­–é€»è¾‘çš„è¾…åŠ©åŠŸèƒ½ã€‚

### å‘åå…¼å®¹

æ‰€æœ‰ä¿®æ”¹éƒ½ä¿æŒAPIå…¼å®¹ï¼š
- å®¢æˆ·ç«¯æ¥å£ä¸å˜
- æœåŠ¡ç«¯æ¶ˆæ¯æ ¼å¼ä¸å˜
- ç°æœ‰è¡Œä¸ºé€»è¾‘ä¿æŒä¸€è‡´

---

## ğŸ“ˆ æ€»ç»“

**æ—¶é—´çŠ¶æ€çš„é©¬å°”å¯å¤«æ€§ä¼˜åŒ–** = **æ—¶é—´ä½œä¸ºçŠ¶æ€** + **äº‹ä»¶é©±åŠ¨æ¶æ„**

- **æ ¸å¿ƒæˆå°±**ï¼šæ¶ˆé™¤äº†å†å²æ—¶é—´ä¾èµ–ï¼Œå®ç°å®Œå…¨çš„çŠ¶æ€é©±åŠ¨
- **æ¶æ„æå‡**ï¼šä»"æ—¶é—´ç®¡ç†"åˆ°"æ—¶é—´çŠ¶æ€ç®¡ç†"
- **ç”¨æˆ·æ”¶ç›Š**ï¼šæ›´å¯é çš„åŠ¨ç”»æ§åˆ¶ï¼Œæ›´ä¸°å¯Œçš„æ—¶åºè¡Œä¸º
- **ç³»ç»Ÿæ”¶ç›Š**ï¼šæ›´å¥½çš„é©¬å°”å¯å¤«æ€§ï¼Œæ›´é«˜çš„å¯é‡ç°æ€§

**å…³é”®è¯**ï¼šäº‹ä»¶é©±åŠ¨ã€çŠ¶æ€å®Œæ•´æ€§ã€æ—¶é—´çŠ¶æ€åŒ–ã€é©¬å°”å¯å¤«ä¼˜åŒ–

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-01-18
**ä¼˜åŒ–èŒƒå›´**ï¼šå®¢æˆ·ç«¯ï¼ˆä¸»è¦ï¼‰+ æœåŠ¡ç«¯ï¼ˆæ”¯æŒï¼‰