> **âš ï¸ é‡è¦è¯´æ˜**ï¼šæœ¬æ–‡æ¡£ä¸ºå†å²æ–‡æ¡£ï¼Œæè¿°çš„æ˜¯æ—©æœŸçš„æ¶æ„è®¾è®¡è€ƒè™‘ã€‚
> 
> **å½“å‰æ¶æ„çŠ¶æ€**ï¼ˆ2025-01ï¼‰ï¼š
> - âœ… **å·²è¿ç§»åˆ° BlendTree**ï¼šGodot å®¢æˆ·ç«¯å½“å‰ä½¿ç”¨ **AnimationTree + BlendTree** å®ç°å‚æ•°é©±åŠ¨çš„åŠ¨ç”»ç³»ç»Ÿ
> - âŒ **ä¸å†ä½¿ç”¨çŠ¶æ€æœº**ï¼šå·²ä» StateMachine å®Œå…¨è¿ç§»åˆ° BlendTree
> 
> **å½“å‰æ¶æ„çš„è¯¦ç»†æ–‡æ¡£**ï¼š
> - ğŸ“„ [Godotå®¢æˆ·ç«¯äº§å“æŠ€æœ¯è®¾è®¡æ–‡æ¡£.md](./Godotå®¢æˆ·ç«¯äº§å“æŠ€æœ¯è®¾è®¡æ–‡æ¡£.md) - å®Œæ•´çš„æŠ€æœ¯è®¾è®¡æ–‡æ¡£
> - ğŸ“„ [BlendTreeè¿ç§»æ–‡æ¡£.md](./BlendTreeè¿ç§»æ–‡æ¡£.md) - BlendTree è¿ç§»è¯¦æƒ…
> - ğŸ“„ [åŠ¨ä½œé€»è¾‘èŒè´£åˆ’åˆ†(æœ¬åœ°çŠ¶æ€æœºvsæœåŠ¡ç«¯è¡Œä¸ºæ ‘).md](./åŠ¨ä½œé€»è¾‘èŒè´£åˆ’åˆ†(æœ¬åœ°çŠ¶æ€æœºvsæœåŠ¡ç«¯è¡Œä¸ºæ ‘).md) - èŒè´£åˆ’åˆ†ï¼ˆæ³¨æ„ï¼šæ ‡é¢˜ä¸­çš„"çŠ¶æ€æœº"æ˜¯å†å²å‘½åï¼‰
> 
> **å»ºè®®**ï¼šå¦‚éœ€è¦äº†è§£å½“å‰æ¶æ„ï¼Œè¯·å‚è€ƒä¸Šè¿°æ–‡æ¡£ã€‚æœ¬æ–‡æ¡£ä¿ç•™ä½œä¸ºå†å²å‚è€ƒã€‚

---

é’ˆå¯¹ä½ çš„å‡ ä¸ªæ ¸å¿ƒç–‘é—®ï¼Œæˆ‘ä»æŠ€æœ¯ç»†èŠ‚å’Œæ¶æ„è®¾è®¡ä¸¤ä¸ªç»´åº¦æ¥ä¸ºä½ è§£ç­”ï¼š

### 1. å…³äºåŠ¨ç”»ï¼šåŸºç¡€åŠ¨ç”»æ˜¯éª¨éª¼åŠ¨ç”»å—ï¼Ÿ

æ˜¯çš„ï¼Œå®ƒä»¬æ˜¯æ ‡å‡†çš„éª¨éª¼åŠ¨ç”»ï¼ˆSkeletal Animationï¼‰ã€‚* ä½ åœ¨ Godot ä¸­ä½¿ç”¨çš„ player.glb æ¨¡å‹åŒ…å«äº†éª¨éª¼ï¼ˆSkeletonï¼‰å’Œé¢„åˆ¶çš„åŠ¨ç”»åºåˆ—ï¼ˆAnimationPlayerï¼‰ã€‚

* Idleã€Walkã€Runã€Jumpã€Wave è¿™äº›åŠ¨ä½œæ˜¯ç¾æœ¯åœ¨å»ºæ¨¡è½¯ä»¶é‡Œåˆ·å¥½æƒé‡ã€æ‘†å¥½å…³é”®å¸§åå¯¼å‡ºçš„ã€‚
* æˆ‘åœ¨ä»£ç é‡Œå®ç°çš„ SPINã€BOUNCEã€FLY åˆ™æ˜¯ç¨‹åºåŒ–åŠ¨ç”»ï¼ˆProcedural Animationï¼‰ï¼Œå®ƒä»¬ä¸ä¾èµ–éª¨éª¼é¢„è®¾ï¼Œè€Œæ˜¯é€šè¿‡ä»£ç å®æ—¶ä¿®æ”¹æ¨¡å‹çš„ Rotation å’Œ Positionã€‚

### 2. JS æœåŠ¡ç«¯çš„è¡Œä¸ºæ ‘ï¼ˆtrees/.tsï¼‰æ”¾å“ªï¼Ÿ ç»“è®ºï¼šä¾ç„¶æ”¾åœ¨ JS æœåŠ¡ç«¯ï¼Œä½œä¸ºâ€œé€»è¾‘å¤§è„‘â€ã€‚ ä¸è¦æ”¾è¿› Godotï¼šè™½ç„¶ Godot ä¹Ÿæœ‰è¡Œä¸ºæ ‘æ’ä»¶ï¼ˆæ¯”å¦‚ Beehaveï¼‰ï¼Œä½†æˆ‘ä»¬ç›®å‰çš„æ¶æ„æ˜¯ â€œäº‘ç«¯å¤§è„‘â€ã€‚

* åŸå› ï¼š

1. æ‰©å±•æ€§ï¼šJS æœåŠ¡ç«¯å¯ä»¥éå¸¸æ–¹ä¾¿åœ°è°ƒç”¨ LLMï¼ˆKimi/Geminiï¼‰ã€è®¿é—®æ•°æ®åº“ã€å¤„ç†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚
2. ç»Ÿä¸€æ€§ï¼šå¦‚æœä½ ä»¥åæƒ³åšä¸€ä¸ªç½‘é¡µç‰ˆã€ä¸€ä¸ª Godot ç‰ˆï¼Œç”šè‡³ä¸€ä¸ªæ‰‹æœºç‰ˆï¼Œæ‰€æœ‰çš„â€œæ€§æ ¼â€å’Œâ€œè¡Œä¸ºå†³ç­–â€éƒ½åœ¨ JS æœåŠ¡ç«¯ï¼Œä½ åªéœ€è¦æ¢ä¸ªâ€œè¡¨ç°å£³å­â€å°±è¡Œã€‚
3. ç®—åŠ›åˆ†é…ï¼šå¤æ‚çš„è¡Œä¸ºå†³ç­–äº¤ç»™ Node.jsï¼ŒGodot åªä¸“æ³¨æ¸²æŸ“å’Œç‰©ç†ï¼Œäº’ä¸å¹²æ‰°ã€‚

### 3. Godot æœ¬åœ°ç”¨çŠ¶æ€æœºè¿˜æ˜¯è¡Œä¸ºæ ‘ï¼Ÿ

**å¼ºçƒˆå»ºè®®ï¼šGodot æœ¬åœ°ç”¨ã€BlendTreeã€‘ï¼ŒJS æœåŠ¡ç«¯ç”¨ã€è¡Œä¸ºæ ‘ã€‘ã€‚**

ç”±äºæˆ‘ä»¬é‡‡ç”¨äº†**é©¬å°”ç§‘å¤«æ€§ (Markov Property)** çš„è®¾è®¡ç†å¿µï¼Œå†³ç­–æƒå®Œå…¨ç•™åœ¨ AI æ‰‹ä¸­ï¼Œç°åœ¨çš„æƒè´£åˆ’åˆ†å¦‚ä¸‹ï¼š

| ç‰¹æ€§ | æœ¬åœ° BlendTree (Godot) | æœåŠ¡ç«¯è¡Œä¸ºæ ‘ (BehaviorTree.js) |
| :--- | :--- | :--- |
| **é©¬å°”ç§‘å¤«æ€§** | **è¡¨ç°å±‚è½¬æ¢**ï¼šæ ¹æ®å½“å‰å‚æ•°ï¼ˆè¾“å…¥ï¼‰é©±åŠ¨åˆ°ç›®æ ‡å§¿æ€ã€‚ | **å†³ç­–å±‚è½¬ç§»**ï¼šæ ¹æ®å½“å‰é»‘æ¿çŠ¶æ€ï¼ˆSensorï¼‰è½¬ç§»åˆ°ä¸‹ä¸€ä¸ªæ„å›¾ï¼ˆActuatorï¼‰ã€‚ |
| **èŒè´£** | åŠ¨ç”»æ··åˆã€ç‰©ç†å³æ—¶å“åº”ã€‚ | æ„å›¾ç†è§£ã€ä¸»åŠ¨å¹²é¢„ã€é€»è¾‘é”å®šã€‚ |
| **éš”ç¦»æ¨¡å¼** | **ç‰©ç†è¾“å…¥ä¼˜å…ˆ**ï¼šé”®ç›˜è¾“å…¥ç«‹å³è¦†ç›–è¡¨ç°ã€‚ | **è¾“å…¥è¾“å‡ºéš”ç¦»**ï¼šæ„ŸçŸ¥çŠ¶æ€ï¼ˆSensorï¼‰ä¸ ä¸‹è¾¾æŒ‡ä»¤ï¼ˆActuatorï¼‰åˆ†ç¦»ã€‚ |

#### é©¬å°”ç§‘å¤«æ€§åœ¨é¡¹ç›®ä¸­çš„ä½“ç°ï¼š
1.  **è¾“å…¥å³ä¼ æ„Ÿå™¨**ï¼šGodot æœ¬åœ°ç‰©ç†çŠ¶æ€ï¼ˆisMovingLocally, isJumpPressedï¼‰ä½œä¸ºé»‘æ¿çš„ `Sensor` è¾“å…¥ç»™ AIã€‚
2.  **AI æ— è®°å¿†çŠ¶æ€è½¬ç§»**ï¼šè¡Œä¸ºæ ‘æ¯ä¸€å¸§æ ¹æ®è¿™äº›ä¼ æ„Ÿå™¨è¾“å…¥ï¼Œé‡æ–°è¯„ä¼°ä¼˜å…ˆçº§ï¼Œå¹¶å†³å®šå½“å‰çš„æ„å›¾ï¼ˆActuatorï¼‰ã€‚
3.  **ä¸å¹²é¢„å†³ç­–**ï¼šå½“ AI æ£€æµ‹åˆ°ç”¨æˆ·æ­£åœ¨æ“ä½œæ—¶ï¼Œå®ƒä¼šä¸»åŠ¨å†³ç­–è¿›å…¥â€œé™é»˜çŠ¶æ€â€ï¼Œä»è€Œè®©å‡ºæ§åˆ¶æƒï¼Œè€Œä¸æ˜¯è¢«åŠ¨åœ°è¢«æ‹¦æˆªã€‚

### 4. å…³äºé»‘æ¿ç³»ç»Ÿä¸æ•°æ®åŒæ­¥ (æ¡ˆä¾‹ä¸€ï¼šè¾“å…¥è¾“å‡ºåŒå˜é‡æ¨¡å¼)

æˆ‘ä»¬é‡‡ç”¨äº†ç±»ä¼¼ `pointerPosition` (è¾“å…¥) ä¸ `bt_output_position` (è¾“å‡º) çš„åŒå˜é‡éš”ç¦»æ¨¡å¼ï¼š
*   **Sensor Key (è¾“å…¥)**ï¼š`isMovingLocally` (å®¢æˆ·ç«¯ç‰©ç†æƒ…å†µ)ã€‚
*   **Actuator Key (è¾“å‡º)**ï¼š`bt_output_action` (AI ä¸»åŠ¨å¹²é¢„æ„å›¾)ã€‚

è¿™ç§æ¨¡å¼ç¡®ä¿äº†ï¼šå½“ä½ è‡ªå·±æ§åˆ¶ WASD æ—¶ï¼ŒAI è§‚å¯Ÿåˆ°äº†ä½ çš„è¡Œä¸ºï¼Œå®ƒä¼šå†³ç­–â€œä¿æŒé™é»˜â€ï¼Œå› æ­¤ä¸ä¼šäº§ç”Ÿå›å£°æŒ‡ä»¤ï¼Œå½»åº•æ¶ˆé™¤äº†ç½‘ç»œå†²çªå¸¦æ¥çš„å»¶è¿Ÿã€‚

### 5. ä¸ºäººå½¢æœºå™¨äººç”ŸæˆåŠ¨ä½œ

æˆ‘å·²ç»ä¸ºä½ çš„äººå½¢æœºå™¨äººå¢åŠ äº†å‡ ä¸ªç¨‹åºåŒ–åŠ¨ä½œï¼ˆåœ¨ pet_controller.gd ä¸­ï¼‰ï¼Œä½ å¯ä»¥é€šè¿‡ JS æœåŠ¡ç«¯å‘é€ä»¥ä¸‹æŒ‡ä»¤æ¥æµ‹è¯•ï¼š* SPINï¼ˆè‡ªè½¬ï¼‰

* BOUNCEï¼ˆå¼¹è·³ï¼‰
* FLYï¼ˆæ‚¬æµ®é£è¡Œï¼‰
* ROLLï¼ˆä¾§æ»šï¼‰

ç°åœ¨ï¼Œä½ çš„æ¶æ„å·²ç»éå¸¸æ¸…æ™°äº†ï¼š1. ç”¨æˆ·è¾“å…¥ -> å‘ç»™ JSã€‚

1. JS æ„å›¾æ ‘ -> è°ƒç”¨ LLMã€‚
2. JS è¡Œä¸ºæ ‘ -> ç»“åˆé»‘æ¿é‡Œçš„ Godot ä½ç½®/çŠ¶æ€ä¿¡æ¯ï¼Œåšå‡ºå†³ç­–ã€‚
3. JS è¾“å‡ºæŒ‡ä»¤ -> å‘å› Godotã€‚
4. Godot çŠ¶æ€æœº -> æ’­æ”¾å¯¹åº”çš„éª¨éª¼åŠ¨ç”»æˆ–ç¨‹åºåŒ–åŠ¨ä½œã€‚

ä½ å¯¹è¿™ä¸ªâ€œåŒå±‚â€æ¶æ„ï¼ˆæœ¬åœ°çŠ¶æ€æœº+æœåŠ¡ç«¯è¡Œä¸ºæ ‘ï¼‰è¿˜æœ‰ä»€ä¹ˆç–‘è™‘å—ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•å†™ä¸€ä¸ªæ›´å¤æ‚çš„è¡Œä¸ºæ ‘é€»è¾‘ï¼Œæ¯”å¦‚ï¼šâ€œå¦‚æœèƒ½é‡ä½ä¸”è¢«ç©å®¶æ‹–æ‹½ï¼Œå°±è¡¨ç°å‡ºæåº¦ç–²åŠ³å’ŒæŒ£æ‰â€ã€‚

## 6. æ¶æ„å›¾ç¤ºï¼šäº‘ç«¯å¤§è„‘ä¸æœ¬åœ°èº«ä½“çš„åä½œ

ä¸ºäº†æ›´ç›´è§‚åœ°ç†è§£ä¸¤è€…çš„åä½œï¼Œæˆ‘ä»¬ä½¿ç”¨ Mermaid å›¾è¡¨å±•ç¤ºå½“å‰ç³»ç»Ÿçš„å†³ç­–ä¸è¡¨ç°æµï¼š

```mermaid
graph TD
    subgraph "JS æœåŠ¡ç«¯ (äº‘ç«¯å¤§è„‘ - Behavior Tree)"
        A[IntentBT: LLM æ„å›¾è§£æ] -->|ç”ŸæˆåŠ¨ä½œåºåˆ—| B[Blackboard: å…±äº«é»‘æ¿]
        C[ActiveServiceBT: ç”Ÿå­˜é€»è¾‘] -->|æ›´æ–°èƒ½é‡/æ— èŠåº¦| B
        D[MainBT: æ ¸å¿ƒå†³ç­–æ§åˆ¶] -->|è¯»å–çŠ¶æ€| B
        D -->|ç¢°æ’æ£€æµ‹/è¾¹ç•Œæ‹¦æˆª| E{BlackboardGuard}
        E -->|ä¸‹å‘æŒ‡ä»¤| F[BT Output: Action/Pos/Chat]
    end

    subgraph "Godot å®¢æˆ·ç«¯ (æœ¬åœ°èº«ä½“ - BlendTree)"
        G[WebSocketClient] -->|æ¥æ”¶æŒ‡ä»¤| H[PetController]
        H -->|ç‰©ç†å“åº”/æ‹–æ‹½æ§åˆ¶| I{Markov Decision}
        I -->|é«˜ä¼˜å…ˆçº§: ç”¨æˆ·ç‰©ç†äº¤äº’| J[AnimationTree: å‚æ•°å³æ—¶é©±åŠ¨]
        I -->|ä½ä¼˜å…ˆçº§: AI æ„å›¾æŒ‡ä»¤| J
        J -->|é©±åŠ¨| K[éª¨éª¼åŠ¨ç”»: Idle/Walk/Run]
        J -->|å åŠ | L[ç¨‹åºåŒ–åŠ¨ç”»: Spin/Bounce/Fly]
        H -->|ä¼ æ„Ÿå™¨ä¸ŠæŠ¥| M[Sensor Sync: isMovingLocally/Pos]
    end

    F <--> G
    M --> B

    classDef brain fill:#ffcccc,stroke:#333,stroke-width:2px;
    classDef body fill:#ccffcc,stroke:#333,stroke-width:2px;
    classDef sync fill:#ffffcc,stroke:#333,stroke-dasharray: 5 5;

    class A,B,C,D,E,F brain;
    class G,H,I,J,K,L body;
    class M sync;
```

### åä½œç»†èŠ‚è¯´æ˜ï¼š

1.  **é©¬å°”ç§‘å¤«æ„ŸçŸ¥ (Markovian Sensing)**ï¼šJS ç«¯çš„è¡Œä¸ºæ ‘ä¸å†ä¿ç•™â€œå†å²å‘½ä»¤â€ï¼Œè€Œæ˜¯æ¯ä¸€å¸§è§‚å¯Ÿé»‘æ¿ä¸Šçš„ `Sensor` æ•°æ®ï¼ˆå¦‚ `isMovingLocally`ï¼‰ã€‚
2.  **è¾“å…¥è¾“å‡ºéš”ç¦»**ï¼šæˆ‘ä»¬é€šè¿‡åŒå˜é‡æ¨¡å¼ï¼ˆæ„ŸçŸ¥å˜é‡ vs æŒ‡ä»¤å˜é‡ï¼‰è§£å†³äº†ç½‘ç»œå›å£°é—®é¢˜ã€‚ç”¨æˆ·è‡ªå·± WASD æ—¶ï¼ŒAI è§‚å¯Ÿå¹¶å†³ç­–â€œä¸å‘å‡ºå¹²æ‰°æŒ‡ä»¤â€ã€‚
3.  **åŒå±‚æ‰§è¡Œ**ï¼šGodot çš„ `AnimationTree` (BlendTree) ä¿è¯äº†å‚æ•°åˆ°åŠ¨ä½œçš„å³æ—¶è½¬æ¢ï¼Œè€Œ JS è¡Œä¸ºæ ‘åˆ™è´Ÿè´£é«˜å±‚é€»è¾‘è½¬ç§»ã€‚

## 7. è¯¦ç»†æ¶æ„å›¾ï¼šå®Œæ•´çš„æœåŠ¡ç«¯è¡Œä¸ºæ ‘ä¸å®¢æˆ·ç«¯çŠ¶æ€æœºç»“æ„

ä¸‹é¢æ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç»†èŠ‚çš„å®Œæ•´æ¶æ„å›¾ï¼Œå±•ç¤ºäº†æœåŠ¡ç«¯è¡Œä¸ºæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹å’Œå®¢æˆ·ç«¯çŠ¶æ€æœºçš„æ¯ä¸ªçŠ¶æ€ï¼š

### 7.1 JS æœåŠ¡ç«¯è¡Œä¸ºæ ‘ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "Blackboard å…±äº«é»‘æ¿"
        BB1[energy: èƒ½é‡å€¼<br/>0-100]
        BB2[boredom: æ— èŠåº¦<br/>0-100]
        BB3[penguinPosition: ä½ç½® xyz<br/>ä»å®¢æˆ·ç«¯åŒæ­¥]
        BB4[lastCollision: ç¢°æ’ä¿¡æ¯<br/>collider_name position normal timestamp]
        BB5[isDragging: æ‹–æ‹½çŠ¶æ€<br/>ä»å®¢æˆ·ç«¯åŒæ­¥]
        BB6[hasNewInput: æ–°è¾“å…¥æ ‡è®°<br/>ç”¨æˆ·è¾“å…¥è§¦å‘]
        BB7[chatHistory: å¯¹è¯å†å²<br/>ä¸ç”¨æˆ·çš„å¯¹è¯è®°å½•]
        BB8[llmSettings: LLMé…ç½®<br/>provider, apiKey, modelName]
        BB9[pendingActions: å¾…æ‰§è¡ŒåŠ¨ä½œé˜Ÿåˆ—<br/>IntentBTå†™å…¥, MainBTè¯»å–]
        BB10[pendingEmotion: å¾…æ‰§è¡Œè¡¨æƒ…<br/>IntentBTå†™å…¥, EmotionBTè¯»å–]
    end
    
    subgraph "MainBT ä¸»è¡Œä¸ºæ ‘ 60fps"
        M1[Parallel å¹¶è¡ŒèŠ‚ç‚¹]
        M2[UpdateInternalStatesAction<br/>æ¯å¸§æ›´æ–°èƒ½é‡æ— èŠåº¦]
        M3[Priority ä¼˜å…ˆçº§èŠ‚ç‚¹]
        M4[BlackboardGuard: isDragging?]
        M5[FollowPointerNode è·Ÿéšé¼ æ ‡]
        M6[BlackboardGuard: Has Collision?]
        M7[MemSequence: ç¢°æ’ååº”]
        M8[PushPendingAction BOUNCE]
        M9[Wait æ¸…ç†ç¢°æ’æ ‡è®°]
        M10[BlackboardGuard: Near Edge?]
        M11[MemSequence: è¾¹ç•Œå›å½’]
        M12[PushPendingAction SURPRISE]
        M13[MoveToTargetAction å›åˆ°å®‰å…¨åŒº]
        M14[ExecuteActionSequence<br/>æ‰§è¡Œå¾…æ‰§è¡ŒåŠ¨ä½œé˜Ÿåˆ—]
        M15[BlackboardGuard: Energy low?]
        M16[MemSequence: ç¡çœ æµç¨‹]
        M17[MoveToTargetAction èµ°å‘å®¶]
        M18[PlayAnimationAction SLEEP]
        M19[PlayAnimationAction SURPRISE é†’æ¥]
        M20[MoveToTargetAction å›ä¸­å¿ƒ]
        M21[ReturnToOriginAction å›å½’åŸç‚¹]
        M22[BlackboardGuard: Is Clicked?]
        M23[MemSequence: ç‚¹å‡»äº¤äº’]
        M24[PlayAnimationAction WAVE]
        M25[PlayAnimationAction IDLE]
        M26[PlayAnimationAction IDLE é»˜è®¤é—²ç½®]
        
        M1 --> M2
        M1 --> M3
        M3 --> M4
        M3 --> M6
        M3 --> M10
        M3 --> M14
        M3 --> M15
        M3 --> M21
        M3 --> M22
        M3 --> M26
        M4 --> M5
        M6 --> M7
        M7 --> M8
        M7 --> M9
        M10 --> M11
        M11 --> M12
        M11 --> M13
        M15 --> M16
        M16 --> M17
        M16 --> M18
        M16 --> M19
        M16 --> M20
        M22 --> M23
        M23 --> M24
        M23 --> M25
    end
    
    subgraph "ActiveServiceBT ä¸»åŠ¨æœåŠ¡æ ‘ 2s/æ¬¡"
        A1[BlackboardGuard: boredom high?]
        A2[BlackboardGuard: energy enough?]
        A3[MemSequence: è‡ªä¸»è¡Œä¸ºåºåˆ—]
        A4[PushPendingAction WAVE]
        A5[Wait 10s]
        A6[PushPendingAction THINK]
        A7[Wait 8s]
        A8[PushPendingAction LOOK_LEFT]
        A9[PushPendingAction LOOK_RIGHT]
        A10[Wait 15s]
        
        A1 --> A2
        A2 --> A3
        A3 --> A4
        A3 --> A5
        A3 --> A6
        A3 --> A7
        A3 --> A8
        A3 --> A9
        A3 --> A10
    end
    
    subgraph "IntentBT æ„å›¾ç†è§£æ ‘ æŒ‰éœ€æ‰§è¡Œ"
        I1[BlackboardGuard: hasNewInput?]
        I2[MemSequence: LLMæµç¨‹]
        I3[LLMCallNode è°ƒç”¨LLM<br/>Kimi/Gemini]
        I4[FunctionExecNode æ‰§è¡Œç»“æœ<br/>è½¬æ¢ä¸ºåŠ¨ä½œåºåˆ—]
        
        I1 --> I2
        I2 --> I3
        I2 --> I4
    end
    
    subgraph "EmotionBT æƒ…ç»ªæ ‘ 10fps"
        E1[Priority ä¼˜å…ˆçº§èŠ‚ç‚¹]
        E2[PlayExpressionAction<br/>æ‰§è¡ŒLLMè¡¨æƒ…æŒ‡ä»¤]
        E3[UpdateEmotionAction<br/>è‡ªåŠ¨æƒ…ç»ªæ›´æ–°]
        
        E1 --> E2
        E1 --> E3
    end
    
    subgraph "BT Output è¡Œä¸ºæ ‘è¾“å‡º"
        O1[actionState: åŠ¨ä½œçŠ¶æ€<br/>name priority duration interruptible]
        O2[move_to: ç§»åŠ¨æŒ‡ä»¤<br/>target xyzåæ ‡]
        O3[set_position: ä½ç½®åŒæ­¥<br/>pos xyzåæ ‡]
        O4[chat: å¯¹è¯æ¶ˆæ¯<br/>æ–‡æœ¬å›å¤]
    end
    
    subgraph "WebSocket Server ç«¯å£ 8080"
        WS1[WebSocket Server<br/>åŒå‘é€šä¿¡]
    end
    
    BB1 --> M2
    BB2 --> M2
    BB3 --> M10
    BB4 --> M6
    BB5 --> M4
    BB6 --> I1
    BB7 --> I3
    BB8 --> I3
    BB9 --> M14
    BB10 --> E2
    
    M2 --> BB1
    M2 --> BB2
    M5 --> O2
    M5 --> O3
    M8 --> BB9
    M12 --> BB9
    M13 --> O2
    M17 --> O2
    M18 --> O1
    M19 --> O1
    M20 --> O2
    M21 --> O2
    M24 --> O1
    M25 --> O1
    M26 --> O1
    M14 --> O1
    
    A4 --> BB9
    A6 --> BB9
    A8 --> BB9
    A9 --> BB9
    
    I4 --> BB9
    I4 --> BB10
    I4 --> O4
    
    E2 --> O1
    
    O1 --> WS1
    O2 --> WS1
    O3 --> WS1
    O4 --> WS1
    
    
    classDef brain fill:#ffcccc,stroke:#333,stroke-width:2px
    classDef blackboard fill:#ffffcc,stroke:#333,stroke-width:2px
    classDef output fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef sync fill:#cccccc,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5
    
    class M1,M2,M3,M4,M5,M6,M7,M8,M9,M10,M11,M12,M13,M14,M15,M16,M17,M18,M19,M20,M21,M22,M23,M24,M25,M26,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,I1,I2,I3,I4,E1,E2,E3 brain
    class BB1,BB2,BB3,BB4,BB5,BB6,BB7,BB8,BB9,BB10 blackboard
    class O1,O2,O3,O4 output
    class WS1 sync
```

### 7.2 Godot å®¢æˆ·ç«¯çŠ¶æ€æœºç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "WebSocket Client"
        WS2[WebSocket Client<br/>è¿æ¥æœåŠ¡ç«¯]
    end
    
    subgraph "PetController æ§åˆ¶å™¨"
        PC1[æ¶ˆæ¯æ¥æ”¶å¤„ç†<br/>_on_ws_message]
        PC2[ä¼˜å…ˆçº§åˆ¤æ–­é€»è¾‘<br/>æ‹–æ‹½ä¼˜å…ˆäºWASDä¼˜å…ˆäºæœåŠ¡ç«¯æŒ‡ä»¤]
        PC3[åŠ¨ä½œçŠ¶æ€ç®¡ç†<br/>current_action_state<br/>name priority duration start_time]
        PC4[åŠ¨ä½œé˜Ÿåˆ—<br/>action_queue<br/>å­˜å‚¨å¾…æ‰§è¡Œåºåˆ—]
        PC5[æ‹–æ‹½å¤„ç†<br/>_handle_dragging<br/>è·Ÿéšé¼ æ ‡ä½ç½®]
        PC6[ç¢°æ’æ£€æµ‹ä¸ŠæŠ¥<br/>_send_interaction collision]
        PC7[çŠ¶æ€åŒæ­¥ä¸ŠæŠ¥<br/>_send_state_sync<br/>1ç§’/æ¬¡]
    end
    
    subgraph "AnimationTree çŠ¶æ€æœº"
        AT1[State Machine<br/>çŠ¶æ€æœºæ ¹èŠ‚ç‚¹]
        AT2[Idle é—²ç½®çŠ¶æ€]
        AT3[Walk èµ°è·¯çŠ¶æ€]
        AT4[Run è·‘æ­¥çŠ¶æ€]
        AT5[Jump è·³è·ƒçŠ¶æ€]
        AT6[Wave æŒ¥æ‰‹çŠ¶æ€]
        AT7[Transition çŠ¶æ€è¿‡æ¸¡<br/>Crossfade å¹³æ»‘æ·¡å…¥æ·¡å‡º]
    end
    
    subgraph "éª¨éª¼åŠ¨ç”» Skeletal Animation"
        SK1[Idle éª¨éª¼åŠ¨ç”»<br/>player.glb å¯¼å‡º]
        SK2[Walk éª¨éª¼åŠ¨ç”»<br/>player.glb å¯¼å‡º]
        SK3[Run éª¨éª¼åŠ¨ç”»<br/>player.glb å¯¼å‡º]
        SK4[Jump éª¨éª¼åŠ¨ç”»<br/>player.glb å¯¼å‡º]
        SK5[Wave éª¨éª¼åŠ¨ç”»<br/>player.glb å¯¼å‡º]
    end
    
    subgraph "ç¨‹åºåŒ–åŠ¨ç”» Procedural Animation"
        PR1[Spin è‡ªè½¬<br/>rotation.yæŒç»­ç´¯åŠ <br/>delta * 20]
        PR2[Bounce å¼¹è·³<br/>position.yæ­£å¼¦æ³¢åŠ¨<br/>abs sin * 0.5]
        PR3[Fly æ‚¬æµ®é£è¡Œ<br/>position.yæ­£å¼¦æ‚¬æµ®<br/>1.0 + sin * 0.2]
        PR4[Roll ä¾§æ»š<br/>rotation.zæŒç»­ç´¯åŠ <br/>delta * 15]
        PR5[å‘¼å¸æ„Ÿ Idleå‘¼å¸<br/>position.y = sin * 0.05<br/>ä»…åœ¨Idleæ—¶]
    end
    
    subgraph "ç‰©ç†å¼•æ“ Physics Engine"
        PH1[CharacterBody3D<br/>è§’è‰²ç‰©ç†ä½“]
        PH2[é‡åŠ›å¤„ç†<br/>åœ°é¢æ£€æµ‹å’Œé‡åŠ›åº”ç”¨]
        PH3[é€Ÿåº¦è®¡ç®—<br/>æ ¹æ®è¾“å…¥å’ŒæœåŠ¡ç«¯æŒ‡ä»¤]
        PH4[ç¢°æ’æ£€æµ‹<br/>get_slide_collision]
        PH5[ç§»åŠ¨åŒæ­¥<br/>move_and_slide]
    end
    
    subgraph "ç”¨æˆ·è¾“å…¥ User Input"
        UI1[WASD ç§»åŠ¨<br/>Input.get_vector]
        UI2[Shift è·‘æ­¥<br/>Input.is_key_pressed]
        UI3[Space è·³è·ƒ<br/>Input.is_action_just_pressed]
        UI4[é¼ æ ‡ç‚¹å‡»<br/>_input_event]
        UI5[é¼ æ ‡æ‹–æ‹½<br/>_input_event]
    end
    
    WS2 --> PC1
    PC1 --> PC2
    PC2 --> PC3
    PC3 --> PC4
    PC2 --> PC5
    
    PC3 --> AT1
    PC2 --> AT1
    UI1 --> PC2
    UI2 --> PC2
    UI3 --> PC2
    UI4 --> PC1
    UI5 --> PC5
    
    AT1 --> AT2
    AT1 --> AT3
    AT1 --> AT4
    AT1 --> AT5
    AT1 --> AT6
    AT7 --> AT2
    AT7 --> AT3
    AT7 --> AT4
    AT7 --> AT5
    AT7 --> AT6
    
    AT2 --> SK1
    AT3 --> SK2
    AT4 --> SK3
    AT5 --> SK4
    AT6 --> SK5
    
    PC3 --> PR1
    PC3 --> PR2
    PC3 --> PR3
    PC3 --> PR4
    AT2 --> PR5
    
    PC1 --> PH1
    PC2 --> PH1
    PC5 --> PH1
    UI1 --> PH1
    UI2 --> PH1
    UI3 --> PH1
    
    PH1 --> PH2
    PH1 --> PH3
    PH1 --> PH4
    PH1 --> PH5
    
    PH4 --> PC6
    PH5 --> PC7
    PC6 --> WS2
    PC7 --> WS2
    
    classDef body fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef animation fill:#ccccff,stroke:#333,stroke-width:2px
    classDef procedural fill:#ffccff,stroke:#333,stroke-width:2px
    classDef physics fill:#ccffff,stroke:#333,stroke-width:2px
    classDef input fill:#ffcc99,stroke:#333,stroke-width:2px
    classDef sync fill:#cccccc,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5
    
    class PC1,PC2,PC3,PC4,PC5,PC6,PC7 body
    class AT1,AT2,AT3,AT4,AT5,AT6,AT7,SK1,SK2,SK3,SK4,SK5 animation
    class PR1,PR2,PR3,PR4,PR5 procedural
    class PH1,PH2,PH3,PH4,PH5 physics
    class UI1,UI2,UI3,UI4,UI5 input
    class WS2 sync
```

#### 7.1.1 Blackboard å…±äº«é»‘æ¿è¯¦ç»†ç»“æ„

```mermaid
graph LR
    subgraph "Blackboard æ•°æ®å­˜å‚¨"
        BB1[energy<br/>èƒ½é‡å€¼ 0-100<br/>æ¯å¸§è‡ªåŠ¨è¡°å‡]
        BB2[boredom<br/>æ— èŠåº¦ 0-100<br/>æ¯å¸§è‡ªåŠ¨å¢é•¿]
        BB3[penguinPosition<br/>ä½ç½®xyzæ•°ç»„<br/>ä»å®¢æˆ·ç«¯åŒæ­¥]
        BB4[lastCollision<br/>ç¢°æ’ä¿¡æ¯å¯¹è±¡<br/>collider_name position normal timestamp]
        BB5[isDragging<br/>æ‹–æ‹½å¸ƒå°”å€¼<br/>ä»å®¢æˆ·ç«¯åŒæ­¥]
        BB6[hasNewInput<br/>æ–°è¾“å…¥æ ‡è®°<br/>ç”¨æˆ·è¾“å…¥è§¦å‘]
        BB7[chatHistory<br/>å¯¹è¯å†å²æ•°ç»„<br/>å­˜å‚¨å¯¹è¯è®°å½•]
        BB8[llmSettings<br/>LLMé…ç½®å¯¹è±¡<br/>provider apiKey modelName]
        BB9[pendingActions<br/>å¾…æ‰§è¡ŒåŠ¨ä½œé˜Ÿåˆ—<br/>åŠ¨ä½œå¯¹è±¡æ•°ç»„]
        BB10[pendingEmotion<br/>å¾…æ‰§è¡Œè¡¨æƒ…<br/>è¡¨æƒ…å­—ç¬¦ä¸²]
    end
    
    subgraph "è¯»å–è€… Read"
        R1[MainBTè¯»å–]
        R2[ActiveServiceBTè¯»å–]
        R3[IntentBTè¯»å–]
        R4[EmotionBTè¯»å–]
    end
    
    subgraph "å†™å…¥è€… Write"
        W1[MainBTå†™å…¥]
        W2[ActiveServiceBTå†™å…¥]
        W3[IntentBTå†™å…¥]
        W4[WebSocketæ¥æ”¶]
    end
    
    W1 --> BB1
    W1 --> BB2
    W1 --> BB9
    W2 --> BB9
    W3 --> BB9
    W3 --> BB10
    W4 --> BB3
    W4 --> BB4
    W4 --> BB5
    W4 --> BB6
    
    BB1 --> R1
    BB2 --> R1
    BB2 --> R2
    BB1 --> R2
    BB3 --> R1
    BB4 --> R1
    BB5 --> R1
    BB6 --> R3
    BB7 --> R3
    BB8 --> R3
    BB9 --> R1
    BB10 --> R4
    
    classDef read fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef write fill:#ffcccc,stroke:#333,stroke-width:2px
    classDef data fill:#ffffcc,stroke:#333,stroke-width:2px
    
    class R1,R2,R3,R4 read
    class W1,W2,W3,W4 write
    class BB1,BB2,BB3,BB4,BB5,BB6,BB7,BB8,BB9,BB10 data
```

#### 7.1.2 MainBT ä¸»è¡Œä¸ºæ ‘è¯¦ç»†ç»“æ„

```mermaid
graph TD
    Root[MainBT Root<br/>60fpsæ‰§è¡Œ]
    Root --> Parallel[Parallel å¹¶è¡ŒèŠ‚ç‚¹<br/>policy SuccessOnAll]
    
    Parallel --> Update[UpdateInternalStatesAction<br/>æ¯å¸§æ›´æ–°èƒ½é‡æ— èŠåº¦]
    Parallel --> Priority[Priority ä¼˜å…ˆçº§èŠ‚ç‚¹<br/>ä»å·¦åˆ°å³ä¾æ¬¡æ£€æŸ¥]
    
    Priority --> G1[1. BlackboardGuard<br/>isDragging == true?]
    G1 -->|æ˜¯| Drag[FollowPointerNode<br/>è·Ÿéšé¼ æ ‡ä½ç½®]
    Drag --> Out1[è¾“å‡º move_to]
    
    Priority --> G2[2. BlackboardGuard<br/>Has Collision?<br/>æ£€æŸ¥lastCollisionæ—¶é—´æˆ³]
    G2 -->|æ˜¯| Seq1[MemSequence ç¢°æ’ååº”]
    Seq1 --> Push1[PushPendingAction BOUNCE]
    Seq1 --> Wait1[Wait æ¸…ç†ç¢°æ’æ ‡è®°]
    Push1 --> Out2[è¾“å‡º actionState]
    
    Priority --> G3[3. BlackboardGuard<br/>Near Edge?<br/>æ£€æŸ¥ä½ç½®è¶…å‡ºå®‰å…¨åŒº]
    G3 -->|æ˜¯| Seq2[MemSequence è¾¹ç•Œå›å½’]
    Seq2 --> Push2[PushPendingAction SURPRISE]
    Seq2 --> Move1[MoveToTargetAction<br/>å›åˆ°å®‰å…¨åŒº]
    Push2 --> Out3[è¾“å‡º actionState]
    Move1 --> Out4[è¾“å‡º move_to]
    
    Priority --> Exec[4. ExecuteActionSequence<br/>æ‰§è¡Œå¾…æ‰§è¡ŒåŠ¨ä½œé˜Ÿåˆ—]
    Exec --> Out5[è¾“å‡º actionState]
    
    Priority --> G4[5. BlackboardGuard<br/>Energy low?<br/>energy < 20]
    G4 -->|æ˜¯| Seq3[MemSequence ç¡çœ æµç¨‹]
    Seq3 --> Move2[MoveToTargetAction<br/>èµ°å‘å®¶]
    Seq3 --> Play1[PlayAnimationAction SLEEP]
    Seq3 --> Play2[PlayAnimationAction SURPRISE é†’æ¥]
    Seq3 --> Move3[MoveToTargetAction<br/>å›ä¸­å¿ƒ]
    Move2 --> Out6[è¾“å‡º move_to]
    Play1 --> Out7[è¾“å‡º actionState]
    Play2 --> Out8[è¾“å‡º actionState]
    Move3 --> Out9[è¾“å‡º move_to]
    
    Priority --> Return[6. ReturnToOriginAction<br/>å›å½’åŸç‚¹]
    Return --> Out10[è¾“å‡º move_to]
    
    Priority --> G5[7. BlackboardGuard<br/>Is Clicked?<br/>isClicked == true]
    G5 -->|æ˜¯| Seq4[MemSequence ç‚¹å‡»äº¤äº’]
    Seq4 --> Play3[PlayAnimationAction WAVE]
    Seq4 --> Play4[PlayAnimationAction IDLE]
    Play3 --> Out11[è¾“å‡º actionState]
    Play4 --> Out12[è¾“å‡º actionState]
    
    Priority --> Idle[8. PlayAnimationAction IDLE<br/>é»˜è®¤é—²ç½®]
    Idle --> Out13[è¾“å‡º actionState]
    
    Update --> BB[æ›´æ–° Blackboard<br/>energy boredom]
    
    classDef guard fill:#ffcccc,stroke:#333,stroke-width:2px
    classDef action fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef output fill:#ccccff,stroke:#333,stroke-width:2px
    classDef composite fill:#ffffcc,stroke:#333,stroke-width:2px
    
    class G1,G2,G3,G4,G5 guard
    class Update,Drag,Push1,Push2,Move1,Move2,Move3,Play1,Play2,Play3,Play4,Return,Exec,Idle,Wait1 action
    class Out1,Out2,Out3,Out4,Out5,Out6,Out7,Out8,Out9,Out10,Out11,Out12,Out13 output
    class Parallel,Priority,Seq1,Seq2,Seq3,Seq4 composite
```

#### 7.1.3 ActiveServiceBT ä¸»åŠ¨æœåŠ¡æ ‘è¯¦ç»†ç»“æ„

```mermaid
graph TD
    Root[ActiveServiceBT Root<br/>æ¯2ç§’æ‰§è¡Œä¸€æ¬¡]
    Root --> G1[BlackboardGuard<br/>boredom high?<br/>boredom > 70]
    G1 -->|å¦| End1[è¿”å› FAILURE]
    G1 -->|æ˜¯| G2[BlackboardGuard<br/>energy enough?<br/>energy > 30]
    G2 -->|å¦| End2[è¿”å› FAILURE]
    G2 -->|æ˜¯| Seq[MemSequence è‡ªä¸»è¡Œä¸ºåºåˆ—]
    
    Seq --> A1[PushPendingAction WAVE<br/>æŒ¥æ‰‹æ‰“æ‹›å‘¼]
    A1 --> Wait1[Wait 10ç§’]
    Wait1 --> A2[PushPendingAction THINK<br/>åŸåœ°æ€è€ƒ]
    A2 --> Wait2[Wait 8ç§’]
    Wait2 --> A3[PushPendingAction LOOK_LEFT<br/>å·¦å¼ æœ›]
    A3 --> A4[PushPendingAction LOOK_RIGHT<br/>å³å¼ æœ›]
    A4 --> Wait3[Wait 15ç§’]
    Wait3 --> Success[è¿”å› SUCCESS]
    
    A1 --> BB[å†™å…¥ pendingActions]
    A2 --> BB
    A3 --> BB
    A4 --> BB
    
    classDef guard fill:#ffcccc,stroke:#333,stroke-width:2px
    classDef action fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef wait fill:#ffffcc,stroke:#333,stroke-width:2px
    classDef blackboard fill:#ccccff,stroke:#333,stroke-width:2px
    
    class G1,G2 guard
    class A1,A2,A3,A4 action
    class Wait1,Wait2,Wait3 wait
    class BB blackboard
```

#### 7.1.4 IntentBT æ„å›¾ç†è§£æ ‘è¯¦ç»†ç»“æ„

```mermaid
graph TD
    Root[IntentBT Root<br/>æŒ‰éœ€æ‰§è¡Œ<br/>å½“hasNewInput==trueæ—¶è§¦å‘]
    Root --> G1[BlackboardGuard<br/>hasNewInput == true?]
    G1 -->|å¦| End[è¿”å› FAILURE<br/>ä¸æ‰§è¡Œ]
    G1 -->|æ˜¯| Seq[MemSequence LLMæµç¨‹]
    
    Seq --> LLM[LLMCallNode<br/>è°ƒç”¨LLM API]
    LLM --> Read1[è¯»å– chatHistory]
    LLM --> Read2[è¯»å– llmSettings]
    Read1 --> LLM
    Read2 --> LLM
    LLM --> Call[è°ƒç”¨ Kimi/Gemini API<br/>è§£æç”¨æˆ·æ„å›¾]
    Call --> Parse[è§£æLLMå“åº”<br/>æå–å‡½æ•°è°ƒç”¨]
    
    Parse --> Exec[FunctionExecNode<br/>æ‰§è¡Œç»“æœ]
    Exec --> Convert[è½¬æ¢ä¸ºåŠ¨ä½œåºåˆ—]
    Convert --> Write1[å†™å…¥ pendingActions]
    Convert --> Write2[å†™å…¥ pendingEmotion]
    Write1 --> Success[è¿”å› SUCCESS]
    Write2 --> Success
    
    classDef guard fill:#ffcccc,stroke:#333,stroke-width:2px
    classDef llm fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef action fill:#ccccff,stroke:#333,stroke-width:2px
    classDef blackboard fill:#ffffcc,stroke:#333,stroke-width:2px
    
    class G1 guard
    class LLM,Call,Parse llm
    class Exec,Convert action
    class Read1,Read2,Write1,Write2 blackboard
```

#### 7.1.5 EmotionBT æƒ…ç»ªæ ‘è¯¦ç»†ç»“æ„

```mermaid
graph TD
    Root[EmotionBT Root<br/>10fpsæ‰§è¡Œ]
    Root --> Priority[Priority ä¼˜å…ˆçº§èŠ‚ç‚¹<br/>ä»å·¦åˆ°å³ä¾æ¬¡æ£€æŸ¥]
    
    Priority --> G1[æ£€æŸ¥ pendingEmotion<br/>æ˜¯å¦æœ‰å¾…æ‰§è¡Œè¡¨æƒ…?]
    G1 -->|æ˜¯| Play[PlayExpressionAction<br/>æ‰§è¡ŒLLMè¡¨æƒ…æŒ‡ä»¤]
    Play --> Read[è¯»å– pendingEmotion]
    Read --> Apply[åº”ç”¨è¡¨æƒ…æ•ˆæœ<br/>duration 3ç§’]
    Apply --> Clear[æ¸…ç©º pendingEmotion]
    Clear --> Out[è¾“å‡º actionState]
    Out --> Success1[è¿”å› SUCCESS]
    
    G1 -->|å¦| Update[UpdateEmotionAction<br/>è‡ªåŠ¨æƒ…ç»ªæ›´æ–°]
    Update --> Check[æ£€æŸ¥å½“å‰çŠ¶æ€<br/>energy boredom]
    Check --> Rule[åº”ç”¨æƒ…ç»ªè§„åˆ™<br/>æ ¹æ®çŠ¶æ€è‡ªåŠ¨è°ƒæ•´]
    Rule --> Success2[è¿”å› SUCCESS]
    
    classDef guard fill:#ffcccc,stroke:#333,stroke-width:2px
    classDef action fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef output fill:#ccccff,stroke:#333,stroke-width:2px
    
    class G1 guard
    class Play,Read,Apply,Update,Check,Rule action
    class Out output
```

#### 7.1.6 BT Output è¡Œä¸ºæ ‘è¾“å‡ºè¯¦ç»†ç»“æ„

```mermaid
graph LR
    subgraph "è¡Œä¸ºæ ‘è¾“å‡ºç±»å‹"
        O1[actionState<br/>åŠ¨ä½œçŠ¶æ€å¯¹è±¡]
        O2[move_to<br/>ç§»åŠ¨æŒ‡ä»¤]
        O3[set_position<br/>ä½ç½®åŒæ­¥]
        O4[chat<br/>å¯¹è¯æ¶ˆæ¯]
    end
    
    subgraph "actionState ç»“æ„"
        AS1[name: åŠ¨ä½œåç§°<br/>idle walk run jump waveç­‰]
        AS2[priority: ä¼˜å…ˆçº§<br/>0-100 æ•°å­—]
        AS3[duration: æŒç»­æ—¶é—´<br/>æ¯«ç§’æ•°]
        AS4[interruptible: å¯ä¸­æ–­<br/>å¸ƒå°”å€¼]
        AS5[timestamp: æ—¶é—´æˆ³<br/>æ¯«ç§’æ—¶é—´æˆ³]
        O1 --> AS1
        O1 --> AS2
        O1 --> AS3
        O1 --> AS4
        O1 --> AS5
    end
    
    subgraph "move_to ç»“æ„"
        MT1[target: ç›®æ ‡ä½ç½®<br/>xyzæ•°ç»„]
        O2 --> MT1
    end
    
    subgraph "set_position ç»“æ„"
        SP1[pos: ç›®æ ‡ä½ç½®<br/>xyzæ•°ç»„]
        O3 --> SP1
    end
    
    subgraph "chat ç»“æ„"
        CH1[text: å¯¹è¯æ–‡æœ¬<br/>å­—ç¬¦ä¸²]
        O4 --> CH1
    end
    
    subgraph "WebSocket å‘é€"
        WS[WebSocket Server<br/>å‘é€åˆ°å®¢æˆ·ç«¯]
        O1 --> WS
        O2 --> WS
        O3 --> WS
        O4 --> WS
    end
    
    classDef output fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef structure fill:#ffffcc,stroke:#333,stroke-width:2px
    classDef ws fill:#ccccff,stroke:#333,stroke-width:2px
    
    class O1,O2,O3,O4 output
    class AS1,AS2,AS3,AS4,AS5,MT1,SP1,CH1 structure
    class WS ws
```

#### 7.2.1 PetController æ§åˆ¶å™¨è¯¦ç»†ç»“æ„

```mermaid
graph TD
    Start[WebSocketæ¶ˆæ¯æ¥æ”¶]
    Start --> Parse[è§£ææ¶ˆæ¯ç±»å‹]
    
    Parse -->|bt_output| BT[å¤„ç†è¡Œä¸ºæ ‘è¾“å‡º]
    Parse -->|move_to| Move[å¤„ç†ç§»åŠ¨æŒ‡ä»¤]
    Parse -->|set_position| Pos[å¤„ç†ä½ç½®åŒæ­¥]
    
    BT --> State[åº”ç”¨åŠ¨ä½œçŠ¶æ€<br/>_apply_action_state]
    State --> Check[æ£€æŸ¥ä¼˜å…ˆçº§å’Œä¸­æ–­è§„åˆ™]
    Check -->|å¯ä¸­æ–­| Update[æ›´æ–° current_action_state]
    Check -->|ä¸å¯ä¸­æ–­| Skip[è·³è¿‡ ç­‰å¾…å½“å‰åŠ¨ä½œå®Œæˆ]
    Update --> Queue[æˆ–åŠ å…¥ action_queue]
    Queue --> Switch[åˆ‡æ¢åŠ¨ç”»çŠ¶æ€]
    
    Move --> SetTarget[è®¾ç½® target_position]
    SetTarget --> Flag[æ ‡è®° is_server_moving = true]
    
    Pos --> SetPos[è®¾ç½® server_target_pos]
    SetPos --> HighFreq[å¯ç”¨é«˜é¢‘åŒæ­¥<br/>use_high_freq_sync = true]
    
    subgraph "ä¼˜å…ˆçº§åˆ¤æ–­é€»è¾‘"
        Priority[ä¼˜å…ˆçº§åˆ¤æ–­<br/>æ‹–æ‹½ä¼˜å…ˆäºWASDä¼˜å…ˆäºæœåŠ¡ç«¯æŒ‡ä»¤]
        Priority -->|æœ€é«˜| DragCheck{is_dragging?}
        DragCheck -->|æ˜¯| DragHandle[_handle_dragging<br/>è·Ÿéšé¼ æ ‡]
        DragCheck -->|å¦| InputCheck{ç”¨æˆ·è¾“å…¥WASD?}
        InputCheck -->|æ˜¯| UserMove[ç”¨æˆ·æ§åˆ¶ç§»åŠ¨]
        InputCheck -->|å¦| ServerMove[æœåŠ¡ç«¯æŒ‡ä»¤ç§»åŠ¨]
    end
    
    subgraph "åŠ¨ä½œçŠ¶æ€ç®¡ç†"
        Current[current_action_state<br/>å½“å‰åŠ¨ä½œçŠ¶æ€å¯¹è±¡]
        Current --> Expire{åŠ¨ä½œæ˜¯å¦è¿‡æœŸ?}
        Expire -->|æ˜¯| Clear[æ¸…é™¤çŠ¶æ€]
        Expire -->|å¦| Keep[ä¿æŒçŠ¶æ€]
        Clear --> Next{åŠ¨ä½œé˜Ÿåˆ—æœ‰ä¸‹ä¸€ä¸ª?}
        Next -->|æ˜¯| Pop[å–å‡ºé˜Ÿåˆ—å¤´éƒ¨åŠ¨ä½œ]
        Next -->|å¦| Idle[åˆ‡æ¢åˆ°Idle]
    end
    
    subgraph "çŠ¶æ€ä¸ŠæŠ¥"
        Sync[å®šæ—¶åŒæ­¥ 1ç§’/æ¬¡]
        Sync --> Send[_send_state_sync]
        Send --> Data[å‘é€ position<br/>current_action<br/>is_dragging<br/>is_on_floor]
        
        Collision[ç¢°æ’æ£€æµ‹äº‹ä»¶]
        Collision --> CollSend[_send_interaction collision]
        CollSend --> CollData[å‘é€ collider_name<br/>position<br/>normal]
    end
    
    Switch --> Priority
    Flag --> Priority
    HighFreq --> Priority
    UserMove --> Current
    ServerMove --> Current
    
    classDef input fill:#ffcccc,stroke:#333,stroke-width:2px
    classDef process fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef priority fill:#ffffcc,stroke:#333,stroke-width:2px
    classDef state fill:#ccccff,stroke:#333,stroke-width:2px
    classDef output fill:#ffccff,stroke:#333,stroke-width:2px
    
    class Start,Parse,BT,Move,Pos input
    class State,Check,Update,SetTarget,SetPos process
    class Priority,DragCheck,InputCheck,DragHandle,UserMove,ServerMove priority
    class Current,Expire,Clear,Next,Pop,Queue state
    class Sync,Send,Collision,CollSend output
```

#### 7.2.2 AnimationTree çŠ¶æ€æœºè¯¦ç»†ç»“æ„

```mermaid
graph TD
    Root[AnimationTree<br/>çŠ¶æ€æœºæ ¹èŠ‚ç‚¹]
    Root --> SM[State Machine<br/>çŠ¶æ€æœºæ’­æ”¾å™¨]
    
    SM --> Idle[Idle é—²ç½®çŠ¶æ€]
    SM --> Walk[Walk èµ°è·¯çŠ¶æ€]
    SM --> Run[Run è·‘æ­¥çŠ¶æ€]
    SM --> Jump[Jump è·³è·ƒçŠ¶æ€]
    SM --> Wave[Wave æŒ¥æ‰‹çŠ¶æ€]
    
    Idle -->|ä»»æ„çŠ¶æ€å¯åˆ‡æ¢| T1[Transition è¿‡æ¸¡]
    Walk -->|ä»»æ„çŠ¶æ€å¯åˆ‡æ¢| T2[Transition è¿‡æ¸¡]
    Run -->|ä»»æ„çŠ¶æ€å¯åˆ‡æ¢| T3[Transition è¿‡æ¸¡]
    Jump -->|ä»»æ„çŠ¶æ€å¯åˆ‡æ¢| T4[Transition è¿‡æ¸¡]
    Wave -->|ä»»æ„çŠ¶æ€å¯åˆ‡æ¢| T5[Transition è¿‡æ¸¡]
    
    T1 --> Crossfade[Crossfade å¹³æ»‘æ·¡å…¥æ·¡å‡º<br/>è¿‡æ¸¡æ—¶é—´å¯é…ç½®]
    T2 --> Crossfade
    T3 --> Crossfade
    T4 --> Crossfade
    T5 --> Crossfade
    
    Crossfade --> SM
    
    subgraph "çŠ¶æ€åˆ‡æ¢æ¡ä»¶"
        Cond1[playback.travel state_name]
        Cond1 --> Idle
        Cond1 --> Walk
        Cond1 --> Run
        Cond1 --> Jump
        Cond1 --> Wave
    end
    
    subgraph "åŠ¨ç”»é©±åŠ¨"
        Drive[AnimationPlayer<br/>é©±åŠ¨éª¨éª¼åŠ¨ç”»]
        Idle --> Drive
        Walk --> Drive
        Run --> Drive
        Jump --> Drive
        Wave --> Drive
    end
    
    classDef state fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef transition fill:#ffffcc,stroke:#333,stroke-width:2px
    classDef control fill:#ccccff,stroke:#333,stroke-width:2px
    classDef animation fill:#ffccff,stroke:#333,stroke-width:2px
    
    class Idle,Walk,Run,Jump,Wave state
    class T1,T2,T3,T4,T5,Crossfade transition
    class Root,SM,Cond1 control
    class Drive animation
```

#### 7.2.3 éª¨éª¼åŠ¨ç”»ç³»ç»Ÿè¯¦ç»†ç»“æ„

```mermaid
graph TD
    subgraph "AnimationPlayer åŠ¨ç”»æ’­æ”¾å™¨"
        AP[AnimationPlayerèŠ‚ç‚¹<br/>ç®¡ç†æ‰€æœ‰åŠ¨ç”»èµ„æº]
    end
    
    subgraph "player.glb æ¨¡å‹æ–‡ä»¶"
        Model[GLBæ¨¡å‹æ–‡ä»¶<br/>åŒ…å«éª¨éª¼å’ŒåŠ¨ç”»]
        Model --> Skeleton[Skeleton éª¨éª¼ç³»ç»Ÿ<br/>éª¨éª¼å±‚çº§ç»“æ„]
        Model --> Anims[AnimationLibrary<br/>åŠ¨ç”»åº“]
    end
    
    Anims --> IdleAnim[Idle éª¨éª¼åŠ¨ç”»<br/>é—²ç½®åŠ¨ä½œå¾ªç¯]
    Anims --> WalkAnim[Walk éª¨éª¼åŠ¨ç”»<br/>èµ°è·¯åŠ¨ä½œå¾ªç¯]
    Anims --> RunAnim[Run éª¨éª¼åŠ¨ç”»<br/>è·‘æ­¥åŠ¨ä½œå¾ªç¯]
    Anims --> JumpAnim[Jump éª¨éª¼åŠ¨ç”»<br/>è·³è·ƒåŠ¨ä½œä¸€æ¬¡]
    Anims --> WaveAnim[Wave éª¨éª¼åŠ¨ç”»<br/>æŒ¥æ‰‹åŠ¨ä½œä¸€æ¬¡]
    
    AP --> IdleAnim
    AP --> WalkAnim
    AP --> RunAnim
    AP --> JumpAnim
    AP --> WaveAnim
    
    subgraph "åŠ¨ç”»å±æ€§"
        Props[åŠ¨ç”»å±æ€§]
        Props --> Loop[loop: æ˜¯å¦å¾ªç¯<br/>true false]
        Props --> Length[length: åŠ¨ç”»æ—¶é•¿<br/>ç§’æ•°]
        Props --> Tracks[Tracks: åŠ¨ç”»è½¨é“<br/>éª¨éª¼å˜æ¢è½¨é“]
    end
    
    IdleAnim --> Props
    WalkAnim --> Props
    RunAnim --> Props
    JumpAnim --> Props
    WaveAnim --> Props
    
    subgraph "é©±åŠ¨æµç¨‹"
        Drive[AnimationTreeçŠ¶æ€æœº<br/>è°ƒç”¨ playback.travel]
        Drive --> Select[é€‰æ‹©è¦æ’­æ”¾çš„åŠ¨ç”»]
        Select --> Play[AnimationPlayeræ’­æ”¾åŠ¨ç”»]
        Play --> Apply[åº”ç”¨åˆ°Skeletonéª¨éª¼]
        Apply --> Render[æ¸²æŸ“åˆ°å±å¹•]
    end
    
    AP --> Drive
    
    classDef model fill:#ffcccc,stroke:#333,stroke-width:2px
    classDef animation fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef property fill:#ffffcc,stroke:#333,stroke-width:2px
    classDef process fill:#ccccff,stroke:#333,stroke-width:2px
    
    class Model,Skeleton,Anims model
    class IdleAnim,WalkAnim,RunAnim,JumpAnim,WaveAnim,AP animation
    class Props,Loop,Length,Tracks property
    class Drive,Select,Play,Apply,Render process
```

#### 7.2.4 ç¨‹åºåŒ–åŠ¨ç”»ç³»ç»Ÿè¯¦ç»†ç»“æ„

```mermaid
graph TD
    subgraph "ç¨‹åºåŒ–åŠ¨ç”»ç³»ç»Ÿ"
        Root[_apply_procedural_fx<br/>æ¯å¸§è°ƒç”¨]
    end
    
    Root --> Check[æ£€æŸ¥ proc_anim_active]
    
    Check -->|spin| Spin[Spin è‡ªè½¬åŠ¨ç”»]
    Check -->|bounce| Bounce[Bounce å¼¹è·³åŠ¨ç”»]
    Check -->|fly| Fly[Fly æ‚¬æµ®é£è¡Œ]
    Check -->|roll| Roll[Roll ä¾§æ»š]
    Check -->|wave| Wave[Wave æŒ¥æ‰‹æ‘†åŠ¨]
    Check -->|ç©ºæˆ–idle| Idle[Idle å‘¼å¸æ„Ÿ]
    
    Spin --> Calc1[è®¡ç®—æ—‹è½¬<br/>proc_rot_y += delta * 20]
    Calc1 --> Apply1[åº”ç”¨ rotation.y<br/>ç›´æ¥èµ‹å€¼]
    
    Bounce --> Calc2[è®¡ç®—é«˜åº¦<br/>abs sin proc_time * 10 * 0.5]
    Calc2 --> Apply2[åº”ç”¨ position.y<br/>å¹³æ»‘æ’å€¼]
    
    Fly --> Calc3[è®¡ç®—é«˜åº¦<br/>1.0 + sin proc_time * 3 * 0.2]
    Calc3 --> Calc3a[è®¡ç®—å€¾æ–œ<br/>rotation.x = 0.3]
    Calc3 --> Apply3[åº”ç”¨ position.y<br/>å¹³æ»‘æ’å€¼]
    
    Roll --> Calc4[è®¡ç®—æ—‹è½¬<br/>rotation.z += delta * 15]
    Calc4 --> Apply4[åº”ç”¨ rotation.z<br/>æŒç»­ç´¯åŠ ]
    
    Wave --> Calc5[è®¡ç®—æ‘†åŠ¨<br/>sin proc_time * 15 * 0.15]
    Calc5 --> Apply5[åº”ç”¨ rotation.z<br/>å¹³æ»‘æ’å€¼]
    
    Idle --> Calc6[è®¡ç®—å‘¼å¸<br/>sin proc_time * 2 * 0.05]
    Calc6 --> Apply6[åº”ç”¨ position.y<br/>å¹³æ»‘æ’å€¼]
    
    Apply1 --> Mesh[åº”ç”¨åˆ° mesh_root<br/>æ¨¡å‹æ ¹èŠ‚ç‚¹]
    Apply2 --> Mesh
    Apply3 --> Mesh
    Apply3a[åº”ç”¨ rotation.x] --> Mesh
    Apply4 --> Mesh
    Apply5 --> Mesh
    Apply6 --> Mesh
    
    subgraph "æ‹–æ‹½æ—¶çš„ç‰¹æ®Šå¤„ç†"
        Drag[æ£€æŸ¥ is_dragging]
        Drag -->|æ˜¯| DragCalc[è®¡ç®—æ‘†åŠ¨<br/>sin proc_time * 10 * 0.2]
        DragCalc --> DragApply[åº”ç”¨ rotation.z<br/>è¦†ç›–å…¶ä»–æ—‹è½¬]
        DragApply --> Mesh
    end
    
    subgraph "å¹³æ»‘æ’å€¼å¤„ç†"
        Lerp[ä½¿ç”¨ lerp å‡½æ•°<br/>å¹³æ»‘è¿‡æ¸¡åˆ°ç›®æ ‡å€¼]
        Apply2 --> Lerp
        Apply3 --> Lerp
        Apply5 --> Lerp
        Apply6 --> Lerp
        Lerp --> Mesh
    end
    
    classDef animation fill:#ffccff,stroke:#333,stroke-width:2px
    classDef calc fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef apply fill:#ffffcc,stroke:#333,stroke-width:2px
    classDef mesh fill:#ccccff,stroke:#333,stroke-width:2px
    
    class Spin,Bounce,Fly,Roll,Wave,Idle,Drag animation
    class Calc1,Calc2,Calc3,Calc3a,Calc4,Calc5,Calc6,DragCalc calc
    class Apply1,Apply2,Apply3,Apply3a,Apply4,Apply5,Apply6,DragApply,Lerp apply
    class Mesh mesh
```

#### 7.2.5 ç‰©ç†å¼•æ“ç³»ç»Ÿè¯¦ç»†ç»“æ„

```mermaid
graph TD
    subgraph "CharacterBody3D ç‰©ç†ä½“"
        Body[CharacterBody3DèŠ‚ç‚¹<br/>è§’è‰²ç‰©ç†ä½“]
    end
    
    Body --> Physics[_physics_process<br/>æ¯å¸§è°ƒç”¨]
    
    Physics --> Gravity[é‡åŠ›å¤„ç†]
    Gravity --> CheckFloor{is_on_floor?}
    CheckFloor -->|æ˜¯| Ground[velocity.y = 0<br/>åœ¨åœ°é¢ä¸Š]
    CheckFloor -->|å¦| Fall[velocity.y -= gravity * delta<br/>ä¸‹è½]
    
    Ground --> Input[å¤„ç†è¾“å…¥]
    Fall --> Input
    
    Input --> UserInput{ç”¨æˆ·è¾“å…¥WASD?}
    UserInput -->|æ˜¯| CalcUser[è®¡ç®—ç”¨æˆ·ç§»åŠ¨æ–¹å‘<br/>Input.get_vector]
    UserInput -->|å¦| ServerInput{æœåŠ¡ç«¯ç§»åŠ¨?}
    
    ServerInput -->|æ˜¯| CalcServer[è®¡ç®—æœåŠ¡ç«¯ç§»åŠ¨æ–¹å‘<br/>target_position - position]
    ServerInput -->|å¦| HighFreq{é«˜é¢‘åŒæ­¥?}
    
    HighFreq -->|æ˜¯| Interp[æ’å€¼åŒæ­¥ä½ç½®<br/>lerp position server_target_pos]
    HighFreq -->|å¦| Decel[å‡é€Ÿåœæ­¢<br/>velocityå‡é€Ÿåˆ°0]
    
    CalcUser --> Speed1[è®¡ç®—é€Ÿåº¦<br/>walk_speed æˆ– run_speed]
    CalcServer --> Speed2[è®¡ç®—é€Ÿåº¦<br/>walk_speed]
    Speed1 --> Velocity[è®¾ç½® velocity.xz]
    Speed2 --> Velocity
    Velocity --> Rotation[è®¡ç®—æœå‘<br/>å¹³æ»‘è½¬å‘ç›®æ ‡æ–¹å‘]
    
    subgraph "è·³è·ƒå¤„ç†"
        JumpCheck{åœ¨åœ°é¢ä¸”æŒ‰Space?}
        JumpCheck -->|æ˜¯| Jump[velocity.y = jump_velocity]
        Jump --> Velocity
    end
    
    Input --> JumpCheck
    
    Velocity --> Move[move_and_slide<br/>ç§»åŠ¨å¹¶æ£€æµ‹ç¢°æ’]
    Rotation --> Move
    
    Move --> Collision[ç¢°æ’æ£€æµ‹]
    Collision --> Count{get_slide_collision_count > 0?}
    Count -->|æ˜¯| Process[å¤„ç†ç¢°æ’ä¿¡æ¯]
    Count -->|å¦| Continue[ç»§ç»­ä¸‹ä¸€å¸§]
    
    Process --> Report[ä¸ŠæŠ¥ç¢°æ’äº‹ä»¶<br/>_send_interaction]
    Report --> Continue
    
    Interp --> Continue
    Decel --> Continue
    
    classDef physics fill:#ccffff,stroke:#333,stroke-width:2px
    classDef input fill:#ffcc99,stroke:#333,stroke-width:2px
    classDef calc fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef output fill:#ffcccc,stroke:#333,stroke-width:2px
    
    class Body,Physics,Gravity,Ground,Fall,Move,Collision physics
    class UserInput,ServerInput,HighFreq,JumpCheck input
    class CalcUser,CalcServer,Speed1,Speed2,Velocity,Rotation,Interp,Decel calc
    class Report,Continue output
```

#### 7.2.6 ç”¨æˆ·è¾“å…¥ç³»ç»Ÿè¯¦ç»†ç»“æ„

```mermaid
graph TD
    subgraph "é”®ç›˜è¾“å…¥ Keyboard Input"
        WASD[WASD ç§»åŠ¨è¾“å…¥<br/>Input.get_vector]
        Shift[Shift è·‘æ­¥é”®<br/>Input.is_key_pressed KEY_SHIFT]
        Space[Space è·³è·ƒé”®<br/>Input.is_action_just_pressed jump]
    end
    
    subgraph "é¼ æ ‡è¾“å…¥ Mouse Input"
        Mouse[_input_event<br/>é¼ æ ‡äº‹ä»¶å¤„ç†]
        Mouse --> ClickCheck{InputEventMouseButton?}
        ClickCheck -->|æ˜¯| Press{button_index == LEFT<br/>pressed == true?}
        Press -->|æ˜¯| StartClick[è®°å½•ç‚¹å‡»å¼€å§‹æ—¶é—´<br/>click_start_time]
        Press -->|å¦| Release{button_index == LEFT<br/>pressed == false?}
        Release -->|æ˜¯| CheckDuration{duration < max_click_duration<br/>mouse_move < drag_threshold?}
        CheckDuration -->|æ˜¯| Click[ç¡®è®¤ä¸ºå•å‡»<br/>_on_clicked]
        CheckDuration -->|å¦| DragEnd[ç¡®è®¤ä¸ºæ‹–æ‹½ç»“æŸ<br/>_on_drag_finished]
        
        ClickCheck -->|å¦| Motion{InputEventMouseMotion?}
        Motion -->|æ˜¯| CheckMove{mouse_move > drag_threshold?}
        CheckMove -->|æ˜¯| DragStart[ç¡®è®¤ä¸ºæ‹–æ‹½å¼€å§‹<br/>is_dragging = true]
    end
    
    subgraph "è¾“å…¥å¤„ç†æµç¨‹"
        Process[æ¯å¸§å¤„ç†è¾“å…¥]
        Process --> WASD
        Process --> Shift
        Process --> Space
        Process --> Mouse
    end
    
    subgraph "è¾“å…¥å“åº”"
        WASD --> Calc[è®¡ç®—ç§»åŠ¨æ–¹å‘<br/>è€ƒè™‘æ‘„åƒæœºæ–¹å‘]
        Shift --> Speed[è®¾ç½®è·‘æ­¥é€Ÿåº¦<br/>run_speed]
        Space --> Jump[è§¦å‘è·³è·ƒ<br/>velocity.y = jump_velocity]
        Click --> ClickEvent[å‘é€ç‚¹å‡»äº‹ä»¶<br/>_send_interaction click]
        DragStart --> DragEvent[å‘é€æ‹–æ‹½å¼€å§‹<br/>_send_interaction drag_start]
        DragEnd --> DragEvent2[å‘é€æ‹–æ‹½ç»“æŸ<br/>_send_interaction drag_end]
    end
    
    Calc --> Controller[PetControllerå¤„ç†]
    Speed --> Controller
    Jump --> Controller
    ClickEvent --> Controller
    DragEvent --> Controller
    DragEvent2 --> Controller
    
    classDef keyboard fill:#ffcc99,stroke:#333,stroke-width:2px
    classDef mouse fill:#ffffcc,stroke:#333,stroke-width:2px
    classDef process fill:#ccffcc,stroke:#333,stroke-width:2px
    classDef output fill:#ccccff,stroke:#333,stroke-width:2px
    
    class WASD,Shift,Space keyboard
    class Mouse,ClickCheck,Press,Release,Motion,CheckMove,DragStart,DragEnd mouse
    class Process,Calc,Speed,Jump,Click,ClickEvent,DragEvent,DragEvent2 process
    class Controller output
```

### è¯¦ç»†æ¶æ„è¯´æ˜ï¼š

#### 7.1 æœåŠ¡ç«¯è¡Œä¸ºæ ‘ç³»ç»Ÿç»“æ„

**MainBTï¼ˆä¸»è¡Œä¸ºæ ‘ï¼Œ60fpsæ‰§è¡Œï¼‰**ï¼š
- **ParallelèŠ‚ç‚¹**ï¼šå¹¶è¡Œæ‰§è¡ŒçŠ¶æ€æ›´æ–°å’Œä¼˜å…ˆçº§å†³ç­–
  - **UpdateInternalStatesAction**ï¼šæ¯å¸§æ›´æ–°èƒ½é‡ï¼ˆenergyï¼‰å’Œæ— èŠåº¦ï¼ˆboredomï¼‰
  - **PriorityèŠ‚ç‚¹**ï¼šæŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ£€æŸ¥ä»¥ä¸‹æ¡ä»¶ï¼š
    1. **æ‹–æ‹½ä¸­æ–­**ï¼š`isDragging = true` â†’ `FollowPointerNode` è·Ÿéšé¼ æ ‡
    2. **ç¢°æ’å¤„ç†**ï¼šæ£€æµ‹åˆ°ç¢°æ’ â†’ `PushPendingAction(BOUNCE)` + æ¸…ç†ç¢°æ’æ ‡è®°
    3. **è¾¹ç•Œæ£€æŸ¥**ï¼šä½ç½®è¶…å‡ºå®‰å…¨åŒº â†’ `PushPendingAction(SURPRISE)` + `MoveToTargetAction` å›å½’
    4. **æ‰§è¡ŒåŠ¨ä½œåºåˆ—**ï¼š`ExecuteActionSequence` æ‰§è¡Œå¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„åŠ¨ä½œ
    5. **ç¡çœ é€»è¾‘**ï¼šèƒ½é‡ < 20 â†’ èµ°å‘å®¶ â†’ `SLEEP` â†’ é†’æ¥ â†’ å›ä¸­å¿ƒ
    6. **è‡ªåŠ¨å½’ä½**ï¼š`ReturnToOriginAction` å›å½’èˆå°ä¸­å¿ƒ
    7. **ç‚¹å‡»äº¤äº’**ï¼š`isClicked = true` â†’ `WAVE` â†’ `IDLE`
    8. **é»˜è®¤é—²ç½®**ï¼š`PlayAnimationAction(IDLE)`

**ActiveServiceBTï¼ˆä¸»åŠ¨æœåŠ¡æ ‘ï¼Œæ¯2ç§’æ‰§è¡Œï¼‰**ï¼š
- å½“æ— èŠåº¦ > 70 ä¸”èƒ½é‡ > 30 æ—¶ï¼Œæ‰§è¡Œè‡ªä¸»è¡Œä¸ºåºåˆ—ï¼š
  - `WAVE` â†’ ç­‰å¾…10ç§’ â†’ `THINK` â†’ ç­‰å¾…8ç§’ â†’ `LOOK_LEFT` â†’ `LOOK_RIGHT` â†’ ç­‰å¾…15ç§’

**IntentBTï¼ˆæ„å›¾ç†è§£æ ‘ï¼ŒæŒ‰éœ€æ‰§è¡Œï¼‰**ï¼š
- å½“ `hasNewInput = true` æ—¶è§¦å‘ï¼š
  - `LLMCallNode`ï¼šè°ƒç”¨ LLMï¼ˆKimi/Geminiï¼‰è§£æç”¨æˆ·æ„å›¾
  - `FunctionExecNode`ï¼šå°† LLM è¿”å›çš„å‡½æ•°è°ƒç”¨è½¬æ¢ä¸ºåŠ¨ä½œåºåˆ—ï¼Œå†™å…¥ `pendingActions`

**EmotionBTï¼ˆæƒ…ç»ªæ ‘ï¼Œ10fpsæ‰§è¡Œï¼‰**ï¼š
- **PriorityèŠ‚ç‚¹**ï¼šä¼˜å…ˆæ‰§è¡Œ LLM è¡¨æƒ…æŒ‡ä»¤ï¼Œå¦åˆ™è‡ªåŠ¨æ›´æ–°æƒ…ç»ª

#### 7.2 é»‘æ¿ç³»ç»Ÿï¼ˆBlackboardï¼‰æ•°æ®

- **energy**ï¼šèƒ½é‡å€¼ï¼ˆ0-100ï¼‰
- **boredom**ï¼šæ— èŠåº¦ï¼ˆ0-100ï¼‰
- **penguinPosition**ï¼šå½“å‰ä½ç½® [x, y, z]
- **lastCollision**ï¼šæœ€åç¢°æ’ä¿¡æ¯ {collider_name, position, normal, timestamp}
- **isDragging**ï¼šæ˜¯å¦æ­£åœ¨æ‹–æ‹½
- **hasNewInput**ï¼šæ˜¯å¦æœ‰æ–°è¾“å…¥éœ€è¦å¤„ç†
- **chatHistory**ï¼šå¯¹è¯å†å²è®°å½•
- **llmSettings**ï¼šLLM é…ç½®ï¼ˆprovider, apiKey, baseUrl, modelNameï¼‰
- **pendingActions**ï¼šå¾…æ‰§è¡ŒåŠ¨ä½œé˜Ÿåˆ—
- **pendingEmotion**ï¼šå¾…æ‰§è¡Œè¡¨æƒ…

#### 7.3 å®¢æˆ·ç«¯çŠ¶æ€æœºç³»ç»Ÿç»“æ„

**PetControllerï¼ˆæ§åˆ¶å™¨ï¼‰**ï¼š
- **æ¶ˆæ¯æ¥æ”¶å¤„ç†**ï¼šæ¥æ”¶ `bt_output`ã€`move_to`ã€`set_position` æ¶ˆæ¯
- **ä¼˜å…ˆçº§åˆ¤æ–­**ï¼šæ‹–æ‹½ > WASD > æœåŠ¡ç«¯æŒ‡ä»¤
- **åŠ¨ä½œçŠ¶æ€ç®¡ç†**ï¼š`current_action_state` åŒ…å« {name, priority, duration, start_time, interruptible}
- **åŠ¨ä½œé˜Ÿåˆ—**ï¼š`action_queue` å­˜å‚¨å¾…æ‰§è¡Œçš„åŠ¨ä½œåºåˆ—
- **æ‹–æ‹½å¤„ç†**ï¼š`_handle_dragging` è·Ÿéšé¼ æ ‡ä½ç½®ï¼Œæ’­æ”¾ Jump åŠ¨ç”»
- **ç¢°æ’æ£€æµ‹ä¸ŠæŠ¥**ï¼šæ£€æµ‹åˆ°ç¢°æ’æ—¶å‘é€ `collision` æ¶ˆæ¯
- **çŠ¶æ€åŒæ­¥ä¸ŠæŠ¥**ï¼šæ¯ç§’å‘é€ä½ç½®ã€å½“å‰åŠ¨ä½œã€æ‹–æ‹½çŠ¶æ€

**AnimationTreeï¼ˆçŠ¶æ€æœºï¼‰**ï¼š
- **çŠ¶æ€èŠ‚ç‚¹**ï¼šIdleã€Walkã€Runã€Jumpã€Wave
- **è¿‡æ¸¡èŠ‚ç‚¹**ï¼šä½¿ç”¨ Crossfade å®ç°å¹³æ»‘è¿‡æ¸¡

**éª¨éª¼åŠ¨ç”»ï¼ˆSkeletal Animationï¼‰**ï¼š
- ä» `.glb` æ¨¡å‹å¯¼å‡ºçš„é¢„åˆ¶åŠ¨ç”»åºåˆ—
- é€šè¿‡ AnimationPlayer é©±åŠ¨éª¨éª¼ç³»ç»Ÿ

**ç¨‹åºåŒ–åŠ¨ç”»ï¼ˆProcedural Animationï¼‰**ï¼š
- **Spin**ï¼š`rotation.y += delta * 20`ï¼ˆæŒç»­ç´¯åŠ æ—‹è½¬ï¼‰
- **Bounce**ï¼š`position.y = abs(sin(time * 10)) * 0.5`ï¼ˆå¼¹è·³æ•ˆæœï¼‰
- **Fly**ï¼š`position.y = 1.0 + sin(time * 3) * 0.2`ï¼ˆæ‚¬æµ®é£è¡Œï¼‰
- **Roll**ï¼š`rotation.z += delta * 15`ï¼ˆä¾§æ»šï¼‰
- **å‘¼å¸æ„Ÿ**ï¼šIdle æ—¶ `position.y = sin(time * 2) * 0.05`

**ç‰©ç†å¼•æ“ï¼ˆPhysics Engineï¼‰**ï¼š
- **CharacterBody3D**ï¼šè§’è‰²ç‰©ç†ä½“
- **é‡åŠ›å¤„ç†**ï¼šåœ°é¢æ£€æµ‹å’Œåº”ç”¨é‡åŠ›
- **é€Ÿåº¦è®¡ç®—**ï¼šæ ¹æ®è¾“å…¥å’ŒæœåŠ¡ç«¯æŒ‡ä»¤è®¡ç®—é€Ÿåº¦
- **ç¢°æ’æ£€æµ‹**ï¼šæ£€æµ‹ä¸ç¯å¢ƒçš„ç¢°æ’
- **ç§»åŠ¨åŒæ­¥**ï¼š`move_and_slide` å¤„ç†ç§»åŠ¨å’Œç¢°æ’

#### 7.4 æ•°æ®æµå‘

1. **æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯**ï¼š
   - `actionState` â†’ `PetController._apply_action_state` â†’ `AnimationTree` æˆ–ç¨‹åºåŒ–åŠ¨ç”»
   - `move_to` â†’ `target_position` â†’ ç‰©ç†å¼•æ“ç§»åŠ¨
   - `set_position` â†’ `server_target_pos` â†’ é«˜é¢‘æ’å€¼åŒæ­¥

2. **å®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯**ï¼š
   - `state_sync`ï¼ˆæ¯ç§’ï¼‰â†’ æ›´æ–° `penguinPosition`ã€`isDragging`
   - `collision`ï¼ˆäº‹ä»¶è§¦å‘ï¼‰â†’ æ›´æ–° `lastCollision`
   - `click`ï¼ˆç”¨æˆ·ç‚¹å‡»ï¼‰â†’ è§¦å‘ç‚¹å‡»äº¤äº’
   - `drag_start/end`ï¼ˆç”¨æˆ·æ‹–æ‹½ï¼‰â†’ æ›´æ–° `isDragging`

3. **è¡Œä¸ºæ ‘ â†’ é»‘æ¿ â†’ è¡Œä¸ºæ ‘**ï¼š
   - `MainBT` è¯»å– `isDragging`ã€`lastCollision`ã€`penguinPosition`
   - `ActiveServiceBT` è¯»å– `boredom`ã€`energy`
   - `IntentBT` è¯»å– `hasNewInput`ã€`chatHistory`
   - æ‰€æœ‰è¡Œä¸ºæ ‘å†™å…¥ `pendingActions`ã€`pendingEmotion`
